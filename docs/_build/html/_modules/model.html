

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>model &mdash; CSLVR  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> CSLVR
          

          
          </a>

          
            
            
              <div class="version">
                2017
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Preliminaries</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get_started.html">Hello CSLVR</a></li>
</ul>
<p class="caption"><span class="caption-text">Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../input.html">Input</a></li>
<li class="toctree-l1"><a class="reference internal" href="../output.html">Output</a></li>
</ul>
<p class="caption"><span class="caption-text">Mesh generation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../meshing.html">Meshing</a></li>
</ul>
<p class="caption"><span class="caption-text">Base Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../model.html">The Model classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics.html">The Physics classes</a></li>
</ul>
<p class="caption"><span class="caption-text">Balance equations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../momentum.html">Momentum balance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mass.html">Mass balance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy.html">Energy balance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../velocity.html">Velocity balance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stress.html">Stress balance</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CSLVR</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for model</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">dolfin</span>               <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">dolfin_adjoint</span>       <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">copy</span>                 <span class="k">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">scipy.io</span>             <span class="k">import</span> <span class="n">savemat</span>
<span class="kn">from</span> <span class="nn">ufl</span>                  <span class="k">import</span> <span class="n">indexed</span>
<span class="kn">from</span> <span class="nn">cslvr.inputoutput</span>    <span class="k">import</span> <span class="n">print_text</span><span class="p">,</span> <span class="n">get_text</span><span class="p">,</span> <span class="n">print_min_max</span>
<span class="kn">import</span> <span class="nn">numpy</span>              <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span>  <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>         <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">json</span>




<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../output.html#model.Model">[docs]</a><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  The basic model from which each of these inherit :</span>

<span class="sd">   * :class:`~latmodel.LatModel`       - plane strain model</span>
<span class="sd">   * :class:`~d1model.D1Model`         - 1D firn model</span>
<span class="sd">   * :class:`~d2model.D2Model`         - 2D model (SSA, SIA, balance velocity)</span>
<span class="sd">   * :class:`~d3model.D3Model`         - 3D model (first-order, full-Stokes)</span>

<span class="sd">  :param mesh:         the finite-element mesh</span>
<span class="sd">  :param out_dir:      location for the output directory</span>
<span class="sd">  :param order:        order of the shape function basis, default linear</span>
<span class="sd">  :param use_periodic: use periodic boundaries or not</span>
<span class="sd">  :type mesh:          :class:`~dolfin.Mesh`</span>
<span class="sd">  :type out_dir:       string</span>
<span class="sd">  :type order:         int</span>
<span class="sd">  :type use_periodic:  bool</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="s1">&#39;./results/&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">use_periodic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create and instance of the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">this</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>  <span class="c1"># pointer to this base class</span>

    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: INITIALIZING BASE MODEL :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

    <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;std_out_all_processes&quot;</span><span class="p">]</span>               <span class="o">=</span> <span class="kc">False</span>
    <span class="c1">#parameters[&#39;form_compiler&#39;][&#39;optimize&#39;]           = True</span>
    <span class="c1">#parameters[&#39;form_compiler&#39;][&#39;cpp_optimize&#39;]       = True</span>
    <span class="c1">#parameters[&#39;form_compiler&#39;][&#39;cpp_optimize_flags&#39;] = &quot;-O3&quot;</span>
    <span class="c1">#parameters[&quot;form_compiler&quot;][&quot;representation&quot;]     = &#39;uflacs&#39;</span>
    <span class="c1">#PETScOptions.set(&quot;mat_mumps_icntl_14&quot;, 100.0)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">order</span>        <span class="o">=</span> <span class="n">order</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span>      <span class="o">=</span> <span class="n">out_dir</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">MPI_rank</span>     <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">mpi_comm_world</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_periodic</span> <span class="o">=</span> <span class="n">use_periodic</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pBC</span>          <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># this will hold constrained domains if periodic</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">generate_constants</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">generate_function_spaces</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">initialize_variables</span><span class="p">()</span>

<div class="viewcode-block" id="Model.color"><a class="viewcode-back" href="../model.html#model.Model.color">[docs]</a>  <span class="k">def</span> <span class="nf">color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The color used for printing messages to the screen.</span>

<span class="sd">    :rtype: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;148&#39;</span></div>

<div class="viewcode-block" id="Model.linear_solve_params"><a class="viewcode-back" href="../model.html#model.Model.linear_solve_params">[docs]</a>  <span class="k">def</span> <span class="nf">linear_solve_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a set of linear solver parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#lparams  = {&quot;linear_solver&quot;            : &quot;default&quot;}</span>
    <span class="c1">#lparams  = {&quot;linear_solver&quot;            : &quot;superlu_dist&quot;}</span>
    <span class="n">lparams</span>  <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;linear_solver&quot;</span>            <span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">}</span>
    <span class="c1">#lparams  = {&quot;linear_solver&quot;            : &quot;umfpack&quot;}</span>
    <span class="c1">#lparams  = {&quot;linear_solver&quot;            : &quot;cg&quot;,</span>
    <span class="c1">#            &quot;preconditioner&quot;           : &quot;default&quot;}</span>
    <span class="k">return</span> <span class="n">lparams</span></div>

<div class="viewcode-block" id="Model.nonlinear_solve_params"><a class="viewcode-back" href="../model.html#model.Model.nonlinear_solve_params">[docs]</a>  <span class="k">def</span> <span class="nf">nonlinear_solve_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a set of linear and nonlinear solver parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nparams</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;newton_solver&#39;</span> <span class="p">:</span>
              <span class="p">{</span>
                <span class="s1">&#39;linear_solver&#39;</span>            <span class="p">:</span> <span class="s1">&#39;cg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;preconditioner&#39;</span>           <span class="p">:</span> <span class="s1">&#39;hypre_amg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;relative_tolerance&#39;</span>       <span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span>
                <span class="s1">&#39;relaxation_parameter&#39;</span>     <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s1">&#39;maximum_iterations&#39;</span>       <span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
                <span class="s1">&#39;error_on_nonconvergence&#39;</span>  <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
              <span class="p">}}</span>
    <span class="k">return</span> <span class="n">nparams</span></div>

<div class="viewcode-block" id="Model.generate_constants"><a class="viewcode-back" href="../model.html#model.Model.generate_constants">[docs]</a>  <span class="k">def</span> <span class="nf">generate_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes important constants, including :</span>

<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | name of constant | value         | description                      |</span>
<span class="sd">    +==================+===============+==================================+</span>
<span class="sd">    | ``self.kcLw``    | 9.2e-9        | creep coefficient low            |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.kg``      | 1.3e-7        | grain growth coefficient         |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.Ec``      | 6e4           | act. energy for water in ice     |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.Eg``      | 42.4e3        | act. energy for grain growth     |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.etaw``    | 1.787e-3      | viscosity of water at Tw         |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.eps_reg`` | 1e-15         | strain-rate reg. parameter       |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.n``       | 3.0           | Glen&#39;s flow exponent             |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.spy``     | 31556926.0    | seconds per year                 |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.rhoi``    | 910.0         | ice density                      |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.rhow``    | 1000.0        | water density                    |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.rhosw``   | 1028.0        | sea-water density                |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.rhom``    | 550.0         | firn pore-close-off density      |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.rhoc``    | 815.0         | firn density critical value      |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.g``       | 9.80665       | gravitational acceleration       |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.a0``      | 5.45e10       | ice hardness limit               |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.Q0``      | 13.9e4        | ice activation energy            |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.R``       | 8.3144621     | universal gas constant           |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.ki``      | 2.1           | thermal conductivity of ice      |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.kw``      | 0.561         | thermal conductivity of water    |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.ci``      | 2009.0        | heat capacity of ice             |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.cw``      | 4217.6        | Heat capacity of water at Tw     |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.L``       | 3.3355e5      | latent heat of ice               |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.ghf``     | 0.042 * spy   | geothermal heat flux             |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.gamma``   | 9.8e-8        | pressure melt. p&#39;t depth dep.    |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.nu``      | 3.5e3         | moisture diffusivity             |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.T_w``     | 273.15        | Triple point of water            |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.a_T_l``   | 3.985e-13*spy | lower bound of flow-rate const.  |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.a_T_u``   | 1.916e3*spy   | upper bound of flow-rate const.  |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.Q_T_l``   | 6e4           | lower bound of ice act. energy   |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    | ``self.Q_T_u``   | 13.9e4        | upper bound of ice act. energy   |</span>
<span class="sd">    +------------------+---------------+----------------------------------+</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: generating constants :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

    <span class="n">spy</span> <span class="o">=</span> <span class="mf">31556926.0</span>
    <span class="n">ghf</span> <span class="o">=</span> <span class="mf">0.042</span> <span class="o">*</span> <span class="n">spy</span>  <span class="c1"># W/m^2 = J/(s*m^2) = spy * J/(a*m^2)</span>

    <span class="c1"># Constants :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kcHh</span>    <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">3.7e-9</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kcHh</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;kcHh&#39;</span><span class="p">,</span> <span class="s1">&#39;creep coefficient high&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">kcLw</span>    <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">9.2e-9</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kcLw</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;kcLw&#39;</span><span class="p">,</span> <span class="s1">&#39;creep coefficient low &#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">kg</span>      <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.3e-7</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kg</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;kg&#39;</span><span class="p">,</span> <span class="s1">&#39;grain growth coefficient&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">Ec</span>      <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">6e4</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Ec</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Ec&#39;</span><span class="p">,</span> <span class="s1">&#39;act. energy for water in ice&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">Eg</span>      <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">42.4e3</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Eg</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Eg&#39;</span><span class="p">,</span> <span class="s1">&#39;act. energy for grain growth&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">etaw</span>    <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.787e-3</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">etaw</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;etaw&#39;</span><span class="p">,</span> <span class="s1">&#39;Dynamic viscosity of water at Tw&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">eps_reg</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1e-15</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">eps_reg</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;eps_reg&#39;</span><span class="p">,</span> <span class="s1">&#39;strain rate regularization parameter&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">n</span>       <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s2">&quot;Glen&#39;s flow exponent&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">spy</span>     <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">spy</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spy</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span> <span class="s1">&#39;seconds per year&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">rhoi</span>    <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">910.0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rhoi</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;rhoi&#39;</span><span class="p">,</span> <span class="s1">&#39;ice density&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">rhow</span>    <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1000.0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rhow</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;rhow&#39;</span><span class="p">,</span> <span class="s1">&#39;water density&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">rhosw</span>   <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1028.0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rhosw</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;rhosw&#39;</span><span class="p">,</span> <span class="s1">&#39;sea-water density&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">rhom</span>    <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">550.0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rhom</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;rhom&#39;</span><span class="p">,</span> <span class="s1">&#39;firn pore close-off density&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">rhoc</span>    <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">815.0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rhoc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;rhoc&#39;</span><span class="p">,</span> <span class="s1">&#39;firn density critical value&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">g</span>       <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">9.80665</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;gravitational acceleration&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">a0</span>      <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">5.45e10</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">a0</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;a0&#39;</span><span class="p">,</span> <span class="s1">&#39;ice hardness limit&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">Q0</span>      <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">13.9e4</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Q0</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Q0&#39;</span><span class="p">,</span> <span class="s1">&#39;ice activation energy&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">R</span>       <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">8.3144621</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;universal gas constant&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ki</span>      <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">2.1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ki</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;ki&#39;</span><span class="p">,</span> <span class="s1">&#39;thermal conductivity of ice&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">kw</span>      <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.561</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;kw&#39;</span><span class="p">,</span> <span class="s1">&#39;thermal conductivity of water&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ci</span>      <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">2009.0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ci</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;ci&#39;</span><span class="p">,</span> <span class="s1">&#39;heat capacity of ice&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">cw</span>      <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">4217.6</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cw</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;cw&#39;</span><span class="p">,</span> <span class="s1">&#39;Heat capacity of water at Tw&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">L</span>       <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">3.3355e5</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;latent heat of ice&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ghf</span>     <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">ghf</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ghf</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;ghf&#39;</span><span class="p">,</span> <span class="s1">&#39;geothermal heat flux&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span>   <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">9.8e-8</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;pressure melting point depth dependence&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nu</span>      <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">3.5e3</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nu</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;nu&#39;</span><span class="p">,</span> <span class="s1">&#39;moisture diffusivity&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">T_w</span>     <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">273.15</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">T_w</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;T_w&#39;</span><span class="p">,</span> <span class="s1">&#39;Triple point of water&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">a_T_l</span>   <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">3.985e-13</span><span class="o">*</span><span class="n">spy</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">a_T_l</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;a_T_l&#39;</span><span class="p">,</span> <span class="s1">&#39;lower bound of flow-rate constant&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">a_T_u</span>   <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.916e3</span><span class="o">*</span><span class="n">spy</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">a_T_u</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;a_T_u&#39;</span><span class="p">,</span> <span class="s1">&#39;upper bound of flow-rate constant&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">Q_T_l</span>   <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">6e4</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Q_T_l</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Q_T_l&#39;</span><span class="p">,</span> <span class="s1">&#39;lower bound of ice activation energy&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">Q_T_u</span>   <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">13.9e4</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Q_T_u</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Q_T_u&#39;</span><span class="p">,</span> <span class="s1">&#39;upper bound of ice activation energy&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.set_subdomains"><a class="viewcode-back" href="../model.html#model.Model.set_subdomains">[docs]</a>  <span class="k">def</span> <span class="nf">set_subdomains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the facet subdomains FacetFunction self.ff, cell subdomains</span>
<span class="sd">    CellFunction self.cf, and accumulation FacetFunction self.ff_acc from</span>
<span class="sd">    MeshFunctions saved in an .h5 file &lt;f&gt;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: setting subdomains :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ff</span>     <span class="o">=</span> <span class="n">MeshFunction</span><span class="p">(</span><span class="s1">&#39;size_t&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cf</span>     <span class="o">=</span> <span class="n">MeshFunction</span><span class="p">(</span><span class="s1">&#39;size_t&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ff_acc</span> <span class="o">=</span> <span class="n">MeshFunction</span><span class="p">(</span><span class="s1">&#39;size_t&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="p">,</span>     <span class="s1">&#39;ff&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cf</span><span class="p">,</span>     <span class="s1">&#39;cf&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ff_acc</span><span class="p">,</span> <span class="s1">&#39;ff_acc&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">set_measures</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.generate_pbc"><a class="viewcode-back" href="../model.html#model.Model.generate_pbc">[docs]</a>  <span class="k">def</span> <span class="nf">generate_pbc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    return a :class:`dolfin.SubDomain` of periodic lateral boundaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raiseNotDefined</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.set_mesh"><a class="viewcode-back" href="../model.html#model.Model.set_mesh">[docs]</a>  <span class="k">def</span> <span class="nf">set_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the ``mesh`` instance to ``f``, either a :class:`dolfin.Mesh` or  ``.h5``</span>
<span class="sd">    file with a mesh saved with name ``mesh``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: setting mesh :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">cpp</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">HDF5File</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">Mesh</span><span class="p">()</span>
      <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;mesh&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">cpp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">Mesh</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">f</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">dim</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">()</span><span class="o">.</span><span class="n">topological_dimension</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.calculate_boundaries"><a class="viewcode-back" href="../model.html#model.Model.calculate_boundaries">[docs]</a>  <span class="k">def</span> <span class="nf">calculate_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines the boundaries of the current ``self.mesh``.</span>

<span class="sd">    External boundaries :</span>

<span class="sd">    * ``self.GAMMA_S_GND`` -- grounded upper surface</span>
<span class="sd">    * ``self.GAMMA_B_GND`` -- grounded lower surface (bedrock)</span>
<span class="sd">    * ``self.GAMMA_S_FLT`` -- shelf upper surface</span>
<span class="sd">    * ``self.GAMMA_B_FLT`` -- shelf lower surface</span>
<span class="sd">    * ``self.GAMMA_L_DVD`` -- basin divides</span>
<span class="sd">    * ``self.GAMMA_L_OVR`` -- terminus over water</span>
<span class="sd">    * ``self.GAMMA_L_UDR`` -- terminus under water</span>
<span class="sd">    * ``self.GAMMA_U_GND`` -- grounded upper surface with :math:`\mathbf{u}_{ob}`</span>
<span class="sd">    * ``self.GAMMA_U_FLT`` -- shelf upper surface with :math:`\mathbf{u}_{ob}`</span>

<span class="sd">    Internal boundaries :</span>

<span class="sd">    * ``self.OMEGA_GND``   -- internal cells located over bedrock</span>
<span class="sd">    * ``self.OMEGA_FLT``   -- internal cells located over water</span>

<span class="sd">    These are then used to define the measures used for integration by FEniCS</span>
<span class="sd">    by calling :func:`set_measures`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raiseNotDefined</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.set_measures"><a class="viewcode-back" href="../model.html#model.Model.set_measures">[docs]</a>  <span class="k">def</span> <span class="nf">set_measures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    set the new measure space for facets ``self.ds`` and cells ``self.dx`` for</span>
<span class="sd">    the boundaries marked by FacetFunction ``self.ff`` and CellFunction</span>
<span class="sd">    ``self.cf``, respectively.</span>

<span class="sd">    Also, the number of facets marked by</span>
<span class="sd">    :func:`calculate_boundaries` :</span>

<span class="sd">    * ``self.N_OMEGA_GND``   -- number of cells marked ``self.OMEGA_GND``</span>
<span class="sd">    * ``self.N_OMEGA_FLT``   -- number of cells marked ``self.OMEGA_FLT``</span>
<span class="sd">    * ``self.N_GAMMA_S_GND`` -- number of facets marked ``self.GAMMA_S_GND``</span>
<span class="sd">    * ``self.N_GAMMA_B_GND`` -- number of facets marked ``self.GAMMA_B_GND``</span>
<span class="sd">    * ``self.N_GAMMA_S_FLT`` -- number of facets marked ``self.GAMMA_S_FLT``</span>
<span class="sd">    * ``self.N_GAMMA_B_FLT`` -- number of facets marked ``self.GAMMA_B_FLT``</span>
<span class="sd">    * ``self.N_GAMMA_L_DVD`` -- number of facets marked ``self.GAMMA_L_DVD``</span>
<span class="sd">    * ``self.N_GAMMA_L_OVR`` -- number of facets marked ``self.GAMMA_L_OVR``</span>
<span class="sd">    * ``self.N_GAMMA_L_UDR`` -- number of facets marked ``self.GAMMA_L_UDR``</span>
<span class="sd">    * ``self.N_GAMMA_U_GND`` -- number of facets marked ``self.GAMMA_U_GND``</span>
<span class="sd">    * ``self.N_GAMMA_U_FLT`` -- number of facets marked ``self.GAMMA_U_FLT``</span>

<span class="sd">    The subdomains corresponding to FacetFunction ``self.ff`` are :</span>

<span class="sd">    * ``self.dBed_g``  --  grounded bed</span>
<span class="sd">    * ``self.dBed_f``  --  floating bed</span>
<span class="sd">    * ``self.dBed``    --  bed</span>
<span class="sd">    * ``self.dSrf_gu`` --  grounded with U observations</span>
<span class="sd">    * ``self.dSrf_fu`` --  floating with U observations</span>
<span class="sd">    * ``self.dSrf_u``  --  surface with U observations</span>
<span class="sd">    * ``self.dSrf_g``  --  surface of grounded ice</span>
<span class="sd">    * ``self.dSrf_f``  --  surface of floating ice</span>
<span class="sd">    * ``self.dSrf``    --  surface</span>
<span class="sd">    * ``self.dLat_d``  --  lateral divide</span>
<span class="sd">    * ``self.dLat_to`` --  lateral terminus overwater</span>
<span class="sd">    * ``self.dLat_tu`` --  lateral terminus underwater</span>
<span class="sd">    * ``self.dLat_t``  --  lateral terminus</span>
<span class="sd">    * ``self.dLat``    --  lateral</span>

<span class="sd">    The subdomains corresponding to CellFunction ``self.cf`` are :</span>

<span class="sd">    * ``self.dx_g``    --  internal above grounded</span>
<span class="sd">    * ``self.dx_f``    --  internal above floating</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raiseNotDefined</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.set_out_dir"><a class="viewcode-back" href="../model.html#model.Model.set_out_dir">[docs]</a>  <span class="k">def</span> <span class="nf">set_out_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the output directory to string ``out_dir``.</span>

<span class="sd">    :param out_dir: the output directory for any output generated by</span>
<span class="sd">                    :func:`save_hdf5`, :func:`save_xdmf`, :func:`save_pvd`,</span>
<span class="sd">                    :func:`save_list_to_hdf5`, :func:`save_subdomain_data`,</span>
<span class="sd">                    and :func:`save_mesh`.</span>
<span class="sd">    :type out_dir:  string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">=</span> <span class="n">out_dir</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: output directory changed to &#39;</span><span class="si">%s</span><span class="s2">&#39; :::&quot;</span> <span class="o">%</span> <span class="n">out_dir</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.generate_function_spaces"><a class="viewcode-back" href="../model.html#model.Model.generate_function_spaces">[docs]</a>  <span class="k">def</span> <span class="nf">generate_function_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the finite-element function spaces used by all children of this</span>
<span class="sd">    :class:`Model`.</span>

<span class="sd">    The element shape-functions available from this method are :</span>

<span class="sd">    * ``self.Q``  -- :math:`\mathcal{H}^k(\Omega)`</span>
<span class="sd">    * ``self.Q2`` -- :math:`\mathcal{H}^k(\Omega) \times \mathcal{H}^k(\Omega)`</span>
<span class="sd">    * ``self.Q3`` -- :math:`\mathcal{H}^k(\Omega) \times \mathcal{H}^k(\Omega) \times \mathcal{H}^k(\Omega)`</span>
<span class="sd">    * ``self.Q4`` -- :math:`\mathcal{H}^k(\Omega) \times \mathcal{H}^k(\Omega) \times \mathcal{H}^k(\Omega) \times \mathcal{H}^k(\Omega)`</span>
<span class="sd">    * ``self.Q_non_periodic`` -- same as ``self.Q``, but without periodic constraints</span>
<span class="sd">    * ``self.Q3_non_periodic`` -- same as ``self.Q3``, but without periodic constraints</span>
<span class="sd">    * ``self.V`` -- same as ``self.Q3`` but formed using :class:`~dolfin.VectorFunctionSpace`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span>

    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: generating fundamental function spaces of order </span><span class="si">%i</span><span class="s2"> :::&quot;</span> <span class="o">%</span> <span class="n">order</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

    <span class="c1"># define elements that may or may not be used :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Q1e</span>    <span class="o">=</span> <span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="n">order</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">V1e</span>    <span class="o">=</span> <span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="n">order</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Q2e</span>    <span class="o">=</span> <span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">QM2e</span>   <span class="o">=</span> <span class="n">MixedElement</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Q1e</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">QM3e</span>   <span class="o">=</span> <span class="n">MixedElement</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Q1e</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">QM4e</span>   <span class="o">=</span> <span class="n">MixedElement</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Q1e</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">QTH3e</span>  <span class="o">=</span> <span class="n">MixedElement</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Q2e</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Q2e</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Q2e</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Q1e</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">BDMe</span>   <span class="o">=</span> <span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;BDM&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">DGe</span>    <span class="o">=</span> <span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">DG1e</span>   <span class="o">=</span> <span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">QTH2e</span>  <span class="o">=</span> <span class="n">MixedElement</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Q2e</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Q2e</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Q1e</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">BDMMe</span>  <span class="o">=</span> <span class="n">MixedElement</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">BDMe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DGe</span><span class="p">])</span>

    <span class="c1"># NOTE: generate periodic function spaces if required</span>
    <span class="c1"># the functionspaces must be initialized with constrained domains prior</span>
    <span class="c1"># to mesh deformation.  If periodic boundary conditions are not used, the</span>
    <span class="c1"># individual &quot;Physics&quot; classes will initialize the FunctionSpaces to</span>
    <span class="c1"># conserve CPU time and especially memory :</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_periodic</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">generate_pbc</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Q</span>                <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q1e</span><span class="p">,</span>
                                          <span class="n">constrained_domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pBC</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Q2</span>               <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">QM2e</span><span class="p">,</span>
                                          <span class="n">constrained_domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pBC</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Q3</span>               <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">QM3e</span><span class="p">,</span>
                                          <span class="n">constrained_domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pBC</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span>   <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q1e</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Q3_non_periodic</span>  <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">QM3e</span><span class="p">)</span>

    <span class="c1"># NOTE: the function spaces &quot;_non_periodic&quot; are needed as some</span>
    <span class="c1"># functions must be defined as non-periodic for the solution to make sense</span>
    <span class="c1"># see (self.initialize_variables()).</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">V</span>  <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V1e</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;    - fundamental function spaces created - &quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_S"><a class="viewcode-back" href="../model.html#model.Model.init_S">[docs]</a>  <span class="k">def</span> <span class="nf">init_S</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set surface topography :math:`S`, ``self.S``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param S:   surface topography</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializng surface topography :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_B"><a class="viewcode-back" href="../model.html#model.Model.init_B">[docs]</a>  <span class="k">def</span> <span class="nf">init_B</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set basal topography :math:`B`, ``self.B``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param B:   basal topography</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializng basal topography :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_sigma"><a class="viewcode-back" href="../model.html#model.Model.init_sigma">[docs]</a>  <span class="k">def</span> <span class="nf">init_sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set sigma coordinate by calling :func:`assign_variable`.</span>

<span class="sd">    :param sigma:   sigma coordinate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializng sigma coordinate :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_B_err"><a class="viewcode-back" href="../model.html#model.Model.init_B_err">[docs]</a>  <span class="k">def</span> <span class="nf">init_B_err</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_err</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set basal topography uncertainty :math:`B_{\epsilon}`, ``self.B_err``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param B_err:   basal topography uncertainty</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializng basal topography uncertainty :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_err</span><span class="p">,</span> <span class="n">B_err</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_p"><a class="viewcode-back" href="../model.html#model.Model.init_p">[docs]</a>  <span class="k">def</span> <span class="nf">init_p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set pressure :math:`p`, ``self.p``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param p:   pressure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing pressure :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_theta"><a class="viewcode-back" href="../model.html#model.Model.init_theta">[docs]</a>  <span class="k">def</span> <span class="nf">init_theta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set internal energy :math:`\theta`, ``self.theta``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param theta:   internal energy</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing internal energy :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
    <span class="c1"># init pressure-melting temperature thing :</span>
    <span class="n">theta_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="n">T_v</span>     <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">146.3</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">146.3</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="mf">7.253</span><span class="o">*</span><span class="n">theta_v</span><span class="p">))</span> <span class="o">/</span> <span class="mf">7.253</span>
    <span class="n">T_v</span><span class="p">[</span><span class="n">T_v</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_w</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_w</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">init_Tp</span><span class="p">(</span><span class="n">T_v</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_theta_app"><a class="viewcode-back" href="../model.html#model.Model.init_theta_app">[docs]</a>  <span class="k">def</span> <span class="nf">init_theta_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta_app</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the internal energy approximation :math:`\theta_{app}`,</span>
<span class="sd">    ``self.theta_app``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param theta_app:   internal energy approximation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing internal energy approximation :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_app</span><span class="p">,</span> <span class="n">theta_app</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_theta_surface"><a class="viewcode-back" href="../model.html#model.Model.init_theta_surface">[docs]</a>  <span class="k">def</span> <span class="nf">init_theta_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta_surface</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the surface internal energy :math:`\theta_S`, ``self.theta_surface``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param theta_surface:   surface internal energy</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing surface energy :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_surface</span><span class="p">,</span> <span class="n">theta_surface</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_theta_float"><a class="viewcode-back" href="../model.html#model.Model.init_theta_float">[docs]</a>  <span class="k">def</span> <span class="nf">init_theta_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta_float</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the floating ice internal energy :math:`\theta_{sea}`,</span>
<span class="sd">    ``self.theta_float``, by calling :func:`assign_variable`.</span>

<span class="sd">    :param theta_float:   internal energy in contact with water</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing internal energy of facets in contact with water :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_float</span><span class="p">,</span> <span class="n">theta_float</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_T"><a class="viewcode-back" href="../model.html#model.Model.init_T">[docs]</a>  <span class="k">def</span> <span class="nf">init_T</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set temperature :math:`T`, ``self.T``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param T: temperature</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing absolute temperature :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_Tp"><a class="viewcode-back" href="../model.html#model.Model.init_Tp">[docs]</a>  <span class="k">def</span> <span class="nf">init_Tp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Tp</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set pressure-adjusted temperature :math:`T_p = T + \gamma p`, ``self.Tp``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param Tp:   pressure-adjusted temperature :math:`T_p = T + \gamma p`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing pressure-adjusted temperature :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tp</span><span class="p">,</span> <span class="n">Tp</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_W"><a class="viewcode-back" href="../model.html#model.Model.init_W">[docs]</a>  <span class="k">def</span> <span class="nf">init_W</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set water content :math:`W`, ``self.W``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param W:  water content</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing water content :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_Wc"><a class="viewcode-back" href="../model.html#model.Model.init_Wc">[docs]</a>  <span class="k">def</span> <span class="nf">init_Wc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Wc</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set maximum observed water content :math:`W_c`, ``self.Wc``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param Wc:   maximum allowed water content</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing maximum water content :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Wc</span><span class="p">,</span> <span class="n">Wc</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_Mb"><a class="viewcode-back" href="../model.html#model.Model.init_Mb">[docs]</a>  <span class="k">def</span> <span class="nf">init_Mb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Mb</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set basal melting rate :math:`M_b`, ``self.Mb``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param Mb:   basal-melt rate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing basal-melt rate :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mb</span><span class="p">,</span> <span class="n">Mb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_adot"><a class="viewcode-back" href="../model.html#model.Model.init_adot">[docs]</a>  <span class="k">def</span> <span class="nf">init_adot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adot</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set accumulation/ablation :math:`\dot{a}`, ``self.adot``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param adot:   accumulation/ablation :math:`\dot{a}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing accumulation/ablation function :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adot</span><span class="p">,</span> <span class="n">adot</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_beta"><a class="viewcode-back" href="../model.html#model.Model.init_beta">[docs]</a>  <span class="k">def</span> <span class="nf">init_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set basal traction :math:`\beta`, ``self.beta``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param beta:  basal traction :math:`\beta`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing basal traction coefficient :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_lam"><a class="viewcode-back" href="../model.html#model.Model.init_lam">[docs]</a>  <span class="k">def</span> <span class="nf">init_lam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lam</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set basal normal stress magnitude :math:`\underline{n} \cdot \underline{\underline{\sigma}} \cdot \underline{n}`, ``self.lam``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param lam:  basal normal stress magnitude :math:`\underline{n} \cdot \underline{\underline{\sigma}} \cdot \underline{n}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing basal traction coefficient :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_A"><a class="viewcode-back" href="../model.html#model.Model.init_A">[docs]</a>  <span class="k">def</span> <span class="nf">init_A</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set flow-rate factor :math:`A`, ``self.A``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param A:  flow-rate factor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing flow-rate factor over grounded and shelves :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_E"><a class="viewcode-back" href="../model.html#model.Model.init_E">[docs]</a>  <span class="k">def</span> <span class="nf">init_E</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">E</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set flow-enhancement factor :math:`E`, ``self.E``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param E:  enhancement factor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing enhancement factor over grounded and shelves :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_eta"><a class="viewcode-back" href="../model.html#model.Model.init_eta">[docs]</a>  <span class="k">def</span> <span class="nf">init_eta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eta</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set viscosity :math:`\eta`, ``self.eta``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param eta:   viscosity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing viscosity :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eta</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_etabar"><a class="viewcode-back" href="../model.html#model.Model.init_etabar">[docs]</a>  <span class="k">def</span> <span class="nf">init_etabar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etabar</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set vertically averaged viscosity :math:`\bar{\eta}`, ``self.etabar``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param etabar:   vertically-averaged viscosity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing vertically averaged viscosity :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etabar</span><span class="p">,</span> <span class="n">etabar</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_ubar"><a class="viewcode-back" href="../model.html#model.Model.init_ubar">[docs]</a>  <span class="k">def</span> <span class="nf">init_ubar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ubar</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set vertically averaged x-component of velocity :math:`\bar{u}`,</span>
<span class="sd">    ``self.ubar``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param ubar:   vertically-averaged x-component of velocity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing vertically averaged x-component of velocity :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ubar</span><span class="p">,</span> <span class="n">ubar</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_vbar"><a class="viewcode-back" href="../model.html#model.Model.init_vbar">[docs]</a>  <span class="k">def</span> <span class="nf">init_vbar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vbar</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set vertically averaged y-component of velocity :math:`\bar{v}`,</span>
<span class="sd">    ``self.vbar``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param vbar:   vertically-averaged y-component of velocity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing vertically averaged y-component of velocity :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vbar</span><span class="p">,</span> <span class="n">vbar</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_wbar"><a class="viewcode-back" href="../model.html#model.Model.init_wbar">[docs]</a>  <span class="k">def</span> <span class="nf">init_wbar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wbar</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set vertically averaged z-component of velocity :math:`\bar{w}`,</span>
<span class="sd">    ``self.wbar``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param wbar:   vertically-averaged z-component of velocity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing vertically averaged z-component of velocity :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wbar</span><span class="p">,</span> <span class="n">wbar</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_T_surface"><a class="viewcode-back" href="../model.html#model.Model.init_T_surface">[docs]</a>  <span class="k">def</span> <span class="nf">init_T_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T_surface</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set surface temperature :math:`T_S`, ``self.T_surface``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param T_surface:   surface temperature</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing surface temperature :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_surface</span><span class="p">,</span> <span class="n">T_surface</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_q_geo"><a class="viewcode-back" href="../model.html#model.Model.init_q_geo">[docs]</a>  <span class="k">def</span> <span class="nf">init_q_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_geo</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set geothermal heat flux :math:`q_{geo}`, ``self.q_geo``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param q_geo:   geothermal heat flux</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing geothermal heat flux :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_geo</span><span class="p">,</span> <span class="n">q_geo</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_q_fric"><a class="viewcode-back" href="../model.html#model.Model.init_q_fric">[docs]</a>  <span class="k">def</span> <span class="nf">init_q_fric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_fric</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set traction heat flux :math:`q_{fric}`, ``self.q_fric``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param q_fric:  friction heat flux</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing basal friction heat flux :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_fric</span><span class="p">,</span> <span class="n">q_fric</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_gradT_B"><a class="viewcode-back" href="../model.html#model.Model.init_gradT_B">[docs]</a>  <span class="k">def</span> <span class="nf">init_gradT_B</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradT_B</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set basal temperature gradient</span>
<span class="sd">    :math:`\left( k \nabla T \right) \cdot \mathbf{n}`, ``self.gradT_B``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param gradT_B:   basal temperature gradient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing basal temperature flux :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradT_B</span><span class="p">,</span> <span class="n">gradT_B</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_gradTm_B"><a class="viewcode-back" href="../model.html#model.Model.init_gradTm_B">[docs]</a>  <span class="k">def</span> <span class="nf">init_gradTm_B</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradTm_B</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set basal temperature melting gradient</span>
<span class="sd">    :math:`\left( k \nabla T_m \right) \cdot \mathbf{n}`, ``self.gradTm_B``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param gradTm_B:   basal temperature melting gradient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing basal temperature-melting flux :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradTm_B</span><span class="p">,</span> <span class="n">gradTm_B</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_u"><a class="viewcode-back" href="../model.html#model.Model.init_u">[docs]</a>  <span class="k">def</span> <span class="nf">init_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set x-component of velocity :math:`u`, ``self.u``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param u:  x-component of velocity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing x-component of velocity :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="n">u_t</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;u_t&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="n">u_t</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assx</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">u_t</span><span class="p">,</span> <span class="n">annotate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_v"><a class="viewcode-back" href="../model.html#model.Model.init_v">[docs]</a>  <span class="k">def</span> <span class="nf">init_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set y-component of velocity :math:`v`, ``self.v``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param v:  y-component of velocity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing y-component of velocity :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="n">v_t</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;v_t&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="n">v_t</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assy</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">v_t</span><span class="p">,</span> <span class="n">annotate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_w"><a class="viewcode-back" href="../model.html#model.Model.init_w">[docs]</a>  <span class="k">def</span> <span class="nf">init_w</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set z-component of velocity :math:`w`, ``self.w``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param w:  z-component of velocity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing z-component of velocity :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="n">w_t</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;w_t&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="n">w_t</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assz</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="n">w_t</span><span class="p">,</span> <span class="n">annotate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_U"><a class="viewcode-back" href="../model.html#model.Model.init_U">[docs]</a>  <span class="k">def</span> <span class="nf">init_U</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set velocity vector :math:`\mathbf{u}`, ``self.U3``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param U: velocity vector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing velocity :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U3</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">init_U_mag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U3</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_U_mag"><a class="viewcode-back" href="../model.html#model.Model.init_U_mag">[docs]</a>  <span class="k">def</span> <span class="nf">init_U_mag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set velocity vector magnitude :math:`\Vert \mathbf{u} \Vert`,</span>
<span class="sd">    ``self.U_mag``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param U:   velocity vector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing velocity magnitude :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="c1"># dolfin issue #405 bug workaround :</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_periodic</span><span class="p">:</span>
      <span class="n">u</span>      <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span>
      <span class="n">v</span>      <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span>
      <span class="n">w</span>      <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span>
      <span class="n">assign</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
      <span class="n">assign</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">assign</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">w</span>  <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">u_v</span>      <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="n">v_v</span>      <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="n">w_v</span>      <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="n">U_mag_v</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u_v</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v_v</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">w_v</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">DOLFIN_EPS</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U_mag</span><span class="p">,</span> <span class="n">U_mag_v</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_U_ob"><a class="viewcode-back" href="../model.html#model.Model.init_U_ob">[docs]</a>  <span class="k">def</span> <span class="nf">init_U_ob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u_ob</span><span class="p">,</span> <span class="n">v_ob</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set horizontal velocity observation vector :math:`\mathbf{u}_{ob}`,</span>
<span class="sd">    ``self.U_ob``, and horizontal components :math:`u_{ob}` and :math:`v_{ob}`,</span>
<span class="sd">    ``self.u_ob`` and ``self.v_ob``, respectively,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param u_ob: x-component of observed velocity</span>
<span class="sd">    :param v_ob: y-component of observed velocity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing surface velocity :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_ob</span><span class="p">,</span> <span class="n">u_ob</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_ob</span><span class="p">,</span> <span class="n">v_ob</span><span class="p">)</span>
    <span class="n">u_v</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_ob</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="n">v_v</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_ob</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="n">U_mag_v</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u_v</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v_v</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U_ob</span><span class="p">,</span> <span class="n">U_mag_v</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_Ubar"><a class="viewcode-back" href="../model.html#model.Model.init_Ubar">[docs]</a>  <span class="k">def</span> <span class="nf">init_Ubar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Ubar</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set balance velocity :math:`\Vert \bar{\mathbf{u}} \Vert = \bar{u}`,</span>
<span class="sd">    ``self.Ubar``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param Ubar:  balance velocity magnitude</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing balance velocity magnitude :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ubar</span><span class="p">,</span> <span class="n">Ubar</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_uhat"><a class="viewcode-back" href="../model.html#model.Model.init_uhat">[docs]</a>  <span class="k">def</span> <span class="nf">init_uhat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uhat</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set normalized x-component of lateral velocity</span>
<span class="sd">    :math:`\hat{u}`, ``self.uhat``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param uhat:   normalized x-component of velocity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing normalized x-component of velocity :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uhat</span><span class="p">,</span> <span class="n">uhat</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_vhat"><a class="viewcode-back" href="../model.html#model.Model.init_vhat">[docs]</a>  <span class="k">def</span> <span class="nf">init_vhat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vhat</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set normalized y-component of lateral velocity</span>
<span class="sd">    :math:`\hat{v}`, ``self.vhat``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param vhat:   normalized y-component of velocity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing normalized y-component of velocity :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vhat</span><span class="p">,</span> <span class="n">vhat</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_u_lat"><a class="viewcode-back" href="../model.html#model.Model.init_u_lat">[docs]</a>  <span class="k">def</span> <span class="nf">init_u_lat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u_lat</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set x-component of lateral velocity :math:`u_{g_D}`, ``self.u_lat``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param u_lat:   x-component of velocity essential condition</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing u lateral boundary condition :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_lat</span><span class="p">,</span> <span class="n">u_lat</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_v_lat"><a class="viewcode-back" href="../model.html#model.Model.init_v_lat">[docs]</a>  <span class="k">def</span> <span class="nf">init_v_lat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v_lat</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set y-component of lateral velocity :math:`v_{g_D}`, ``self.v_lat``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param v_lat:   y-component of velocity essential condition</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing v lateral boundary condition :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_lat</span><span class="p">,</span> <span class="n">v_lat</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_w_lat"><a class="viewcode-back" href="../model.html#model.Model.init_w_lat">[docs]</a>  <span class="k">def</span> <span class="nf">init_w_lat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w_lat</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set z-component of lateral velocity :math:`w_{g_D}`, ``self.w_lat``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param w_lat:   w-component of velocity essential condition</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing w lateral boundary condition :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_lat</span><span class="p">,</span> <span class="n">w_lat</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_mask"><a class="viewcode-back" href="../model.html#model.Model.init_mask">[docs]</a>  <span class="k">def</span> <span class="nf">init_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set shelf mask ``self.mask``</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    This in turn generates a vector of indices corresponding with grounded</span>
<span class="sd">    and shelf vertices:</span>

<span class="sd">    * ``self.shf_dofs`` -- shelf dofs</span>
<span class="sd">    * ``self.gnd_dofs`` -- grounded dofs</span>

<span class="sd">    :param mask:   ice-shelf mask (1 is grounded, 2 is floating)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing shelf mask :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">shf_dofs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span> <span class="o">==</span> <span class="mf">2.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gnd_dofs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="Model.init_U_mask"><a class="viewcode-back" href="../model.html#model.Model.init_U_mask">[docs]</a>  <span class="k">def</span> <span class="nf">init_U_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U_mask</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set velocity observation mask ``self.U_mask``</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    This in turn generates a vector of indices corresponding with grounded</span>
<span class="sd">    and shelf vertices:</span>

<span class="sd">    * ``self.Uob_dofs`` --  observations :math:`\mathbf{u}_{ob}` present dofs</span>
<span class="sd">    * ``self.Uob_missing_dofs`` -- observations :math:`\mathbf{u}_{ob}` missing dofs</span>

<span class="sd">    :param U_mask:   surface-velocity-oberservations mask (1 has observations, 0 does not)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing velocity mask :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U_mask</span><span class="p">,</span> <span class="n">U_mask</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Uob_dofs</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U_mask</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Uob_missing_dofs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U_mask</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="Model.init_d_x"><a class="viewcode-back" href="../model.html#model.Model.init_d_x">[docs]</a>  <span class="k">def</span> <span class="nf">init_d_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_x</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set x-component of flow-direction :math:`d_x`, ``self.d_x``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param d_x:   x-component of flow direction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing x-component flow direction :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_x</span><span class="p">,</span> <span class="n">d_x</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_d_y"><a class="viewcode-back" href="../model.html#model.Model.init_d_y">[docs]</a>  <span class="k">def</span> <span class="nf">init_d_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_y</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set y-component of flow-direction :math:`d_y`, ``self.d_y``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param d_y:   y-component of flow direction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing y-component of flow direction :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_y</span><span class="p">,</span> <span class="n">d_y</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_time_step"><a class="viewcode-back" href="../model.html#model.Model.init_time_step">[docs]</a>  <span class="k">def</span> <span class="nf">init_time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set time step :math:`\Delta t`, ``self.dt``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param dt:   time step</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing time step :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_lat"><a class="viewcode-back" href="../model.html#model.Model.init_lat">[docs]</a>  <span class="k">def</span> <span class="nf">init_lat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set grid latitude ``self.lat``</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param lat:   grid latitude values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing grid latitude :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_lon"><a class="viewcode-back" href="../model.html#model.Model.init_lon">[docs]</a>  <span class="k">def</span> <span class="nf">init_lon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set grid longitude ``self.lon``</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param lon:   grid longitude values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing grid longitude :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_M_ii"><a class="viewcode-back" href="../model.html#model.Model.init_M_ii">[docs]</a>  <span class="k">def</span> <span class="nf">init_M_ii</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M_ii</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane-stress balance :math:`M_{ii}`, ``self.M_ii``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param M_ii:   membrane-stress balance :math:`M_{ii}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing membrane-stress balance M_ii :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M_ii</span><span class="p">,</span> <span class="n">M_ii</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_M_ij"><a class="viewcode-back" href="../model.html#model.Model.init_M_ij">[docs]</a>  <span class="k">def</span> <span class="nf">init_M_ij</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M_ij</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane-stress balance :math:`M_{ij}`, ``self.M_ij``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param M_ij:   membrane-stress balance :math:`M_{ij}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing membrane-stress balance M_ij :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M_ij</span><span class="p">,</span> <span class="n">M_ij</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_M_iz"><a class="viewcode-back" href="../model.html#model.Model.init_M_iz">[docs]</a>  <span class="k">def</span> <span class="nf">init_M_iz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M_iz</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane-stress balance :math:`M_{iz}`, ``self.M_iz``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param M_iz:   membrane-stress balance :math:`M_{iz}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing membrane-stress balance M_iz :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M_iz</span><span class="p">,</span> <span class="n">M_iz</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_M_ji"><a class="viewcode-back" href="../model.html#model.Model.init_M_ji">[docs]</a>  <span class="k">def</span> <span class="nf">init_M_ji</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M_ji</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane-stress balance :math:`M_{ji}`, ``self.M_ji``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param M_ji:   membrane-stress balance :math:`M_{ji}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing membrane-stress balance M_ji :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M_ji</span><span class="p">,</span> <span class="n">M_ji</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_M_jj"><a class="viewcode-back" href="../model.html#model.Model.init_M_jj">[docs]</a>  <span class="k">def</span> <span class="nf">init_M_jj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M_jj</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane-stress balance :math:`M_{jj}`, ``self.M_jj``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param M_jj:   membrane-stress balance :math:`M_{jj}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing membrane-stress balance M_jj :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M_jj</span><span class="p">,</span> <span class="n">M_jj</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_M_jz"><a class="viewcode-back" href="../model.html#model.Model.init_M_jz">[docs]</a>  <span class="k">def</span> <span class="nf">init_M_jz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M_jz</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane-stress balance :math:`M_{jz}`, ``self.M_jz``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param M_jz:   membrane-stress balance :math:`M_{jz}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing membrane-stress balance M_jz :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M_jz</span><span class="p">,</span> <span class="n">M_jz</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_M_zi"><a class="viewcode-back" href="../model.html#model.Model.init_M_zi">[docs]</a>  <span class="k">def</span> <span class="nf">init_M_zi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M_zi</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane-stress balance :math:`M_{zi}`, ``self.M_zi``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param M_zi:   membrane-stress balance :math:`M_{zi}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing membrane-stress balance M_zi :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M_zi</span><span class="p">,</span> <span class="n">M_zi</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_M_zj"><a class="viewcode-back" href="../model.html#model.Model.init_M_zj">[docs]</a>  <span class="k">def</span> <span class="nf">init_M_zj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M_zj</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane-stress balance :math:`M_{zj}`, ``self.M_zj``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param M_zj:   membrane-stress balance :math:`M_{zj}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing membrane-stress balance M_zj :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M_zj</span><span class="p">,</span> <span class="n">M_zj</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_M_zz"><a class="viewcode-back" href="../model.html#model.Model.init_M_zz">[docs]</a>  <span class="k">def</span> <span class="nf">init_M_zz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M_zz</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane-stress balance :math:`M_{zz}`, ``self.M_zz``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param M_zz:   membrane-stress balance :math:`M_{zz}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing membrane-stress balance M_zz :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M_zz</span><span class="p">,</span> <span class="n">M_zz</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_N_ii"><a class="viewcode-back" href="../model.html#model.Model.init_N_ii">[docs]</a>  <span class="k">def</span> <span class="nf">init_N_ii</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_ii</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane stress :math:`N_{ii}`, ``self.N_ii``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param N_ii:   membrane-stress :math:`N_{ii}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing N_ii :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_ii</span><span class="p">,</span> <span class="n">N_ii</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_N_ij"><a class="viewcode-back" href="../model.html#model.Model.init_N_ij">[docs]</a>  <span class="k">def</span> <span class="nf">init_N_ij</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_ij</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane stress :math:`N_{ij}`, ``self.N_ij``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param N_ij:   membrane-stress :math:`N_{ij}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing N_ij :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_ij</span><span class="p">,</span> <span class="n">N_ij</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_N_iz"><a class="viewcode-back" href="../model.html#model.Model.init_N_iz">[docs]</a>  <span class="k">def</span> <span class="nf">init_N_iz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_iz</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane stress :math:`N_{iz}`, ``self.N_iz``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param N_iz:   membrane-stress :math:`N_{iz}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing N_iz :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_iz</span><span class="p">,</span> <span class="n">N_iz</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_N_ji"><a class="viewcode-back" href="../model.html#model.Model.init_N_ji">[docs]</a>  <span class="k">def</span> <span class="nf">init_N_ji</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_ji</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane stress :math:`N_{ji}`, ``self.N_ji``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param N_ji:   membrane-stress :math:`N_{ji}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing N_ji :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_ji</span><span class="p">,</span> <span class="n">N_ji</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_N_jj"><a class="viewcode-back" href="../model.html#model.Model.init_N_jj">[docs]</a>  <span class="k">def</span> <span class="nf">init_N_jj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_jj</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane stress :math:`N_{jj}`, ``self.N_jj``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param N_jj:   membrane-stress :math:`N_{jj}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing N_jj :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_jj</span><span class="p">,</span> <span class="n">N_jj</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_N_jz"><a class="viewcode-back" href="../model.html#model.Model.init_N_jz">[docs]</a>  <span class="k">def</span> <span class="nf">init_N_jz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_jz</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane stress :math:`N_{jz}`, ``self.N_jz``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param N_jz:   membrane-stress :math:`N_{jz}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing N_jz :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_jz</span><span class="p">,</span> <span class="n">N_jz</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_N_zi"><a class="viewcode-back" href="../model.html#model.Model.init_N_zi">[docs]</a>  <span class="k">def</span> <span class="nf">init_N_zi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_zi</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane stress :math:`N_{zi}`, ``self.N_zi``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param N_zi:   membrane-stress :math:`N_{zi}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing N_zi :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_zi</span><span class="p">,</span> <span class="n">N_zi</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_N_zj"><a class="viewcode-back" href="../model.html#model.Model.init_N_zj">[docs]</a>  <span class="k">def</span> <span class="nf">init_N_zj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_zj</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane stress :math:`N_{zj}`, ``self.N_zj``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param N_zj:   membrane-stress :math:`N_{zj}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing N_zj :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_zj</span><span class="p">,</span> <span class="n">N_zj</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_N_zz"><a class="viewcode-back" href="../model.html#model.Model.init_N_zz">[docs]</a>  <span class="k">def</span> <span class="nf">init_N_zz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_zz</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set membrane stress :math:`N_{zz}`, ``self.N_zz``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param N_zz:   membrane-stress :math:`N_{zz}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing N_zz :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_zz</span><span class="p">,</span> <span class="n">N_zz</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_alpha"><a class="viewcode-back" href="../model.html#model.Model.init_alpha">[docs]</a>  <span class="k">def</span> <span class="nf">init_alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set temperate-zone-marking coefficient :math:`\alpha`, ``self.alpha``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param alpha:  temperate-zone-marking coefficient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing temperate-zone-marking coefficient :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_alpha_int"><a class="viewcode-back" href="../model.html#model.Model.init_alpha_int">[docs]</a>  <span class="k">def</span> <span class="nf">init_alpha_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha_int</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set vertical integral of temperate zone marking coefficient</span>
<span class="sd">    :math:`\int \alpha dz`, ``self.alpha_int``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param alpha_int:  vertical integral of temperate-zone-marking coefficient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing temperate-zone thickness :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_int</span><span class="p">,</span> <span class="n">alpha_int</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_Fb"><a class="viewcode-back" href="../model.html#model.Model.init_Fb">[docs]</a>  <span class="k">def</span> <span class="nf">init_Fb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Fb</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set basal-water discharge :math:`F_b`, ``self.Fb``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param Fb:   basal-water discharge</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing basal-water discharge :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Fb</span><span class="p">,</span> <span class="n">Fb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_Wbar"><a class="viewcode-back" href="../model.html#model.Model.init_Wbar">[docs]</a>  <span class="k">def</span> <span class="nf">init_Wbar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Wbar</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set vertically-averaged water content :math:`\bar{W}`, ``self.Wbar``.</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param Wbar:   vertically-averaged water content</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing vertically averaged water content :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Wbar</span><span class="p">,</span> <span class="n">Wbar</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_temp_rat"><a class="viewcode-back" href="../model.html#model.Model.init_temp_rat">[docs]</a>  <span class="k">def</span> <span class="nf">init_temp_rat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_rat</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set ratio of temperate ice :math:`\frac{1}{H}\int \alpha dz`,</span>
<span class="sd">    ``self.temp_rat``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param temp_rat:   ratio of column that is temperate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing temperate zone ratio :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_rat</span><span class="p">,</span> <span class="n">temp_rat</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_Qbar"><a class="viewcode-back" href="../model.html#model.Model.init_Qbar">[docs]</a>  <span class="k">def</span> <span class="nf">init_Qbar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Qbar</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set vertically-averaged strain heat :math:`\bar{Q}`, ``self.Qbar``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param Qbar:   vertically-averaged strain heat</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing vertically-averaged strain-heat :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Qbar</span><span class="p">,</span> <span class="n">Qbar</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_PE"><a class="viewcode-back" href="../model.html#model.Model.init_PE">[docs]</a>  <span class="k">def</span> <span class="nf">init_PE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PE</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set element Peclet number :math:`P_e`, ``self.PE``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param PE:   grid Peclet number</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing grid Peclet number :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PE</span><span class="p">,</span> <span class="n">PE</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_n_f"><a class="viewcode-back" href="../model.html#model.Model.init_n_f">[docs]</a>  <span class="k">def</span> <span class="nf">init_n_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_f</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set outward-normal vector array :math:`\mathbf{n}``, ``self.n_f``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param n_f:   vector of outward-pointing normal values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing outward-normal-vector function n_f :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_f</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_Fb_bounds"><a class="viewcode-back" href="../model.html#model.Model.init_Fb_bounds">[docs]</a>  <span class="k">def</span> <span class="nf">init_Fb_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Fb_min</span><span class="p">,</span> <span class="n">Fb_max</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set upper and lower bounds for basal-water discharge :math:`F_b^{\max}`</span>
<span class="sd">    and :math:`F_b^{\min}`,``self.Fb_max``, ``self.Fb_min``, respectively,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param Fb_min: lower bound for basal-water discharge ``self.Fb``</span>
<span class="sd">    :param Fb_max: upper bound for basal-water discharge ``self.Fb``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing bounds for basal-water discharge Fb :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">init_Fb_min</span><span class="p">(</span><span class="n">Fb_min</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">init_Fb_max</span><span class="p">(</span><span class="n">Fb_max</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_Fb_min"><a class="viewcode-back" href="../model.html#model.Model.init_Fb_min">[docs]</a>  <span class="k">def</span> <span class="nf">init_Fb_min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Fb_min</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set lower bound of basal water discharge :math:`F_b`, ``self.Fb_min``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param Fb_min: lower bound for basal-water discharge ``self.Fb``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing lower bound for basal water flux Fb :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Fb_min</span><span class="p">,</span> <span class="n">Fb_min</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_Fb_max"><a class="viewcode-back" href="../model.html#model.Model.init_Fb_max">[docs]</a>  <span class="k">def</span> <span class="nf">init_Fb_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Fb_max</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set upper bound of basal-water discharge :math:`F_b`, ``self.Fb_max``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param Fb_max: upper bound for basal-water discharge ``self.Fb``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing upper bound for basal water flux Fb :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Fb_max</span><span class="p">,</span> <span class="n">Fb_max</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_k_0"><a class="viewcode-back" href="../model.html#model.Model.init_k_0">[docs]</a>  <span class="k">def</span> <span class="nf">init_k_0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k_0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set non-advective water-flux coefficient :math:`k_0`, ``self.k_0``,</span>
<span class="sd">    by calling :func:`assign_variable`.</span>

<span class="sd">    :param k_0:   non-advective water-flux coefficient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing non-advective flux coefficient k_0 :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_0</span><span class="p">,</span> <span class="n">k_0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_lam_basal_pressure"><a class="viewcode-back" href="../model.html#model.Model.init_lam_basal_pressure">[docs]</a>  <span class="k">def</span> <span class="nf">init_lam_basal_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the basal normal stress ``self.lam`` to cryostatic pressure</span>
<span class="sd">    :math:`\rho g (S - B)`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhoi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">init_lam</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_beta_SIA"><a class="viewcode-back" href="../model.html#model.Model.init_beta_SIA">[docs]</a>  <span class="k">def</span> <span class="nf">init_beta_SIA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U_mag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Init basal-traction :math:`\beta`, ``self.beta``, from</span>

<span class="sd">    .. math::</span>

<span class="sd">       \beta \Vert \mathbf{u}_B \Vert = \rho g H \Vert \nabla S \Vert,</span>

<span class="sd">    the shallow ice approximation, using the observed surface velocity</span>
<span class="sd">    ``U_mag`` as approximate basal velocity,</span>

<span class="sd">    .. math::</span>

<span class="sd">       \beta_{\text{SIA}} = \frac{\rho g H \Vert \nabla S \Vert}{\Vert \mathbf{u}_B \Vert + \epsilon}</span>

<span class="sd">    :param U_mag: basal-velocity :math:`\mathbf{u}_B` magnitude.</span>
<span class="sd">    :param eps:   minimum velocity :math:`\epsilon` introduced</span>
<span class="sd">                  to prevent singularity, default is 0.5 m/a.</span>

<span class="sd">    If ``U_mag`` is ``None``, the basal velocity :math:`\mathbf{u}_B` is</span>
<span class="sd">    defined from :math:`\mathbf{u}_{ob}` as given by ``self.U_ob``.  Any</span>
<span class="sd">    gaps in obervation data defined by ``self.Uob_missing_dofs``</span>
<span class="sd">    (see :func:`init_U_mask`) are set to values defined by balance-velocity</span>
<span class="sd">    magnitude :math:`\bar{u}` as given by ``self.Ubar``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing beta from SIA :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="n">Q</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span>
    <span class="n">rhoi</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhoi</span>
    <span class="n">g</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span>
    <span class="n">gradS</span>    <span class="o">=</span> <span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>
    <span class="n">H</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span>
    <span class="n">U_s</span>      <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;U_s&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">U_mag</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">U_v</span>                        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U_ob</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
      <span class="n">Ubar_v</span>                     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ubar</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
      <span class="n">U_v</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Uob_missing_dofs</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ubar_v</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Uob_missing_dofs</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">U_v</span> <span class="o">=</span> <span class="n">U_mag</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="n">U_v</span><span class="p">[</span><span class="n">U_v</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">]</span> <span class="o">=</span> <span class="n">eps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="n">U_s</span><span class="p">,</span> <span class="n">U_v</span><span class="p">)</span>
    <span class="n">S_mag</span>    <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">inner</span><span class="p">(</span><span class="n">gradS</span><span class="p">,</span> <span class="n">gradS</span><span class="p">)</span> <span class="o">+</span> <span class="n">DOLFIN_EPS</span><span class="p">)</span>
    <span class="n">beta_0</span>   <span class="o">=</span> <span class="n">project</span><span class="p">((</span><span class="n">rhoi</span><span class="o">*</span><span class="n">g</span><span class="o">*</span><span class="n">H</span><span class="o">*</span><span class="n">S_mag</span><span class="p">)</span> <span class="o">/</span> <span class="n">U_s</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span>
                       <span class="n">solver_type</span><span class="o">=</span><span class="s1">&#39;iterative&#39;</span><span class="p">,</span>
                       <span class="n">annotate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">beta_0_v</span> <span class="o">=</span> <span class="n">beta_0</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="n">beta_0_v</span><span class="p">[</span><span class="n">beta_0_v</span> <span class="o">&lt;</span> <span class="mf">1e-2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">betaSIA</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;betaSIA&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">betaSIA</span><span class="p">,</span> <span class="n">beta_0_v</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">DOLFIN_EPS</span><span class="p">)</span>
      <span class="n">bc_beta</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">betaSIA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">GAMMA_B_GND</span><span class="p">)</span>
      <span class="n">bc_beta</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">vector</span><span class="p">())</span>
      <span class="c1">#self.assign_variable(self.beta, self.betaSIA)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">betaSIA</span><span class="p">)</span>
    <span class="n">print_min_max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.init_beta_stats"><a class="viewcode-back" href="../model.html#model.Model.init_beta_stats">[docs]</a>  <span class="k">def</span> <span class="nf">init_beta_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdl</span><span class="o">=</span><span class="s1">&#39;Ubar&#39;</span><span class="p">,</span> <span class="n">use_temp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;steady&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    It&#39;s complicated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span>    <span class="o">=</span> <span class="s2">&quot;::: initializing beta from stats :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

    <span class="n">q_geo</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_geo</span>
    <span class="n">T_s</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_surface</span>
    <span class="n">adot</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adot</span>
    <span class="n">Mb</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mb</span>
    <span class="n">Ubar</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ubar</span>
    <span class="n">Q</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span>
    <span class="n">B</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span>
    <span class="n">S</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span>
    <span class="n">T</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span>
    <span class="n">T_s</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_surface</span>
    <span class="n">rho</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhoi</span>
    <span class="n">g</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span>
    <span class="n">H</span>      <span class="o">=</span> <span class="n">S</span> <span class="o">-</span> <span class="n">B</span>

    <span class="n">Ubar_v</span> <span class="o">=</span> <span class="n">Ubar</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="n">Ubar_v</span><span class="p">[</span><span class="n">Ubar_v</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-10</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="n">Ubar</span><span class="p">,</span> <span class="n">Ubar_v</span><span class="p">)</span>

    <span class="n">D</span>      <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
    <span class="n">B_v</span>    <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="n">D_v</span>    <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="n">D_v</span><span class="p">[</span><span class="n">B_v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">B_v</span><span class="p">[</span><span class="n">B_v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">D_v</span><span class="p">)</span>

    <span class="n">gradS</span> <span class="o">=</span> <span class="n">as_vector</span><span class="p">([</span><span class="n">S</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">S</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">gradB</span> <span class="o">=</span> <span class="n">as_vector</span><span class="p">([</span><span class="n">B</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">B</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">gradH</span> <span class="o">=</span> <span class="n">as_vector</span><span class="p">([</span><span class="n">H</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">H</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">])</span>

    <span class="n">nS</span>   <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">inner</span><span class="p">(</span><span class="n">gradS</span><span class="p">,</span> <span class="n">gradS</span><span class="p">)</span> <span class="o">+</span> <span class="n">DOLFIN_EPS</span><span class="p">)</span>
    <span class="n">nB</span>   <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">inner</span><span class="p">(</span><span class="n">gradB</span><span class="p">,</span> <span class="n">gradB</span><span class="p">)</span> <span class="o">+</span> <span class="n">DOLFIN_EPS</span><span class="p">)</span>
    <span class="n">nH</span>   <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">inner</span><span class="p">(</span><span class="n">gradH</span><span class="p">,</span> <span class="n">gradH</span><span class="p">)</span> <span class="o">+</span> <span class="n">DOLFIN_EPS</span><span class="p">)</span>

    <span class="c1">#if mdl == &#39;Ubar&#39;:</span>
    <span class="c1">#  u_x    = -rho * g * H * S.dx(0)</span>
    <span class="c1">#  v_x    = -rho * g * H * S.dx(1)</span>
    <span class="c1">#  U_i    = as_vector([u_x,  v_x, 0.0])</span>
    <span class="c1">#  U_j    = as_vector([v_x, -u_x, 0.0])</span>
    <span class="c1">#elif mdl == &#39;U&#39; or mdl == &#39;U_Ubar&#39;:</span>
    <span class="c1">#  U_i    = as_vector([self.u,  self.v, 0.0])</span>
    <span class="c1">#  U_j    = as_vector([self.v, -self.u, 0.0])</span>
    <span class="n">U_i</span>    <span class="o">=</span> <span class="n">as_vector</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">U_j</span>    <span class="o">=</span> <span class="n">as_vector</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">Umag</span>   <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">inner</span><span class="p">(</span><span class="n">U_i</span><span class="p">,</span><span class="n">U_i</span><span class="p">)</span> <span class="o">+</span> <span class="n">DOLFIN_EPS</span><span class="p">)</span>
    <span class="n">Uhat_i</span> <span class="o">=</span> <span class="n">U_i</span> <span class="o">/</span> <span class="n">Umag</span>
    <span class="n">Uhat_j</span> <span class="o">=</span> <span class="n">U_j</span> <span class="o">/</span> <span class="n">Umag</span>

    <span class="n">dBdi</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">gradB</span><span class="p">,</span> <span class="n">Uhat_i</span><span class="p">)</span>
    <span class="n">dBdj</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">gradB</span><span class="p">,</span> <span class="n">Uhat_j</span><span class="p">)</span>
    <span class="n">dSdi</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">gradS</span><span class="p">,</span> <span class="n">Uhat_i</span><span class="p">)</span>
    <span class="n">dSdj</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">gradS</span><span class="p">,</span> <span class="n">Uhat_j</span><span class="p">)</span>
    <span class="n">dHdi</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">gradH</span><span class="p">,</span> <span class="n">Uhat_i</span><span class="p">)</span>
    <span class="n">dHdj</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">gradH</span><span class="p">,</span> <span class="n">Uhat_j</span><span class="p">)</span>

    <span class="n">ini</span>  <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">rho</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="n">H</span> <span class="o">*</span> <span class="n">nS</span> <span class="o">/</span> <span class="p">(</span><span class="n">Umag</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">))</span>

    <span class="n">x0</span>   <span class="o">=</span> <span class="n">S</span>
    <span class="n">x1</span>   <span class="o">=</span> <span class="n">T_s</span>
    <span class="n">x2</span>   <span class="o">=</span> <span class="n">nS</span>
    <span class="n">x3</span>   <span class="o">=</span> <span class="n">D</span>
    <span class="n">x4</span>   <span class="o">=</span> <span class="n">nB</span>
    <span class="n">x5</span>   <span class="o">=</span> <span class="n">H</span>
    <span class="n">x6</span>   <span class="o">=</span> <span class="n">q_geo</span>
    <span class="n">x7</span>   <span class="o">=</span> <span class="n">adot</span>
    <span class="n">x8</span>   <span class="o">=</span> <span class="n">T</span>
    <span class="n">x9</span>   <span class="o">=</span> <span class="n">Mb</span>
    <span class="n">x10</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
    <span class="n">x11</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span>
    <span class="n">x12</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span>
    <span class="n">x13</span>  <span class="o">=</span> <span class="n">ln</span><span class="p">(</span><span class="n">Ubar</span> <span class="o">+</span> <span class="n">DOLFIN_EPS</span><span class="p">)</span>
    <span class="n">x14</span>  <span class="o">=</span> <span class="n">ln</span><span class="p">(</span><span class="n">Umag</span> <span class="o">+</span> <span class="n">DOLFIN_EPS</span><span class="p">)</span>
    <span class="n">x15</span>  <span class="o">=</span> <span class="n">ini</span>
    <span class="n">x16</span>  <span class="o">=</span> <span class="n">dBdi</span>
    <span class="n">x17</span>  <span class="o">=</span> <span class="n">dBdj</span>
    <span class="n">x18</span>  <span class="o">=</span> <span class="n">dSdi</span>
    <span class="n">x19</span>  <span class="o">=</span> <span class="n">dSdj</span>
    <span class="n">x20</span>  <span class="o">=</span> <span class="n">nH</span>
    <span class="n">x21</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_id</span>
    <span class="n">x22</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_jd</span>
    <span class="n">x23</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_ii</span>
    <span class="n">x24</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_ij</span>
    <span class="n">x25</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_ji</span>
    <span class="n">x26</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_jj</span>

    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;T_s&#39;</span><span class="p">,</span> <span class="s1">&#39;gradS&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;gradB&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;q_geo&#39;</span><span class="p">,</span> <span class="s1">&#39;adot&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Mb&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;ln(Ubar)&#39;</span><span class="p">,</span> <span class="s1">&#39;ln(Umag)&#39;</span><span class="p">,</span> <span class="s1">&#39;ini&#39;</span><span class="p">,</span>
             <span class="s1">&#39;dBdi&#39;</span><span class="p">,</span> <span class="s1">&#39;dBdj&#39;</span><span class="p">,</span> <span class="s1">&#39;dSdi&#39;</span><span class="p">,</span> <span class="s1">&#39;dSdj&#39;</span><span class="p">,</span> <span class="s1">&#39;nablaH&#39;</span><span class="p">,</span> <span class="s1">&#39;tau_id&#39;</span><span class="p">,</span> <span class="s1">&#39;tau_jd&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_ii&#39;</span><span class="p">,</span> <span class="s1">&#39;tau_ij&#39;</span><span class="p">,</span> <span class="s1">&#39;tau_ji&#39;</span><span class="p">,</span> <span class="s1">&#39;tau_jj&#39;</span><span class="p">]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mdl</span> <span class="o">==</span> <span class="s1">&#39;Ubar&#39;</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">use_temp</span><span class="p">:</span>
        <span class="n">X</span>    <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">x5</span><span class="p">,</span><span class="n">x7</span><span class="p">,</span><span class="n">x13</span><span class="p">,</span><span class="n">x16</span><span class="p">,</span><span class="n">x18</span><span class="p">]</span>
        <span class="n">idx</span>  <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">]</span>
        <span class="n">bhat</span> <span class="o">=</span> <span class="p">[</span> <span class="o">-</span><span class="mf">1.01661102e+02</span><span class="p">,</span>   <span class="mf">6.59472291e-03</span><span class="p">,</span>   <span class="mf">8.34479667e-01</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">3.20751595e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.86910058e+00</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.50122785e-01</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.61283407e+01</span><span class="p">,</span>   <span class="mf">3.42099244e+01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.38190017e-07</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">2.42124307e-05</span><span class="p">,</span>   <span class="mf">5.28420031e-08</span><span class="p">,</span>  <span class="o">-</span><span class="mf">5.71485389e-05</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">3.75168897e-06</span><span class="p">,</span>   <span class="mf">6.62615357e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.09616017e-03</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.63919106e-03</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.67468432e-07</span><span class="p">,</span>   <span class="mf">7.70150910e-03</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.06827565e-05</span><span class="p">,</span>   <span class="mf">5.82852747e-02</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.59176855e-01</span><span class="p">,</span>
                  <span class="mf">2.60703978e-08</span><span class="p">,</span>   <span class="mf">1.12176250e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">9.96266233e-07</span><span class="p">,</span>
                  <span class="mf">1.54898171e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">7.75201260e-03</span><span class="p">,</span>  <span class="o">-</span><span class="mf">3.97881378e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">9.66212690e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">6.88656946e-01</span><span class="p">,</span>   <span class="mf">2.86508703e+00</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">4.77406074e-03</span><span class="p">,</span>   <span class="mf">4.46234782e-03</span><span class="p">,</span>  <span class="o">-</span><span class="mf">9.93937326e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.11058398e+01</span><span class="p">,</span>   <span class="mf">1.19703551e+01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">3.46378138e+01</span><span class="p">]</span>
        <span class="c1">#bhat = [ -1.06707322e+02,   6.93681939e-03,   8.72090381e-01,</span>
        <span class="c1">#         -2.05377136e-04,  -1.68695225e+00,  -1.54427603e-01,</span>
        <span class="c1">#         -1.48494954e+01,   3.13320531e+01,  -1.46372911e-07,</span>
        <span class="c1">#         -2.54809386e-05,   5.58213888e-08,  -5.05686875e-05,</span>
        <span class="c1">#         -3.57485925e-06,   6.74423417e-04,  -1.90332998e-03,</span>
        <span class="c1">#         -1.70912922e-03,  -9.14015814e-07,   6.90894685e-03,</span>
        <span class="c1">#          5.38728829e-06,   5.52828014e-02,  -1.49677701e-01,</span>
        <span class="c1">#          2.10321794e-08,   1.26574205e-04,  -1.58804814e-06,</span>
        <span class="c1">#         -1.07066137e-04,  -6.59781673e-03,  -4.21221477e-02,</span>
        <span class="c1">#         -9.11842753e-04,  -5.91089434e-01,   2.37465616e+00,</span>
        <span class="c1">#         -4.79794725e-03,  -1.20787950e-03,  -8.37001425e-02,</span>
        <span class="c1">#         -1.35364012e+01,   2.01047113e+01,  -3.48057200e+01]</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">X</span>    <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">x5</span><span class="p">,</span><span class="n">x7</span><span class="p">,</span><span class="n">x8</span><span class="p">,</span><span class="n">x9</span><span class="p">,</span><span class="n">x13</span><span class="p">,</span><span class="n">x16</span><span class="p">,</span><span class="n">x18</span><span class="p">]</span>
        <span class="n">idx</span>  <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">]</span>
        <span class="n">bhat</span> <span class="o">=</span> <span class="p">[</span>  <span class="mf">1.99093750e+01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">9.37152784e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.53849816e-03</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">2.72682710e-03</span><span class="p">,</span>   <span class="mf">3.11376629e+00</span><span class="p">,</span>  <span class="o">-</span><span class="mf">6.22550705e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">4.78841821e+02</span><span class="p">,</span>   <span class="mf">1.18870083e-01</span><span class="p">,</span>   <span class="mf">1.46462501e+01</span><span class="p">,</span>
                  <span class="mf">4.73228083e+00</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.23039512e-05</span><span class="p">,</span>   <span class="mf">4.80948459e-08</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.75152253e-04</span><span class="p">,</span>   <span class="mf">1.57869882e-05</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.85979092e-03</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">5.31979350e-06</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.94994855e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.88696470e-03</span><span class="p">,</span>
                  <span class="mf">9.87920894e-06</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.67014309e-02</span><span class="p">,</span>   <span class="mf">1.38310308e-05</span><span class="p">,</span>
                  <span class="mf">1.29911016e+00</span><span class="p">,</span>   <span class="mf">8.79462642e-06</span><span class="p">,</span>   <span class="mf">2.58486129e-02</span><span class="p">,</span>
                  <span class="mf">4.59079956e-01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.62460133e-04</span><span class="p">,</span>   <span class="mf">8.39672735e-07</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.44977594e-02</span><span class="p">,</span>   <span class="mf">5.58957555e-07</span><span class="p">,</span>   <span class="mf">7.38625502e-04</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">9.92789432e-03</span><span class="p">,</span>   <span class="mf">6.02766800e-03</span><span class="p">,</span>   <span class="mf">2.74638935e-01</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">7.24036641e-05</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.63126335e-01</span><span class="p">,</span>   <span class="mf">2.92369712e+00</span><span class="p">,</span>
                  <span class="mf">5.07887934e-01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.57929508e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">8.33728342e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">4.71625234e-01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">5.85160316e-02</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.74723504e+01</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.83509536e+01</span><span class="p">,</span>   <span class="mf">5.35514345e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">8.46507380e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.60127263e+01</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">mdl</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">use_temp</span><span class="p">:</span>
        <span class="n">X</span>    <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">x5</span><span class="p">,</span><span class="n">x7</span><span class="p">,</span><span class="n">x14</span><span class="p">,</span><span class="n">x16</span><span class="p">,</span><span class="n">x18</span><span class="p">]</span>
        <span class="n">idx</span>  <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">]</span>
        <span class="n">bhat</span> <span class="o">=</span> <span class="p">[</span> <span class="o">-</span><span class="mf">9.28289389e+01</span><span class="p">,</span>   <span class="mf">5.73687339e-03</span><span class="p">,</span>   <span class="mf">7.33526290e-01</span><span class="p">,</span>
                  <span class="mf">2.76998568e-03</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.08656857e-01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.08545047e+00</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.50267782e+01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">7.04864127e+01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">7.76085391e-08</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">2.17802438e-05</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.99587467e-08</span><span class="p">,</span>   <span class="mf">5.87139196e-05</span><span class="p">,</span>
                  <span class="mf">1.64670170e-05</span><span class="p">,</span>   <span class="mf">1.06212966e-04</span><span class="p">,</span>   <span class="mf">7.11755177e-05</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.37677776e-03</span><span class="p">,</span>  <span class="o">-</span><span class="mf">9.08932836e-06</span><span class="p">,</span>   <span class="mf">3.60621065e-04</span><span class="p">,</span>
                  <span class="mf">2.97118032e-03</span><span class="p">,</span>   <span class="mf">5.50814766e-02</span><span class="p">,</span>   <span class="mf">2.21044611e-01</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.15497725e-07</span><span class="p">,</span>   <span class="mf">8.63993130e-05</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.12395318e-06</span><span class="p">,</span>
                  <span class="mf">7.21699958e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.09346933e-02</span><span class="p">,</span>  <span class="o">-</span><span class="mf">3.12224072e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">2.39690796e-02</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.95080157e-01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">3.40502802e-01</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">2.62000881e-02</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.78157283e-02</span><span class="p">,</span>   <span class="mf">7.19763432e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.94919730e+00</span><span class="p">,</span>  <span class="o">-</span><span class="mf">9.82413027e+00</span><span class="p">,</span>  <span class="o">-</span><span class="mf">7.61245200e+01</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">X</span>    <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">x5</span><span class="p">,</span><span class="n">x7</span><span class="p">,</span><span class="n">x8</span><span class="p">,</span><span class="n">x9</span><span class="p">,</span><span class="n">x14</span><span class="p">,</span><span class="n">x16</span><span class="p">,</span><span class="n">x18</span><span class="p">]</span>
        <span class="n">idx</span>  <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">]</span>
        <span class="n">bhat</span> <span class="o">=</span> <span class="p">[</span>  <span class="mf">2.09623581e+01</span><span class="p">,</span>   <span class="mf">6.66919839e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">7.02196170e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.15080308e-03</span><span class="p">,</span>   <span class="mf">5.34783070e+00</span><span class="p">,</span>  <span class="o">-</span><span class="mf">7.11388758e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">4.07361631e+01</span><span class="p">,</span>   <span class="mf">1.02018632e+00</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.86900651e+01</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">4.20181324e+01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">9.26143019e-06</span><span class="p">,</span>  <span class="o">-</span><span class="mf">7.72058925e-08</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">4.15062408e-05</span><span class="p">,</span>   <span class="mf">7.02170069e-06</span><span class="p">,</span>   <span class="mf">2.70372865e-03</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.37333418e-05</span><span class="p">,</span>   <span class="mf">8.87920333e-05</span><span class="p">,</span>   <span class="mf">1.42938174e-03</span><span class="p">,</span>
                  <span class="mf">7.77557165e-06</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.35402146e-02</span><span class="p">,</span>   <span class="mf">3.04680358e-04</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.71597355e-01</span><span class="p">,</span>   <span class="mf">1.40252311e-04</span><span class="p">,</span>   <span class="mf">4.10097716e-02</span><span class="p">,</span>
                  <span class="mf">2.55567246e-01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.33628767e-07</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.15459028e-06</span><span class="p">,</span>
                  <span class="mf">6.29599393e-05</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.11071912e-05</span><span class="p">,</span>   <span class="mf">1.28619782e-03</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.46657539e-02</span><span class="p">,</span>   <span class="mf">3.09279801e-03</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.27450062e-01</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">7.40025166e-03</span><span class="p">,</span>  <span class="o">-</span><span class="mf">5.06709113e-01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">6.76120111e-01</span><span class="p">,</span>
                  <span class="mf">3.10802402e-01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">5.34552872e-03</span><span class="p">,</span>   <span class="mf">2.19914707e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.40943367e-01</span><span class="p">,</span>   <span class="mf">3.07890125e-01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">9.03508676e+00</span><span class="p">,</span>
                  <span class="mf">8.27529346e+01</span><span class="p">,</span>   <span class="mf">6.60448755e-03</span><span class="p">,</span>   <span class="mf">2.42989633e+00</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">4.31461210e+01</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">mdl</span> <span class="o">==</span> <span class="s1">&#39;U_Ubar&#39;</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">use_temp</span><span class="p">:</span>
        <span class="n">X</span>    <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">x5</span><span class="p">,</span><span class="n">x7</span><span class="p">,</span><span class="n">x13</span><span class="p">,</span><span class="n">x14</span><span class="p">,</span><span class="n">x16</span><span class="p">,</span><span class="n">x18</span><span class="p">]</span>
        <span class="n">idx</span>  <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">]</span>
        <span class="n">bhat</span> <span class="o">=</span> <span class="p">[</span> <span class="o">-</span><span class="mf">9.25221622e+01</span><span class="p">,</span>   <span class="mf">5.70295987e-03</span><span class="p">,</span>   <span class="mf">7.30768422e-01</span><span class="p">,</span>
                  <span class="mf">2.75877006e-03</span><span class="p">,</span>   <span class="mf">7.37861453e-02</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.93985236e-03</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.07390793e+00</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.45320123e+01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">7.18521246e+01</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">7.86411913e-08</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.15769127e-05</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.80926515e-08</span><span class="p">,</span>
                  <span class="mf">5.56842889e-05</span><span class="p">,</span>   <span class="mf">1.28402687e-06</span><span class="p">,</span>   <span class="mf">1.12826733e-05</span><span class="p">,</span>
                  <span class="mf">9.07581727e-05</span><span class="p">,</span>  <span class="o">-</span><span class="mf">7.62357377e-05</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.37165484e-03</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">8.99331396e-06</span><span class="p">,</span>  <span class="o">-</span><span class="mf">3.36292037e-04</span><span class="p">,</span>   <span class="mf">4.24771193e-05</span><span class="p">,</span>
                  <span class="mf">2.97610385e-03</span><span class="p">,</span>   <span class="mf">5.34869351e-02</span><span class="p">,</span>   <span class="mf">2.28993842e-01</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.17987943e-07</span><span class="p">,</span>   <span class="mf">8.26468590e-05</span><span class="p">,</span>   <span class="mf">2.32815553e-06</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">6.66323072e-06</span><span class="p">,</span>   <span class="mf">6.73934903e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.12192482e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">3.22339742e-02</span><span class="p">,</span>  <span class="o">-</span><span class="mf">3.78492901e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.38023512e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">2.88687981e-01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.11715791e-01</span><span class="p">,</span>   <span class="mf">3.06665249e-04</span><span class="p">,</span>
                  <span class="mf">3.29695662e-04</span><span class="p">,</span>   <span class="mf">4.96515338e-03</span><span class="p">,</span>   <span class="mf">1.28914720e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">2.83133687e-02</span><span class="p">,</span>  <span class="o">-</span><span class="mf">3.08127082e-02</span><span class="p">,</span>  <span class="o">-</span><span class="mf">3.19074160e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.60977763e+00</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.10451113e+01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">7.66011531e+01</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">X</span>    <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">x5</span><span class="p">,</span><span class="n">x7</span><span class="p">,</span><span class="n">x8</span><span class="p">,</span><span class="n">x9</span><span class="p">,</span><span class="n">x13</span><span class="p">,</span><span class="n">x14</span><span class="p">,</span><span class="n">x16</span><span class="p">,</span><span class="n">x18</span><span class="p">]</span>
        <span class="n">idx</span>  <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">]</span>
        <span class="n">bhat</span> <span class="o">=</span> <span class="p">[</span>  <span class="mf">1.95228446e+01</span><span class="p">,</span>   <span class="mf">6.59477606e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">6.45139002e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.10071394e-03</span><span class="p">,</span>   <span class="mf">5.13699019e+00</span><span class="p">,</span>  <span class="o">-</span><span class="mf">6.45652015e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">5.14739582e+01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">3.68769001e-03</span><span class="p">,</span>   <span class="mf">9.57519905e-01</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.77507405e+01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.37983921e+01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">9.02491948e-06</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">7.61384926e-08</span><span class="p">,</span>  <span class="o">-</span><span class="mf">3.73066416e-05</span><span class="p">,</span>   <span class="mf">6.79516468e-06</span><span class="p">,</span>
                  <span class="mf">2.83564402e-03</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.68103812e-07</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.20747491e-05</span><span class="p">,</span>
                  <span class="mf">4.00845895e-05</span><span class="p">,</span>   <span class="mf">1.67755582e-03</span><span class="p">,</span>   <span class="mf">7.73371401e-06</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">2.23470170e-02</span><span class="p">,</span>   <span class="mf">2.78775317e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.61211932e-01</span><span class="p">,</span>
                  <span class="mf">4.64633086e-05</span><span class="p">,</span>   <span class="mf">4.37335336e-04</span><span class="p">,</span>   <span class="mf">4.27466758e-02</span><span class="p">,</span>
                  <span class="mf">2.50573113e-01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.81341231e-06</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.31708961e-06</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.68503900e-04</span><span class="p">,</span>   <span class="mf">3.54318161e-06</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.20165147e-05</span><span class="p">,</span>
                  <span class="mf">1.26878513e-03</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.54490818e-02</span><span class="p">,</span>   <span class="mf">2.66749014e-03</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">2.98194766e-01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.92113296e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.31378498e-03</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">4.83721711e-01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">7.30055588e-01</span><span class="p">,</span>   <span class="mf">3.42250813e-01</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">3.22616161e-05</span><span class="p">,</span>  <span class="o">-</span><span class="mf">5.40195432e-03</span><span class="p">,</span>   <span class="mf">1.73408633e-02</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">1.31066469e-01</span><span class="p">,</span>   <span class="mf">9.73640123e-03</span><span class="p">,</span>   <span class="mf">2.61368301e-01</span><span class="p">,</span>
                 <span class="o">-</span><span class="mf">9.93273895e+00</span><span class="p">,</span>   <span class="mf">8.31773699e+01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">5.74031885e-04</span><span class="p">,</span>
                  <span class="mf">9.54289863e-03</span><span class="p">,</span>  <span class="o">-</span><span class="mf">3.57353698e-02</span><span class="p">,</span>   <span class="mf">3.62295735e-03</span><span class="p">,</span>
                  <span class="mf">2.54399352e+00</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.21129483e+01</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">mdl</span> <span class="o">==</span> <span class="s1">&#39;stress&#39;</span><span class="p">:</span>
      <span class="n">X</span>    <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">x5</span><span class="p">,</span><span class="n">x7</span><span class="p">,</span><span class="n">x14</span><span class="p">,</span><span class="n">x16</span><span class="p">,</span><span class="n">x18</span><span class="p">,</span><span class="n">x21</span><span class="p">,</span><span class="n">x23</span><span class="p">,</span><span class="n">x24</span><span class="p">,</span><span class="n">x25</span><span class="p">,</span><span class="n">x26</span><span class="p">]</span>
      <span class="n">idx</span>  <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">]</span>
      <span class="n">bhat</span> <span class="o">=</span> <span class="p">[</span>  <span class="mf">5.47574225e+00</span><span class="p">,</span>   <span class="mf">9.14001489e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.03229081e-03</span><span class="p">,</span>
               <span class="o">-</span><span class="mf">7.04987042e-04</span><span class="p">,</span>   <span class="mf">2.15686223e+00</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.52869679e+00</span><span class="p">,</span>
               <span class="o">-</span><span class="mf">1.74593819e+01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.05459701e+01</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.23768850e-05</span><span class="p">,</span>
                <span class="mf">2.01460255e-05</span><span class="p">,</span>   <span class="mf">1.97622781e-05</span><span class="p">,</span>   <span class="mf">3.68067438e-05</span><span class="p">,</span>
                <span class="mf">6.63468606e-06</span><span class="p">,</span>  <span class="o">-</span><span class="mf">3.69046174e-06</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.47828887e-08</span><span class="p">,</span>
               <span class="o">-</span><span class="mf">3.67070759e-05</span><span class="p">,</span>   <span class="mf">2.53827543e-05</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.88069561e-05</span><span class="p">,</span>
                <span class="mf">2.05942231e-03</span><span class="p">,</span>  <span class="o">-</span><span class="mf">5.95566325e-10</span><span class="p">,</span>   <span class="mf">1.00881255e-09</span><span class="p">,</span>
                <span class="mf">6.11553989e-10</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.11737126e-10</span><span class="p">,</span>   <span class="mf">6.27370976e-10</span><span class="p">,</span>
                <span class="mf">3.42275389e-06</span><span class="p">,</span>  <span class="o">-</span><span class="mf">8.17017771e-03</span><span class="p">,</span>   <span class="mf">4.01803819e-03</span><span class="p">,</span>
                <span class="mf">6.78767571e-02</span><span class="p">,</span>   <span class="mf">4.29444354e-02</span><span class="p">,</span>   <span class="mf">4.45551518e-08</span><span class="p">,</span>
               <span class="o">-</span><span class="mf">8.23509210e-08</span><span class="p">,</span>  <span class="o">-</span><span class="mf">7.90182526e-08</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.48650850e-07</span><span class="p">,</span>
               <span class="o">-</span><span class="mf">2.36138203e-08</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.75130905e-05</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.81655894e-05</span><span class="p">,</span>
                <span class="mf">9.79852186e-04</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.49411705e-02</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.35701903e-10</span><span class="p">,</span>
                <span class="mf">2.32406866e-09</span><span class="p">,</span>   <span class="mf">1.48224703e-09</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.09016625e-09</span><span class="p">,</span>
               <span class="o">-</span><span class="mf">1.31162142e-09</span><span class="p">,</span>   <span class="mf">1.47593911e-02</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.84965301e-01</span><span class="p">,</span>
               <span class="o">-</span><span class="mf">1.62413731e-01</span><span class="p">,</span>   <span class="mf">2.38867744e-07</span><span class="p">,</span>   <span class="mf">2.09579112e-07</span><span class="p">,</span>
                <span class="mf">6.11572155e-07</span><span class="p">,</span>   <span class="mf">1.44891826e-06</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.94537953e-07</span><span class="p">,</span>
               <span class="o">-</span><span class="mf">3.30400642e-01</span><span class="p">,</span>   <span class="mf">7.93664407e-01</span><span class="p">,</span>   <span class="mf">7.76571489e-08</span><span class="p">,</span>
               <span class="o">-</span><span class="mf">1.64476914e-07</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.13414311e-07</span><span class="p">,</span>   <span class="mf">4.75810302e-07</span><span class="p">,</span>
                <span class="mf">2.55787543e-07</span><span class="p">,</span>  <span class="o">-</span><span class="mf">6.37972323e+00</span><span class="p">,</span>  <span class="o">-</span><span class="mf">3.77364196e-06</span><span class="p">,</span>
                <span class="mf">8.65062737e-08</span><span class="p">,</span>   <span class="mf">6.13207853e-06</span><span class="p">,</span>   <span class="mf">8.39233482e-07</span><span class="p">,</span>
               <span class="o">-</span><span class="mf">3.76402983e-06</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.02633500e-05</span><span class="p">,</span>  <span class="o">-</span><span class="mf">7.28788200e-06</span><span class="p">,</span>
               <span class="o">-</span><span class="mf">2.72030382e-05</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.33298507e-05</span><span class="p">,</span>   <span class="mf">1.11838930e-05</span><span class="p">,</span>
                <span class="mf">9.74762098e-14</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.37844072e-14</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.11310490e-13</span><span class="p">,</span>
                <span class="mf">8.91237008e-14</span><span class="p">,</span>   <span class="mf">1.16770903e-13</span><span class="p">,</span>   <span class="mf">5.77230478e-15</span><span class="p">,</span>
               <span class="o">-</span><span class="mf">4.87322338e-14</span><span class="p">,</span>   <span class="mf">9.62949381e-14</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.12122129e-13</span><span class="p">,</span>
                <span class="mf">1.55871983e-13</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">xx</span><span class="p">,</span><span class="n">nam</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="n">idx</span><span class="p">]):</span>
      <span class="n">print_min_max</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">nam</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">X_i</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">X_i</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">xx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">mdl</span> <span class="o">==</span> <span class="s1">&#39;Ubar&#39;</span> <span class="ow">or</span> <span class="n">mdl</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">use_temp</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">i</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
      <span class="k">for</span> <span class="n">yy</span> <span class="ow">in</span> <span class="n">X</span><span class="p">[</span><span class="n">k</span><span class="p">:]:</span>
        <span class="n">X_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xx</span><span class="o">*</span><span class="n">yy</span><span class="p">)</span>

    <span class="c1">#self.beta_f = exp(Constant(bhat[0]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">beta_f</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">bhat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">xx</span><span class="p">,</span><span class="n">bb</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X_i</span><span class="p">,</span> <span class="n">bhat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">beta_f</span> <span class="o">+=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span><span class="o">*</span><span class="n">xx</span>
      <span class="c1">#self.beta_f *= exp(Constant(bb)*xx)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">beta_f</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_f</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1">#if mode == &#39;steady&#39;:</span>
    <span class="c1">#  beta0                   = project(self.beta_f, Q, annotate=False)</span>
    <span class="c1">#  beta0_v                 = beta0.vector().get_local()</span>
    <span class="c1">#  beta0_v[beta0_v &lt; 1e-2] = 1e-2</span>
    <span class="c1">#  self.assign_variable(beta0, beta0_v)</span>
    <span class="c1">#</span>
    <span class="c1">#  self.assign_variable(self.beta, 1e-2)</span>
    <span class="c1">#  bc_beta = DirichletBC(self.Q, beta0, self.ff, self.GAMMA_B_GND)</span>
    <span class="c1">#  bc_beta.apply(self.beta.vector())</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;steady&#39;</span><span class="p">:</span>
      <span class="n">beta0</span>  <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_f</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">annotate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
      <span class="n">beta0_v</span>                 <span class="o">=</span> <span class="n">beta0</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
      <span class="n">beta0_v</span><span class="p">[</span><span class="n">beta0_v</span> <span class="o">&lt;</span> <span class="n">DOLFIN_EPS</span><span class="p">]</span> <span class="o">=</span> <span class="n">DOLFIN_EPS</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">init_beta</span><span class="p">(</span><span class="n">beta0_v</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;transient&#39;</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="mf">200.0</span><span class="p">)</span>

    <span class="n">print_min_max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="s1">&#39;beta_hat&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.update_stats_beta"><a class="viewcode-back" href="../model.html#model.Model.update_stats_beta">[docs]</a>  <span class="k">def</span> <span class="nf">update_stats_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Re-compute the statistical friction field and save into ``self.beta``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span>    <span class="o">=</span> <span class="s2">&quot;::: updating statistical beta :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">D3Model_color</span><span class="p">)</span>
    <span class="n">beta</span>   <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">annotate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">beta_v</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="c1">##betaSIA_v = self.betaSIA.vector().get_local()</span>
    <span class="c1">##beta_v[beta_v &lt; 10.0]   = betaSIA_v[beta_v &lt; 10.0]</span>
    <span class="n">beta_v</span><span class="p">[</span><span class="n">beta_v</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span>    <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1">#beta_v[beta_v &gt; 2500.0] = 2500.0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">beta_v</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.form_energy_dependent_rate_factor"><a class="viewcode-back" href="../model.html#model.Model.form_energy_dependent_rate_factor">[docs]</a>  <span class="k">def</span> <span class="nf">form_energy_dependent_rate_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    formulates energy-dependent rate factor :math:`A`, ``self.A``, from</span>

<span class="sd">    .. math::</span>

<span class="sd">      A(\theta) = a_T E \left( 1 + 181.5 W_f \right) \exp\left(-\frac{Q_T}{RT&#39;} \right),</span>

<span class="sd">    with energy :math:`\theta` defined by ``self.theta``, enhancement</span>
<span class="sd">    factor :math:`E` given by ``self.E``, universal gas constant</span>
<span class="sd">    :math:`R` given by ``self.R``, empirically-constrained water</span>
<span class="sd">    content :math:`W_f = \min\{W, 0.01\}`, energy-dependent flow-parameter</span>

<span class="sd">    .. math::</span>

<span class="sd">      a_T &amp;= \begin{cases}</span>
<span class="sd">               3.985 \times 10^{-13} \hspace{3mm} \text{s}^{-1}\text{Pa}^{-3} &amp; T&#39; &lt; 263.15 \\</span>
<span class="sd">               1.916 \times 10^{3\hphantom{-1}} \hspace{3mm} \text{s}^{-1}\text{Pa}^{-3} &amp; T&#39; \geq 263.15 \\</span>
<span class="sd">             \end{cases},</span>

<span class="sd">    temperature-dependent creep activation energy</span>

<span class="sd">    .. math::</span>

<span class="sd">      Q_T &amp; = \begin{cases}</span>
<span class="sd">                6.00 \times 10^{4} \hspace{3mm} \text{J mol}^{-1} &amp; T&#39; &lt; 263.15 \\</span>
<span class="sd">                1.39 \times 10^{5} \hspace{3mm} \text{J mol}^{-1} &amp; T&#39; \geq 263.15 \\</span>
<span class="sd">              \end{cases},</span>

<span class="sd">    temperature :math:`T` given by ``self.T``, and pressure-adjusted</span>
<span class="sd">    temperature :math:`T&#39;` given by ``self.Tp``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: formulating energy-dependent rate-factor :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

    <span class="n">Tp</span>          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tp</span>
    <span class="n">W</span>           <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span>
    <span class="n">R</span>           <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span>
    <span class="n">E</span>           <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span>
    <span class="n">a_T</span>         <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span> <span class="n">lt</span><span class="p">(</span><span class="n">Tp</span><span class="p">,</span> <span class="mf">263.15</span><span class="p">),</span>  <span class="bp">self</span><span class="o">.</span><span class="n">a_T_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_T_u</span><span class="p">)</span>
    <span class="n">Q_T</span>         <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span> <span class="n">lt</span><span class="p">(</span><span class="n">Tp</span><span class="p">,</span> <span class="mf">263.15</span><span class="p">),</span>  <span class="bp">self</span><span class="o">.</span><span class="n">Q_T_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q_T_u</span><span class="p">)</span>
    <span class="n">W_T</span>         <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span> <span class="n">lt</span><span class="p">(</span><span class="n">W</span><span class="p">,</span>  <span class="mf">0.01</span><span class="p">),</span>    <span class="n">W</span><span class="p">,</span>          <span class="mf">0.01</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">A</span>      <span class="o">=</span> <span class="n">E</span><span class="o">*</span><span class="n">a_T</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">181.25</span><span class="o">*</span><span class="n">W_T</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Q_T</span><span class="o">/</span><span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="n">Tp</span><span class="p">))</span></div>

<div class="viewcode-block" id="Model.calc_eta"><a class="viewcode-back" href="../model.html#model.Model.calc_eta">[docs]</a>  <span class="k">def</span> <span class="nf">calc_eta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epsdot</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates viscosity :math:`\eta`, set to ``self.eta``, given by</span>

<span class="sd">    .. math::</span>

<span class="sd">      \eta(\theta, \mathbf{u}) = \frac{1}{2}A(\theta)^{-\frac{1}{n}} (\dot{\varepsilon}_e(\mathbf{u}) + \dot{\varepsilon}_0)^{\frac{1-n}{n}},</span>

<span class="sd">    for energy :math:`\theta` given by ``self.theta``, flow-rate factor</span>
<span class="sd">    :math:`A` given by ``self.A``, strain-rate regularization</span>
<span class="sd">    :math:`\dot{\varepsilon}_0` given by ``self.eps_reg``, and Glen&#39;s flow</span>
<span class="sd">    parameter :math:`n` given by ``self.n``.</span>

<span class="sd">    :param epsdot: effective-strain rate :math:`\dot{\varepsilon}_e(\mathbf{u})`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span>     <span class="o">=</span> <span class="s2">&quot;::: calculating viscosity :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="n">eps_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps_reg</span>
    <span class="n">A</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span>
    <span class="n">n</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>

    <span class="c1"># calculate viscosity :</span>
    <span class="n">eta</span>     <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">A</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">epsdot</span> <span class="o">+</span> <span class="n">eps_reg</span><span class="p">)</span><span class="o">**</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span></div>

<div class="viewcode-block" id="Model.calc_vert_average"><a class="viewcode-back" href="../model.html#model.Model.calc_vert_average">[docs]</a>  <span class="k">def</span> <span class="nf">calc_vert_average</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the vertical average of the function ``u``.</span>

<span class="sd">    This method must be overwritten by the class inheriting this class.</span>

<span class="sd">    :param u: function to be vertically averaged</span>
<span class="sd">    :rtype:   the resulting vertical average of ``u``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raiseNotDefined</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.calc_normal_vector"><a class="viewcode-back" href="../model.html#model.Model.calc_normal_vector">[docs]</a>  <span class="k">def</span> <span class="nf">calc_normal_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the outward-pointing normal vector as a FEniCS function.</span>
<span class="sd">    This could then be used in any :class:`~dolfin.DirichletBC`.</span>
<span class="sd">    Saved to ``self.n_f``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span>     <span class="o">=</span> <span class="s2">&quot;::: calculating normal-vector function :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

    <span class="n">n</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
    <span class="n">n_trial</span> <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
    <span class="n">n_test</span>  <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">n_trial</span><span class="p">,</span> <span class="n">n_test</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">n</span><span class="p">,</span>       <span class="n">n_test</span><span class="p">)</span><span class="o">*</span><span class="n">ds</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">assemble</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">keep_diagonal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">A</span><span class="o">.</span><span class="n">ident_zeros</span><span class="p">()</span> <span class="c1"># Regularize the matrix</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">assemble</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
    <span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">vector</span><span class="p">(),</span> <span class="n">b</span><span class="p">,</span> <span class="s1">&#39;cg&#39;</span><span class="p">,</span> <span class="s1">&#39;amg&#39;</span><span class="p">)</span>

    <span class="n">area</span> <span class="o">=</span> <span class="n">assemble</span><span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span><span class="o">*</span><span class="n">ds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">))</span>
    <span class="n">nds</span>  <span class="o">=</span> <span class="n">assemble</span><span class="p">(</span><span class="n">inner</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">ds</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;    - average value of normal on boundary: </span><span class="si">%.3f</span><span class="s2"> - &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nds</span> <span class="o">/</span> <span class="n">area</span><span class="p">)</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">init_n_f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.get_xy_velocity_angle"><a class="viewcode-back" href="../model.html#model.Model.get_xy_velocity_angle">[docs]</a>  <span class="k">def</span> <span class="nf">get_xy_velocity_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the angle in radians of the horizontal velocity vector</span>
<span class="sd">    :math:`\mathbf{u}_h = [u\ v]^\intercal` from the x-axis.</span>

<span class="sd">    :param U: horizontal velocity vector :math:`\mathbf{u}_h = [u\ v]^\intercal`</span>
<span class="sd">    :rtype:  :class:`~dolfin.Function` of angle values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">w</span>   <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">u_v</span>     <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="n">v_v</span>     <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="n">theta_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">v_v</span><span class="p">,</span> <span class="n">u_v</span><span class="p">)</span>
    <span class="n">Q</span>       <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span>
    <span class="n">theta</span>   <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;theta_xy_U_angle&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">theta_v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">theta</span></div>

<div class="viewcode-block" id="Model.get_xz_velocity_angle"><a class="viewcode-back" href="../model.html#model.Model.get_xz_velocity_angle">[docs]</a>  <span class="k">def</span> <span class="nf">get_xz_velocity_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the angle in radians of the vertical velocity vector</span>
<span class="sd">    :math:`\mathbf{u}_v = [u\ w]^\intercal` from the x-axis.</span>

<span class="sd">    :param U: vertical velocity vector :math:`\mathbf{u}_v = [u\ w]^\intercal`</span>
<span class="sd">    :rtype:  :class:`~dolfin.Function` of angle values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">w</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U3</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">u_v</span>     <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="n">w_v</span>     <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
    <span class="n">theta_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">w_v</span><span class="p">,</span> <span class="n">u_v</span><span class="p">)</span>
    <span class="n">theta</span>   <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;theta_xz_U_angle&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">theta_v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">theta</span></div>

<div class="viewcode-block" id="Model.z_rotation_matrix"><a class="viewcode-back" href="../model.html#model.Model.z_rotation_matrix">[docs]</a>  <span class="k">def</span> <span class="nf">z_rotation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Form the rotation matrix :math:`R_z` about the :math:`z` axes</span>
<span class="sd">    by angle ``theta``.</span>

<span class="sd">    :param theta: angle in radians to rotate about the :math:`z`-axis</span>
<span class="sd">    :rtype:       :class:`~dolfin.Matrix` :math:`R_z`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c</span>  <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">s</span>  <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">Rz</span> <span class="o">=</span> <span class="n">as_matrix</span><span class="p">([[</span><span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">s</span><span class="p">,</span>  <span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">Rz</span></div>

<div class="viewcode-block" id="Model.y_rotation_matrix"><a class="viewcode-back" href="../model.html#model.Model.y_rotation_matrix">[docs]</a>  <span class="k">def</span> <span class="nf">y_rotation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Form the rotation matrix :math:`R_y` about the :math:`y` axes</span>
<span class="sd">    by angle ``theta``.</span>

<span class="sd">    :param theta: angle in radians to rotate about the :math:`y`-axis</span>
<span class="sd">    :rtype:       :class:`~dolfin.Matrix` :math:`R_y`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c</span>  <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">s</span>  <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">Ry</span> <span class="o">=</span> <span class="n">as_matrix</span><span class="p">([[</span> <span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">],</span>
                    <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="o">-</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">Ry</span></div>

<div class="viewcode-block" id="Model.rotate_tensor"><a class="viewcode-back" href="../model.html#model.Model.rotate_tensor">[docs]</a>  <span class="k">def</span> <span class="nf">rotate_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rotate the tnesor ``M`` by the rotation matrix ``R``.</span>

<span class="sd">    if ``M`` is a rank-two tensor,</span>

<span class="sd">    .. math::</span>

<span class="sd">      M_r = R \cdot M \cdot R</span>

<span class="sd">    if ``M`` is a rank-one tensor,</span>

<span class="sd">    .. math::</span>

<span class="sd">      M_r = R \cdot M</span>

<span class="sd">    :param M:     :class:`~dolfin.Matrix` or :class:`~dolfin.Tensor` to be</span>
<span class="sd">                  rotated</span>
<span class="sd">    :param R:     rotation :class:`~dolfin.Matrix` or :class:`~dolfin.Tensor`</span>
<span class="sd">    :rtype:       rotated matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">ufl_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">Mr</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">ufl_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">Mr</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">s</span>   <span class="o">=</span> <span class="s2">&quot;&gt;&gt;&gt; METHOD &#39;rotate_tensor&#39; REQUIRES RANK 2 OR 1 TENSOR &lt;&lt;&lt;&quot;</span>
      <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Mr</span></div>

<div class="viewcode-block" id="Model.get_norm"><a class="viewcode-back" href="../model.html#model.Model.get_norm">[docs]</a>  <span class="k">def</span> <span class="nf">get_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate and return the norm of and the normalized vector</span>
<span class="sd">    :math:`\hat{\mathbf{u}}`, of the vector :math:`\mathbf{u}`</span>
<span class="sd">    given by parameter ``U``.</span>
<span class="sd">    The parameter ``kind`` may be either ``l2`` for the :math:`L^2`</span>
<span class="sd">    norm or ``linf`` for the :math:`L^{\infty}` norm</span>

<span class="sd">    :param U:    :class:`~fencics.GenericVector`, list, or tuple of vector</span>
<span class="sd">                 components</span>
<span class="sd">    :param kind: string</span>
<span class="sd">    :rtype:      tuple containing (:math:`\hat{\mathbf{u}}`,</span>
<span class="sd">                                   :math:`\Vert \mathbf{u} \Vert`)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># iterate through each component and convert to array :</span>
    <span class="n">U_v</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># TODO: this can be done without split :</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">indexed</span><span class="o">.</span><span class="n">Indexed</span><span class="p">:</span>
      <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">U</span><span class="p">:</span>
      <span class="c1"># convert to array and normailze the components of U :</span>
      <span class="n">u_v</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
      <span class="n">U_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u_v</span><span class="p">)</span>
    <span class="n">U_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">U_v</span><span class="p">)</span>

    <span class="c1"># calculate the norm :</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;l2&#39;</span><span class="p">:</span>
      <span class="n">norm_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">U_v</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;linf&#39;</span><span class="p">:</span>
      <span class="n">norm_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">U_v</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">U_v</span><span class="p">,</span> <span class="n">norm_u</span></div>

<div class="viewcode-block" id="Model.normalize_vector"><a class="viewcode-back" href="../model.html#model.Model.normalize_vector">[docs]</a>  <span class="k">def</span> <span class="nf">normalize_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a normalized vector of the vector :math:`\mathbf{u}`</span>
<span class="sd">    given by parameter ``U``.</span>

<span class="sd">    :param U:    :class:`~fencics.GenericVector`, list, or tuple of vector</span>
<span class="sd">                 components</span>
<span class="sd">    :rtype:      normalized :class:`~dolfin.GenericVector`</span>
<span class="sd">                 :math:`\hat{\mathbf{u}}` of :math:`\mathbf{u}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span>   <span class="o">=</span> <span class="s2">&quot;::: normalizing vector :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

    <span class="n">Q</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span>

    <span class="n">U_v</span><span class="p">,</span> <span class="n">norm_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_norm</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>

    <span class="n">norm_u</span><span class="p">[</span><span class="n">norm_u</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-15</span>

    <span class="c1"># normalize the vector :</span>
    <span class="n">U_v</span> <span class="o">/=</span> <span class="n">norm_u</span>

    <span class="c1"># convert back to dolfin :</span>
    <span class="n">U_f</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">u_v</span> <span class="ow">in</span> <span class="n">U_v</span><span class="p">:</span>
      <span class="n">u_f</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;u_f&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="n">u_f</span><span class="p">,</span> <span class="n">u_v</span><span class="p">)</span>
      <span class="n">U_f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u_f</span><span class="p">)</span>

    <span class="c1"># return a UFL vector :</span>
    <span class="k">return</span> <span class="n">as_vector</span><span class="p">(</span><span class="n">U_f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.assign_submesh_variable"><a class="viewcode-back" href="../model.html#model.Model.assign_submesh_variable">[docs]</a>  <span class="k">def</span> <span class="nf">assign_submesh_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u_to</span><span class="p">,</span> <span class="n">u_from</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assign the values from the function ``u_from`` to the function ``u_to``,</span>
<span class="sd">    where ``u_from`` and ``u_to`` are defined over non-identical meshes.</span>

<span class="sd">    :param u_to:    :class:`~dolfin.Function` or :class:`~dolfin.GenericVector`</span>
<span class="sd">                    to assign to</span>
<span class="sd">    :param u_from: :class:`~dolfin.Function` or :class:`~dolfin.GenericVector`</span>
<span class="sd">                   to assign from</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span>   <span class="o">=</span> <span class="s2">&quot;::: assigning submesh variable :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="n">lg</span> <span class="o">=</span> <span class="n">LagrangeInterpolator</span><span class="p">()</span>
    <span class="n">lg</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">u_to</span><span class="p">,</span> <span class="n">u_from</span><span class="p">)</span>
    <span class="n">print_min_max</span><span class="p">(</span><span class="n">u_from</span><span class="p">,</span> <span class="s1">&#39;u_from : &#39;</span> <span class="o">+</span> <span class="n">u_from</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">print_min_max</span><span class="p">(</span><span class="n">u_to</span><span class="p">,</span>   <span class="s1">&#39;u_to   : &#39;</span> <span class="o">+</span> <span class="n">u_to</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.assign_variable"><a class="viewcode-back" href="../model.html#model.Model.assign_variable">[docs]</a>  <span class="k">def</span> <span class="nf">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">annotate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manually assign the values from ``var`` to ``u``.  The parameter ``var``</span>
<span class="sd">    may be a string pointing to the location of an :class:`~dolfin.XDMFFile`,</span>
<span class="sd">    :class:`~dolfin.HDF5File`, or an xml file.</span>

<span class="sd">    :param u:        FEniCS :class:`~dolfin.Function` assigning to</span>
<span class="sd">    :param var:      value assigning from</span>
<span class="sd">    :param annotate: allow Dolfin-Adjoint annotation</span>
<span class="sd">    :type var:       float, int, :class:`~dolfin.Expression`,</span>
<span class="sd">                     :class:`~dolfin.Constant`, :class:`~dolfin.GenericVector`,</span>
<span class="sd">                     string, :class:`~dolfin.HDF5File`</span>
<span class="sd">    :type u:         :class:`~dolfin.Function`, :class:`~dolfin.GenericVector`,</span>
<span class="sd">                     :class:`~dolfin.Constant`, float, int</span>
<span class="sd">    :type annotate:  bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span>  <span class="c1"># for printing</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
      <span class="k">if</span>    <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">GenericVector</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">Function</span><span class="p">)</span> \
         <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>
        <span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">()[:]</span> <span class="o">=</span> <span class="n">var</span>
      <span class="k">elif</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
        <span class="n">u</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
      <span class="k">elif</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">var</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
      <span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">set_local</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
      <span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="s1">&#39;insert&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span> \
      <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span>  \
      <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">constant</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span> \
      <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">Function</span><span class="p">)</span> \
      <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span> \
      <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">GenericVector</span><span class="p">):</span>
      <span class="n">u</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">annotate</span><span class="o">=</span><span class="n">annotate</span><span class="p">)</span>
      <span class="c1">#u.interpolate(var, annotate=annotate)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
      <span class="n">File</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">u</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">HDF5File</span><span class="p">):</span>
      <span class="n">var</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">s</span> <span class="o">=</span>  <span class="s2">&quot;*************************************************************</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
           <span class="s2">&quot;assign_variable() function requires a Function, array, float,</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
           <span class="s2">&quot; int, Vector, Expression, Constant, or string path to .xml,</span><span class="se">\n</span><span class="s2">&quot;</span>   <span class="o">+</span> \
           <span class="s2">&quot;not </span><span class="si">%s</span><span class="s2">.  Replacing object entirely</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
           <span class="s2">&quot;*************************************************************&quot;</span>
      <span class="n">print_text</span><span class="p">(</span><span class="n">s</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">u</span> <span class="o">=</span> <span class="n">var</span>
    <span class="n">print_min_max</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">cls</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.save_hdf5"><a class="viewcode-back" href="../output.html#model.Model.save_hdf5">[docs]</a>  <span class="k">def</span> <span class="nf">save_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a :class:`~dolfin.Function` ``u`` to the .h5 file ``f`` in the</span>
<span class="sd">    ``hdf5`` subdirectory of ``self.out_dir``.  If ``name`` = ``None``,</span>
<span class="sd">    this will save the flie under ``u.name()``.</span>

<span class="sd">    :param u: the function to save</span>
<span class="sd">    :param f: the file to save to</span>
<span class="sd">    :type f:  :class:`~dolfin.HDF5File`</span>
<span class="sd">    :type u:  :class:`~dolfin.Constant`, :class:`~dolfin.Function`, or</span>
<span class="sd">              :class:`~dolfin.GenericVector`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: writing &#39;</span><span class="si">%s</span><span class="s2">&#39; variable to hdf5 file :::&quot;</span> <span class="o">%</span> <span class="n">name</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span><span class="c1">#cls=self.this)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">print_text</span><span class="p">(</span><span class="s2">&quot;    - done -&quot;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span><span class="c1">#cls=self.this)</span></div>

<div class="viewcode-block" id="Model.save_xdmf"><a class="viewcode-back" href="../output.html#model.Model.save_xdmf">[docs]</a>  <span class="k">def</span> <span class="nf">save_xdmf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a :class:`~dolfin.XDMFFile` with name ``name`` of the</span>
<span class="sd">    :class:`~dolfin.Function` ``u`` to the ``xdmf`` directory specified by</span>
<span class="sd">    ``self.out_dir``.</span>

<span class="sd">    If ``f`` is a :class:`~dolfin.XDMFFile` object, save to this instead.</span>

<span class="sd">    If ``t`` is a float or an int, mark the file with the timestep ``t``.</span>

<span class="sd">    :param u:    the function to save</span>
<span class="sd">    :param name: the name of the .xdmf file to save</span>
<span class="sd">    :param f:    the file to save to</span>
<span class="sd">    :param t:    the timestep to mark the file with</span>
<span class="sd">    :type f:     :class:`~dolfin.XDMFFile`</span>
<span class="sd">    :type u:     :class:`~dolfin.Function` or :class:`~dolfin.GenericVector`</span>
<span class="sd">    :type t:     int or float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">s</span>       <span class="o">=</span> <span class="s2">&quot;::: saving </span><span class="si">%s</span><span class="s2">.xdmf file :::&quot;</span> <span class="o">%</span> <span class="n">name</span>
      <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span><span class="c1">#cls=self.this)</span>
      <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
      <span class="n">s</span>       <span class="o">=</span> <span class="s2">&quot;::: saving </span><span class="si">%s</span><span class="s2">xdmf/</span><span class="si">%s</span><span class="s2">.xdmf file :::&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
      <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span><span class="c1">#cls=self.this)</span>
      <span class="n">f</span> <span class="o">=</span> <span class="n">XDMFFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">+</span> <span class="s1">&#39;xdmf/&#39;</span> <span class="o">+</span>  <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.xdmf&#39;</span><span class="p">)</span>
      <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">u</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.save_matlab"><a class="viewcode-back" href="../output.html#model.Model.save_matlab">[docs]</a>  <span class="k">def</span> <span class="nf">save_matlab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create Matlab version 4 file output of regular gridded data contained by</span>
<span class="sd">    ``f``.  Currently, this function only works for 2D :math:`x,y`-plane data.</span>

<span class="sd">    :param u:  a :class:`~dolfin.Function`, to be mapped onto the regular</span>
<span class="sd">               grid used by ``di``</span>
<span class="sd">    :param di: a :class:`~inputoutput.DataInput` object</span>
<span class="sd">    :param filename: filename to save as</span>
<span class="sd">    :param val:      value to make values outside of mesh, default :math:`e`</span>
<span class="sd">    :type u:         :class:`~dolfin.Function` or :class:`~dolfin.GenericVector`</span>
<span class="sd">    :type filename:  string</span>
<span class="sd">    :type val:       float</span>
<span class="sd">    :rtype:          MatLab file ``&lt;self.out_dir&gt;/matlab/&lt;filename&gt;.mat``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fa</span>   <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="n">di</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">s</span>    <span class="o">=</span> <span class="s2">&quot;::: writing </span><span class="si">%i</span><span class="s2"> x </span><span class="si">%i</span><span class="s2"> matlab matrix file </span><span class="si">%s</span><span class="s2">.mat :::&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">s</span> <span class="o">%</span> <span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="n">di</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;allow_extrapolation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">geometric_dimension</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">x</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">y</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">fa</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
          <span class="n">fa</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="n">print_min_max</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;matrix&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">+</span> <span class="s1">&#39;matlab/&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span>
    <span class="n">savemat</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;map_data&#39;</span>          <span class="p">:</span> <span class="n">fa</span><span class="p">,</span>
                      <span class="s1">&#39;continent&#39;</span>         <span class="p">:</span> <span class="n">di</span><span class="o">.</span><span class="n">cont</span><span class="p">,</span>
                      <span class="s1">&#39;nx&#39;</span>                <span class="p">:</span> <span class="n">di</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span>
                      <span class="s1">&#39;ny&#39;</span>                <span class="p">:</span> <span class="n">di</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span>
                      <span class="s1">&#39;map_eastern_edge&#39;</span>  <span class="p">:</span> <span class="n">di</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span>
                      <span class="s1">&#39;map_western_edge&#39;</span>  <span class="p">:</span> <span class="n">di</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span>
                      <span class="s1">&#39;map_northern_edge&#39;</span> <span class="p">:</span> <span class="n">di</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span>
                      <span class="s1">&#39;map_southern_edge&#39;</span> <span class="p">:</span> <span class="n">di</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span>
                      <span class="s1">&#39;map_name&#39;</span>          <span class="p">:</span> <span class="n">outfile</span><span class="p">,</span>
                      <span class="s1">&#39;projection&#39;</span>        <span class="p">:</span> <span class="n">di</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">srs</span><span class="p">})</span></div>

<div class="viewcode-block" id="Model.save_list_to_hdf5"><a class="viewcode-back" href="../output.html#model.Model.save_list_to_hdf5">[docs]</a>  <span class="k">def</span> <span class="nf">save_list_to_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lst</span><span class="p">,</span> <span class="n">h5File</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    save a list of functions or coefficients ``lst`` to hdf5 file ``h5File``.</span>

<span class="sd">    :param lst:    list</span>
<span class="sd">    :param h5File: the file to save to</span>
<span class="sd">    :type h5File:  :class:`~dolfin.HDF5File`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span>    <span class="o">=</span> <span class="s1">&#39;::: saving variables in list arg post_tmc_save_vars :::&#39;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save_hdf5</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">h5File</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.save_subdomain_data"><a class="viewcode-back" href="../output.html#model.Model.save_subdomain_data">[docs]</a>  <span class="k">def</span> <span class="nf">save_subdomain_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5File</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the subdomain ``self.ff``, ``self.ff_acc``, and ``self.cf``</span>
<span class="sd">    to hd5f file ``h5File``.</span>

<span class="sd">    :param h5File: the file to save to</span>
<span class="sd">    :type h5File: :class:`~dolfin.HDF5File`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: writing &#39;ff&#39; FacetFunction to supplied hdf5 file :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">h5File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="p">,</span>     <span class="s1">&#39;ff&#39;</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: writing &#39;ff_acc&#39; FacetFunction to supplied hdf5 file :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">h5File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ff_acc</span><span class="p">,</span> <span class="s1">&#39;ff_acc&#39;</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: writing &#39;cf&#39; CellFunction to supplied hdf5 file :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">h5File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cf</span><span class="p">,</span>     <span class="s1">&#39;cf&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.save_mesh"><a class="viewcode-back" href="../output.html#model.Model.save_mesh">[docs]</a>  <span class="k">def</span> <span class="nf">save_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5File</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    save the mesh ``self.mesh`` to :class:`~dolfin.HDF5File` ``h5File``.</span>

<span class="sd">    :param h5File: the file to save to</span>
<span class="sd">    :type h5File:  :class:`~dolfin.HDF5File`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: writing &#39;mesh&#39; to supplied hdf5 file :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="n">h5File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;mesh&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.solve_hydrostatic_pressure"><a class="viewcode-back" href="../model.html#model.Model.solve_hydrostatic_pressure">[docs]</a>  <span class="k">def</span> <span class="nf">solve_hydrostatic_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve for the hydrostatic pressure :math:`p = f_c = \rho g (S - z)` to</span>
<span class="sd">    ``self.p``, with surface height :math:`S` given by ``self.S``, ice</span>
<span class="sd">    density :math:`\rho` given by ``self.rho``, and :math:`z`-coordinate</span>
<span class="sd">    given by ``self.x[2]``.</span>

<span class="sd">    :param annotate: allow Dolfin-Adjoint annotation of this procedure.</span>
<span class="sd">    :type annotate: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raiseNotDefined</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.initialize_variables"><a class="viewcode-back" href="../model.html#model.Model.initialize_variables">[docs]</a>  <span class="k">def</span> <span class="nf">initialize_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the model variables to default values.  The variables</span>
<span class="sd">    defined here are:</span>

<span class="sd">    Coordinates of various types :</span>

<span class="sd">    * ``self.x``   -- :class:`~dolfin.SpatialCoordinate` for ``self.mesh``</span>
<span class="sd">    * ``self.h``   -- :class:`~dolfin.CellDiameter` for ``self.mesh``</span>
<span class="sd">    * ``self.N``   -- :class:`~dolfin.FacetNormal` for ``self.mesh``</span>
<span class="sd">    * ``self.lat`` -- latitude :class:`~dolfin.Function`</span>
<span class="sd">    * ``self.lon`` -- longitude :class:`~dolfin.Function`</span>
<span class="sd">    * ``self.n_f`` -- outward-pointing normal :class:`~dolfin.Function`</span>

<span class="sd">    Time step :</span>

<span class="sd">    * ``self.time_step`` -- the time step for transients</span>

<span class="sd">    Masks :</span>

<span class="sd">    * ``self.mask``      -- shelf mask (1 if grounded, 2 if shelf)</span>
<span class="sd">    * ``self.U_mask``    -- velocity mask (1 if velocity measurements present)</span>

<span class="sd">    Topography :</span>

<span class="sd">    * ``self.S``         -- atmospheric surface</span>
<span class="sd">    * ``self.B``         -- basal surface</span>

<span class="sd">    Velocity observations :</span>

<span class="sd">    * ``self.U_ob``      -- observed horizontal velocity vector</span>
<span class="sd">    * ``self.u_ob``      -- :math:`x`-compoenent of observed velocity</span>
<span class="sd">    * ``self.v_ob``      -- :math:`y`-compoenent of observed velocity</span>

<span class="sd">    Modeled velocity :</span>

<span class="sd">    * ``self.U_mag``     -- velocity vector magnitude</span>
<span class="sd">    * ``self.U3``        -- velocity vector</span>
<span class="sd">    * ``self.u``         -- :math:`x`-component of velocity vector</span>
<span class="sd">    * ``self.v``         -- :math:`y`-component of velocity vector</span>
<span class="sd">    * ``self.w``         -- :math:`z`-component of velocity vector</span>

<span class="sd">    Momentum :</span>

<span class="sd">    * ``self.eta``       -- viscosity</span>
<span class="sd">    * ``self.p``         -- pressure</span>
<span class="sd">    * ``self.beta``      -- basal traction</span>
<span class="sd">    * ``self.E``         -- enhancement factor</span>
<span class="sd">    * ``self.A``         -- flow-rate factor</span>
<span class="sd">    * ``self.u_lat``     -- :math:`x`-component velocity lateral b.c.</span>
<span class="sd">    * ``self.v_lat``     -- :math:`y`-component velocity lateral b.c.</span>
<span class="sd">    * ``self.w_lat``     -- :math:`z`-component velocity lateral b.c.</span>

<span class="sd">    Energy :</span>

<span class="sd">    * ``self.T``         -- temperature</span>
<span class="sd">    * ``self.Tp``        -- pressure-adjusted temperature</span>
<span class="sd">    * ``self.q_geo``     -- geothermal heat flux</span>
<span class="sd">    * ``self.q_fric``    -- frictional heat flux</span>
<span class="sd">    * ``self.gradT_B``   -- temperature gradient at the bed</span>
<span class="sd">    * ``self.gradTm_B``  -- temperature-melting gradient at the bed</span>
<span class="sd">    * ``self.theta``     -- internal energy</span>
<span class="sd">    * ``self.W``         -- water content</span>
<span class="sd">    * ``self.Wc``        -- maximum allowed water content</span>
<span class="sd">    * ``self.Mb``        -- basal-melt rate</span>
<span class="sd">    * ``self.rhob``      -- bulk density</span>
<span class="sd">    * ``self.T_melt``    -- temperature melting point</span>
<span class="sd">    * ``self.theta_melt``-- energy melting point</span>
<span class="sd">    * ``self.T_surface`` -- surface temperature b.c.</span>
<span class="sd">    * ``self.alpha``     -- temperate zone marker</span>
<span class="sd">    * ``self.alpha_int`` -- vertically integrated temperate zone marker</span>
<span class="sd">    * ``self.Fb``        -- basal-water discharge</span>
<span class="sd">    * ``self.PE``        -- grid Peclet number</span>
<span class="sd">    * ``self.Wbar``      -- vertical average of water content</span>
<span class="sd">    * ``self.Fb_min``    -- lower bound on ``self.Fb``</span>
<span class="sd">    * ``self.Fb_max``    -- upper bound on ``self.Fb``</span>
<span class="sd">    * ``self.Qbar``      -- vertically-integrated strain heat</span>
<span class="sd">    * ``self.temp_rat``  -- ratio of column that is temperate</span>
<span class="sd">    * ``self.k_0``       -- non-advective water-flux coefficient</span>

<span class="sd">    Adjoint :</span>

<span class="sd">    * ``self.control_opt`` -- control parameter for momentum optimization</span>

<span class="sd">    Balance Velocity :</span>

<span class="sd">    * ``self.adot``      -- accumulation/ablation function</span>
<span class="sd">    * ``self.d_x``       -- :math:`x`-component of flow direction</span>
<span class="sd">    * ``self.d_y``       -- :math:`y`-component of flow direction</span>
<span class="sd">    * ``self.Ubar``      -- balance velocity magnitude</span>
<span class="sd">    * ``self.uhat``      -- :math:`x`-component of normalized flow direction</span>
<span class="sd">    * ``self.vhat``      -- :math:`y`-component of normalized flow direction</span>

<span class="sd">    Stress-balance :</span>

<span class="sd">    * ``self.M_ii``      -- membrane-stress balance :math:`M_{ii}`</span>
<span class="sd">    * ``self.M_ij``      -- membrane-stress balance :math:`M_{ij}`</span>
<span class="sd">    * ``self.M_iz``      -- membrane-stress balance :math:`M_{iz}`</span>
<span class="sd">    * ``self.M_ji``      -- membrane-stress balance :math:`M_{ji}`</span>
<span class="sd">    * ``self.M_jj``      -- membrane-stress balance :math:`M_{jj}`</span>
<span class="sd">    * ``self.M_jz``      -- membrane-stress balance :math:`M_{jz}`</span>
<span class="sd">    * ``self.M_zi``      -- membrane-stress balance :math:`M_{zi}`</span>
<span class="sd">    * ``self.M_zj``      -- membrane-stress balance :math:`M_{zj}`</span>
<span class="sd">    * ``self.M_zz``      -- membrane-stress balance :math:`M_{zz}`</span>
<span class="sd">    * ``self.N_ii``      -- membrane-stress :math:`N_{ii}`</span>
<span class="sd">    * ``self.N_ij``      -- membrane-stress :math:`N_{ij}`</span>
<span class="sd">    * ``self.N_iz``      -- membrane-stress :math:`N_{iz}`</span>
<span class="sd">    * ``self.N_ji``      -- membrane-stress :math:`N_{ji}`</span>
<span class="sd">    * ``self.N_jj``      -- membrane-stress :math:`N_{jj}`</span>
<span class="sd">    * ``self.N_jz``      -- membrane-stress :math:`N_{jz}`</span>
<span class="sd">    * ``self.N_zi``      -- membrane-stress :math:`N_{zi}`</span>
<span class="sd">    * ``self.N_zj``      -- membrane-stress :math:`N_{zj}`</span>
<span class="sd">    * ``self.N_zz``      -- membrane-stress :math:`N_{zz}`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: initializing basic variables :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

    <span class="c1"># Coordinates of various types</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x</span>             <span class="o">=</span> <span class="n">SpatialCoordinate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">h</span>             <span class="o">=</span> <span class="n">CellDiameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">N</span>             <span class="o">=</span> <span class="n">FacetNormal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lat</span>           <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lat&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lon</span>           <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_f</span>           <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;n_f&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span>         <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sigma&#39;</span><span class="p">)</span>

    <span class="c1"># time step :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">100.0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;time_step&#39;</span><span class="p">,</span> <span class="s1">&#39;time step&#39;</span><span class="p">)</span>

    <span class="c1"># shelf mask (2 if shelf) :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mask</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">)</span>

    <span class="c1"># velocity mask (1 if velocity measurements present) :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">U_mask</span>        <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;U_mask&#39;</span><span class="p">)</span>

    <span class="c1"># topography :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">S</span>             <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;S&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">B</span>             <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">B_err</span>         <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;B_err&#39;</span><span class="p">)</span>

    <span class="c1"># velocity observations :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">U_ob</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;U_ob&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">u_ob</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;u_ob&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">v_ob</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;v_ob&#39;</span><span class="p">)</span>

    <span class="c1"># unified velocity (non-periodic because it is always known everywhere) :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">U_mag</span>         <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;U_mag&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">U3</span>            <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q3_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;U3&#39;</span><span class="p">)</span>
    <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">w</span>              <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U3</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">u</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">v</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">w</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">u</span>             <span class="o">=</span> <span class="n">u</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">v</span>             <span class="o">=</span> <span class="n">v</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">w</span>             <span class="o">=</span> <span class="n">w</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assx</span>  <span class="o">=</span> <span class="n">FunctionAssigner</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assy</span>  <span class="o">=</span> <span class="n">FunctionAssigner</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assz</span>  <span class="o">=</span> <span class="n">FunctionAssigner</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">)</span>

    <span class="c1"># momentum :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">eta</span>           <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;eta&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span>             <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;beta&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">E</span>             <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">A</span>             <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">u_lat</span>         <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;u_lat&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">v_lat</span>         <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;v_lat&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">w_lat</span>         <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;w_lat&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lam</span>           <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lam&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">vector</span><span class="p">()[:]</span> <span class="o">=</span> <span class="mf">1.0</span>    <span class="c1"># always use init. with no flow enhancement</span>

    <span class="c1"># mass :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">adot</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;adot&#39;</span><span class="p">)</span>  <span class="c1"># upper smb</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dSdt</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dSdt&#39;</span><span class="p">)</span>

    <span class="c1"># energy :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">T</span>             <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Tp</span>            <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Tp&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">q_geo</span>         <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;q_geo&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">q_fric</span>        <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;q_fric&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradT_B</span>       <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;gradT_B&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gradTm_B</span>      <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;gradTm_B&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">theta</span>         <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;theta&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">W</span>             <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;W&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">W0</span>            <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;W0&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Wc</span>            <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Wc&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Mb</span>            <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Mb&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rhob</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;rhob&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">T_melt</span>        <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;T_melt&#39;</span><span class="p">)</span>     <span class="c1"># pressure-melting</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">theta_melt</span>    <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;theta_melt&#39;</span><span class="p">)</span> <span class="c1"># pressure-melting</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">T_surface</span>     <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;T_surface&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">theta_surface</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;theta_surface&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">theta_float</span>   <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;theta_float&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">theta_app</span>     <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;theta_app&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>         <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;alpha&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">alpha_int</span>     <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;alpha_int&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Fb</span>            <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Fb&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">PE</span>            <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;PE&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Wbar</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Wbar&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Fb_min</span>        <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Fb_min&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Fb_max</span>        <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Fb_max&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Qbar</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Qbar&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">temp_rat</span>      <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;temp_rat&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">k_0</span>           <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span>    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;k_0&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">k_0</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;k_0&#39;</span><span class="p">,</span> <span class="s1">&#39;k_0&#39;</span><span class="p">)</span>

    <span class="c1"># always initialize the bulk density :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhob</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhoi</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

    <span class="c1"># adjoint :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">control_opt</span>   <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;control_opt&#39;</span><span class="p">)</span>

    <span class="c1"># balance Velocity :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">d_x</span>           <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;d_x&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">d_y</span>           <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;d_y&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Ubar</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Ubar&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">uhat</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;uhat&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vhat</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;vhat&#39;</span><span class="p">)</span>

    <span class="c1"># Stress-balance (this is always non-periodic) :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">M_ii</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;M_ii&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">M_ij</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;M_ij&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">M_iz</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;M_iz&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">M_ji</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;M_ji&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">M_jj</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;M_jj&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">M_jz</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;M_jz&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">M_zi</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;M_zi&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">M_zj</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;M_zj&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">M_zz</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;M_zz&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">N_ii</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;N_ii&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">N_ij</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;N_ij&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">N_iz</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;N_iz&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">N_ji</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;N_ji&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">N_jj</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;N_jj&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">N_jz</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;N_jz&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">N_zi</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;N_zi&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">N_zj</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;N_zj&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">N_zz</span>          <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_non_periodic</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;N_zz&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.home_rolled_newton_method"><a class="viewcode-back" href="../model.html#model.Model.home_rolled_newton_method">[docs]</a>  <span class="k">def</span> <span class="nf">home_rolled_newton_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">bcs</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
                                <span class="n">relaxation_param</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                <span class="n">method</span><span class="o">=</span><span class="s1">&#39;mumps&#39;</span><span class="p">,</span> <span class="n">preconditioner</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                                <span class="n">cb_ftn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bp_Jac</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bp_R</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Appy Newton&#39;s method.</span>

<span class="sd">    :param R:                residual of system</span>
<span class="sd">    :param U:                unknown to determine</span>
<span class="sd">    :param J:                Jacobian</span>
<span class="sd">    :param bcs:              set of Dirichlet boundary conditions</span>
<span class="sd">    :param atol:             absolute stopping tolerance</span>
<span class="sd">    :param rtol:             relative stopping tolerance</span>
<span class="sd">    :param relaxation_param: ratio of down-gradient step to take each iteration.</span>
<span class="sd">    :param max_iter:         maximum number of iterations to perform</span>
<span class="sd">    :param method:           linear solution method</span>
<span class="sd">    :param preconditioner:   preconditioning method to use with ``Krylov``</span>
<span class="sd">                             solver</span>
<span class="sd">    :param cb_ftn:           at the end of each iteration, this is called</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">converged</span>  <span class="o">=</span> <span class="kc">False</span>
    <span class="n">lmbda</span>      <span class="o">=</span> <span class="n">relaxation_param</span>   <span class="c1"># relaxation parameter</span>
    <span class="n">nIter</span>      <span class="o">=</span> <span class="mi">0</span>                  <span class="c1"># number of iterations</span>

    <span class="c1">## Set PETSc solve type (conjugate gradient) and preconditioner</span>
    <span class="c1">## (algebraic multigrid)</span>
    <span class="c1">#PETScOptions.set(&quot;ksp_type&quot;, &quot;cg&quot;)</span>
    <span class="c1">#PETScOptions.set(&quot;pc_type&quot;, &quot;gamg&quot;)</span>
    <span class="c1">#</span>
    <span class="c1">## Since we have a singular problem, use SVD solver on the multigrid</span>
    <span class="c1">## &#39;coarse grid&#39;</span>
    <span class="c1">#PETScOptions.set(&quot;mg_coarse_ksp_type&quot;, &quot;preonly&quot;)</span>
    <span class="c1">#PETScOptions.set(&quot;mg_coarse_pc_type&quot;, &quot;svd&quot;)</span>
    <span class="c1">#</span>
    <span class="c1">## Set the solver tolerance</span>
    <span class="c1">#PETScOptions.set(&quot;ksp_rtol&quot;, 1.0e-8)</span>
    <span class="c1">#</span>
    <span class="c1">## Print PETSc solver configuration</span>
    <span class="c1">#PETScOptions.set(&quot;ksp_view&quot;)</span>
    <span class="c1">#PETScOptions.set(&quot;ksp_monitor&quot;)</span>

    <span class="c1">#PETScOptions().set(&#39;ksp_type&#39;,                      method)</span>
    <span class="c1">#PETScOptions().set(&#39;mat_type&#39;,                      &#39;matfree&#39;)</span>
    <span class="c1">#PETScOptions().set(&#39;pc_type&#39;,                       preconditioner)</span>
    <span class="c1">#PETScOptions().set(&#39;pc_factor_mat_solver_package&#39;,  &#39;mumps&#39;)</span>
    <span class="c1">#PETScOptions().set(&#39;pc_fieldsplit_schur_fact_type&#39;, &#39;diag&#39;)</span>
    <span class="c1">#PETScOptions().set(&#39;pc_fieldsplit_type&#39;,            &#39;schur&#39;)</span>
    <span class="c1">#PETScOptions().set(&#39;fieldsplit_0_ksp_type&#39;,         &#39;preonly&#39;)</span>
    <span class="c1">#PETScOptions().set(&#39;fieldsplit_0_pc_type&#39;,          &#39;python&#39;)</span>
    <span class="c1">#PETScOptions().set(&#39;fieldsplit_1_ksp_type&#39;,         &#39;preonly&#39;)</span>
    <span class="c1">#PETScOptions().set(&#39;fieldsplit_1_pc_type&#39;,          &#39;python&#39;)</span>
    <span class="c1">#PETScOptions().set(&#39;fieldsplit_1_Mp_ksp_type&#39;,      &#39;preonly&#39;)</span>
    <span class="c1">#PETScOptions().set(&#39;fieldsplit_1_Mp_pc_type&#39;,       &#39;ilu&#39;)</span>
    <span class="c1">#PETScOptions().set(&#39;assembled_pc_type&#39;,             &#39;hypre&#39;)</span>

    <span class="c1"># need to homogenize the boundary, as the residual is always zero over</span>
    <span class="c1"># essential boundaries :</span>
    <span class="n">bcs_u</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="n">bcs</span><span class="p">:</span>
      <span class="n">bc</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>
      <span class="n">bc</span><span class="o">.</span><span class="n">homogenize</span><span class="p">()</span>
      <span class="n">bcs_u</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>

    <span class="c1"># the direction of decent :</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">function_space</span><span class="p">())</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">converged</span> <span class="ow">and</span> <span class="n">nIter</span> <span class="o">&lt;</span> <span class="n">max_iter</span><span class="p">:</span>

      <span class="c1"># assemble system :</span>
      <span class="n">A</span><span class="p">,</span> <span class="n">b</span>    <span class="o">=</span> <span class="n">assemble_system</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="o">-</span><span class="n">R</span><span class="p">,</span> <span class="n">bcs_u</span><span class="p">)</span>

      <span class="c1">## Create Krylov solver and AMG preconditioner</span>
      <span class="c1">#solver  = PETScKrylovSolver(method)#, preconditioner)</span>

      <span class="c1">## Assemble preconditioner system</span>
      <span class="c1">#P, btmp = assemble_system(bp_Jac, -bp_R)</span>

      <span class="c1">### Associate operator (A) and preconditioner matrix (P)</span>
      <span class="c1">##solver.set_operators(A, P)</span>
      <span class="c1">#solver.set_operator(A)</span>

      <span class="c1">## Set PETSc options on the solver</span>
      <span class="c1">#solver.set_from_options()</span>

      <span class="c1">## determine step direction :</span>
      <span class="c1">#solver.solve(d.vector(), b, annotate=False)</span>

      <span class="c1"># determine step direction :</span>
      <span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">vector</span><span class="p">(),</span> <span class="n">b</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">preconditioner</span><span class="p">,</span> <span class="n">annotate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

      <span class="c1"># calculate residual :</span>
      <span class="n">residual</span>  <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="s1">&#39;l2&#39;</span><span class="p">)</span>

      <span class="c1"># set initial residual :</span>
      <span class="k">if</span> <span class="n">nIter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">residual_0</span> <span class="o">=</span> <span class="n">residual</span>

      <span class="c1"># the relative residual :</span>
      <span class="n">rel_res</span> <span class="o">=</span> <span class="n">residual</span><span class="o">/</span><span class="n">residual_0</span>

      <span class="c1"># check for convergence :</span>
      <span class="n">converged</span> <span class="o">=</span> <span class="n">residual</span> <span class="o">&lt;</span> <span class="n">atol</span> <span class="ow">or</span> <span class="n">rel_res</span> <span class="o">&lt;</span> <span class="n">rtol</span>

      <span class="c1"># move U down the gradient :</span>
      <span class="n">U</span><span class="o">.</span><span class="n">vector</span><span class="p">()[:]</span> <span class="o">+=</span> <span class="n">lmbda</span><span class="o">*</span><span class="n">d</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span>

      <span class="c1"># increment counter :</span>
      <span class="n">nIter</span> <span class="o">+=</span> <span class="mi">1</span>

      <span class="c1"># print info to screen :</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">MPI_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;Newton iteration </span><span class="si">%d</span><span class="s2">: r (abs) = </span><span class="si">%.3e</span><span class="s2"> (tol = </span><span class="si">%.3e</span><span class="s2">) &quot;</span> \
                 <span class="o">+</span><span class="s2">&quot;r (rel) = </span><span class="si">%.3e</span><span class="s2"> (tol = </span><span class="si">%.3e</span><span class="s2">)&quot;</span>
        <span class="nb">print</span> <span class="n">string</span> <span class="o">%</span> <span class="p">(</span><span class="n">nIter</span><span class="p">,</span> <span class="n">residual</span><span class="p">,</span> <span class="n">atol</span><span class="p">,</span> <span class="n">rel_res</span><span class="p">,</span> <span class="n">rtol</span><span class="p">)</span>

      <span class="c1"># call the callback function, if desired :</span>
      <span class="k">if</span> <span class="n">cb_ftn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s</span>    <span class="o">=</span> <span class="s2">&quot;::: calling home-rolled Newton method callback :::&quot;</span>
        <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
        <span class="n">cb_ftn</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.RK4"><a class="viewcode-back" href="../model.html#model.Model.RK4">[docs]</a>  <span class="k">def</span> <span class="nf">RK4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">y_0</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method is an abstraction of the fourth-order</span>
<span class="sd">    `Runge-Kutta method &lt;https://en.wikipedia.org/wiki/Runge%E2%80%93Kutta_methods&gt;`_:</span>

<span class="sd">    The initial value problem is specified as follows:</span>

<span class="sd">    .. math::</span>
<span class="sd">       \frac{\mathrm{d} y}{\mathrm{d} t} = f(t,y), \quad y(t_0) = y_0.</span>

<span class="sd">    Here :math:`y` is the unknown function of time :math:`t`, which we would like to approximate; we are told that :math:`\dot{y}`, the rate at which :math:`S` changes, is a function of :math:`t` and :math:`y` itself.</span>
<span class="sd">    The function :math:`f` and the data :math:`t_0`,  :math:`S_0` and step-size :math:`\Delta t &gt; 0` must be supplied.</span>
<span class="sd">    The RK4 method specifies the iteration</span>

<span class="sd">    .. math::</span>
<span class="sd">      \begin{align}</span>
<span class="sd">        y_{n+1} &amp;= y_n + \tfrac{1}{6} \left(k_1 + 2k_2 + 2k_3 + k_4 \right),\\</span>
<span class="sd">        t_{n+1} &amp;= t_n + \Delta t</span>
<span class="sd">      \end{align}</span>

<span class="sd">    for :math:`n = 0, 1, 2, 3, \ldots`, using</span>

<span class="sd">    .. math::</span>
<span class="sd">      \begin{align}</span>
<span class="sd">        k_1 &amp;= \Delta t \ f\left(t_n,                      y_n \right), \\</span>
<span class="sd">        k_2 &amp;= \Delta t \ f\left(t_n + \frac{\Delta t}{2}, y_n + \frac{k_1}{2}\right), \\</span>
<span class="sd">        k_3 &amp;= \Delta t \ f\left(t_n + \frac{\Delta t}{2}, y_n + \frac{k_2}{2}\right), \\</span>
<span class="sd">        k_4 &amp;= \Delta t \ f\left(t_n + \Delta t,           y_n + k_3\right).</span>
<span class="sd">      \end{align}</span>

<span class="sd">    Here :math:`y_{n+1}` is the RK4 approximation of :math:`y(t_{n+1})`, and the next value :math:`y_{n+1}` is determined by the present value :math:`y_n` plus the weighted average of four increments, where each increment is the product of the size of the interval, :math:`\Delta t`, and an estimated slope specified by the function :math:`f` on the right-hand side of the differential equation.</span>

<span class="sd">    * :math:`k_1` is the increment based on the slope at the beginning of the interval, using :math:`y_n`; Euler&#39;s method</span>
<span class="sd">    * :math:`k_2` is the increment based on the slope at the midpoint of the interval, using :math:`y_n` and :math:`k_1`;</span>
<span class="sd">    * :math:`k_3` is again the increment based on the slope at the midpoint, but now using :math:`y_n` and :math:`k_2`;</span>
<span class="sd">    * :math:`k_4` is the increment based on the slope at the end of the interval, using :math:`y_n` and :math:`k_3`.</span>

<span class="sd">    In averaging the four increments, greater weight is given to the increments at the midpoint.</span>
<span class="sd">    The RK4 method is a fourth-order method, meaning that the local truncation error is :math:`\mathcal{O}((\Delta t)^5)`, while the total accumulated error is on the order of :math:`\mathcal{O}((\Delta t)^4)`.</span>

<span class="sd">    This function returns :math:`y_{n+1}` given the parameters :</span>

<span class="sd">    :param f:   function :math:`\dot{y} = f(t,y)`</span>
<span class="sd">    :param y_0: initial values</span>
<span class="sd">    :param dt:  timestep :math:`\Delta t`</span>
<span class="sd">    :type f:    function</span>
<span class="sd">    :type y_0:  :class:`~numpy.ndarray`</span>
<span class="sd">    :type dt:   float</span>
<span class="sd">    :rtype:     :class:`~numpy.ndarray`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">k_1</span>     <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">f</span><span class="p">(</span><span class="n">y_0</span><span class="p">)</span>                     <span class="c1"># 1.) first order</span>
    <span class="n">k_2</span>     <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">f</span><span class="p">(</span><span class="n">y_0</span> <span class="o">+</span> <span class="n">k_1</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>           <span class="c1"># 2.) second order</span>
    <span class="n">k_3</span>     <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">f</span><span class="p">(</span><span class="n">y_0</span> <span class="o">+</span> <span class="n">k_2</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>           <span class="c1"># 3.) third order</span>
    <span class="n">k_4</span>     <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">f</span><span class="p">(</span><span class="n">y_0</span> <span class="o">+</span> <span class="n">k_3</span><span class="p">)</span>               <span class="c1"># 4.) fourth order</span>

    <span class="c1"># next vector :</span>
    <span class="k">return</span>  <span class="n">y_0</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">6.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">k_2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">k_3</span> <span class="o">+</span> <span class="n">k_4</span><span class="p">)</span></div>


<div class="viewcode-block" id="Model.assimilate_U_ob"><a class="viewcode-back" href="../model.html#model.Model.assimilate_U_ob">[docs]</a>  <span class="k">def</span> <span class="nf">assimilate_U_ob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">momentum</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">,</span>
                      <span class="n">tmc_kwargs</span><span class="p">,</span> <span class="n">uop_kwargs</span><span class="p">,</span>
                      <span class="n">atol</span>                <span class="o">=</span> <span class="mf">1e2</span><span class="p">,</span>
                      <span class="n">rtol</span>                <span class="o">=</span> <span class="mf">1e0</span><span class="p">,</span>
                      <span class="n">initialize</span>          <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="n">incomplete</span>          <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="n">post_iter_save_vars</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">post_ini_callback</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">starting_i</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span>    <span class="o">=</span> <span class="s1">&#39;::: performing assimilation process with </span><span class="si">%i</span><span class="s1"> max iterations :::&#39;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span> <span class="o">%</span> <span class="n">max_iter</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

    <span class="c1"># retain base install directory :</span>
    <span class="n">out_dir_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span>

    <span class="c1"># directory for saving convergence history :</span>
    <span class="n">d_hist</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">+</span> <span class="s1">&#39;convergence_history/&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d_hist</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">MPI_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">d_hist</span><span class="p">)</span>

    <span class="c1"># number of digits for saving variables :</span>
    <span class="n">n_i</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">max_iter</span><span class="p">))</span>

    <span class="c1"># starting time :</span>
    <span class="n">t0</span>   <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1"># L_2 erro norm between iterations :</span>
    <span class="n">abs_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">rel_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="c1"># number of iterations, from a starting point (useful for restarts) :</span>
    <span class="k">if</span> <span class="n">starting_i</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">counter</span> <span class="o">=</span> <span class="n">starting_i</span>

    <span class="c1"># initialize friction field :</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">init_beta</span><span class="p">(</span><span class="n">beta_i</span><span class="p">)</span>

    <span class="c1"># previous friction for norm calculation :</span>
    <span class="n">beta_prev</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># perform initialization step if desired :</span>
    <span class="k">if</span> <span class="n">initialize</span><span class="p">:</span>
      <span class="n">s</span>    <span class="o">=</span> <span class="s1">&#39;    - performing initialization step -&#39;</span>
      <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

      <span class="c1"># set the initialization output directory :</span>
      <span class="n">out_dir_n</span> <span class="o">=</span> <span class="s1">&#39;initialization/&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">set_out_dir</span><span class="p">(</span><span class="n">out_dir_i</span> <span class="o">+</span> <span class="n">out_dir_n</span><span class="p">)</span>

      <span class="c1"># thermo-mechanical couple :</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">thermo_solve</span><span class="p">(</span><span class="o">**</span><span class="n">tmc_kwargs</span><span class="p">)</span>

      <span class="c1"># call the post function if set :</span>
      <span class="k">if</span> <span class="n">post_ini_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s</span>    <span class="o">=</span> <span class="s1">&#39;::: calling post-initialization assimilate_U_ob &#39;</span> <span class="o">+</span> \
               <span class="s1">&#39;callback function :::&#39;</span>
        <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
        <span class="n">post_ini_callback</span><span class="p">()</span>

    <span class="c1"># otherwise, tell us that we are not initializing :</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">s</span>    <span class="o">=</span> <span class="s1">&#39;    - skipping initialization step -&#39;</span>
      <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

    <span class="c1"># save the w_opt bounds on Fb :</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">tmc_kwargs</span><span class="p">[</span><span class="s1">&#39;wop_kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;bounds&#39;</span><span class="p">])</span>

    <span class="c1"># assimilate the data :</span>
    <span class="k">while</span> <span class="n">abs_error</span> <span class="o">&gt;</span> <span class="n">atol</span> <span class="ow">and</span> <span class="n">rel_error</span> <span class="o">&gt;</span> <span class="n">rtol</span> <span class="ow">and</span> <span class="n">counter</span> <span class="o">&lt;=</span> <span class="n">max_iter</span><span class="p">:</span>
      <span class="n">s</span>    <span class="o">=</span> <span class="s1">&#39;::: entering iterate </span><span class="si">%i</span><span class="s1"> of </span><span class="si">%i</span><span class="s1"> of assimilation process :::&#39;</span>
      <span class="n">print_text</span><span class="p">(</span><span class="n">s</span> <span class="o">%</span> <span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">),</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

      <span class="c1"># set a new unique output directory :</span>
      <span class="n">out_dir_n</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0*d</span><span class="s1">/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n_i</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">set_out_dir</span><span class="p">(</span><span class="n">out_dir_i</span> <span class="o">+</span> <span class="n">out_dir_n</span><span class="p">)</span>

      <span class="c1"># the incomplete adjoint means the viscosity is linear, and</span>
      <span class="c1"># we do not want to reset the original momentum configuration, because</span>
      <span class="c1"># we have more non-linear solves to do :</span>
      <span class="k">if</span> <span class="n">incomplete</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">momentum</span><span class="o">.</span><span class="n">linear</span><span class="p">:</span>
        <span class="n">momentum</span><span class="o">.</span><span class="n">linearize_viscosity</span><span class="p">(</span><span class="n">reset_orig_config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

      <span class="c1"># re-initialize friction field :</span>
      <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="n">starting_i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_beta</span><span class="p">(</span><span class="n">beta_i</span><span class="p">)</span>

      <span class="c1"># optimize the velocity :</span>
      <span class="n">momentum</span><span class="o">.</span><span class="n">optimize_U_ob</span><span class="p">(</span><span class="o">**</span><span class="n">uop_kwargs</span><span class="p">)</span>

      <span class="c1"># reset the momentum to the original configuration :</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">momentum</span><span class="o">.</span><span class="n">linear_s</span> <span class="ow">and</span> <span class="n">momentum</span><span class="o">.</span><span class="n">linear</span><span class="p">:</span> <span class="n">momentum</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

      <span class="c1"># thermo-mechanically couple :</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">thermo_solve</span><span class="p">(</span><span class="o">**</span><span class="n">tmc_kwargs</span><span class="p">)</span>

      <span class="c1"># calculate L_2 norms :</span>
      <span class="n">abs_error_n</span>  <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">beta_prev</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">vector</span><span class="p">(),</span> <span class="s1">&#39;l2&#39;</span><span class="p">)</span>
      <span class="n">beta_nrm</span>     <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">vector</span><span class="p">(),</span> <span class="s1">&#39;l2&#39;</span><span class="p">)</span>

      <span class="c1"># save convergence history :</span>
      <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rel_error</span>  <span class="o">=</span> <span class="n">abs_error_n</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">MPI_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">err_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">abs_error_n</span><span class="p">])</span>
          <span class="n">nrm_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">beta_nrm</span><span class="p">])</span>
          <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">d_hist</span> <span class="o">+</span> <span class="s1">&#39;abs_err.txt&#39;</span><span class="p">,</span>   <span class="n">err_a</span><span class="p">)</span>
          <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">d_hist</span> <span class="o">+</span> <span class="s1">&#39;beta_norm.txt&#39;</span><span class="p">,</span> <span class="n">nrm_a</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">rel_error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">abs_error</span> <span class="o">-</span> <span class="n">abs_error_n</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">MPI_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">err_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">d_hist</span> <span class="o">+</span> <span class="s1">&#39;abs_err.txt&#39;</span><span class="p">)</span>
          <span class="n">nrm_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">d_hist</span> <span class="o">+</span> <span class="s1">&#39;beta_norm.txt&#39;</span><span class="p">)</span>
          <span class="n">err_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_n</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">abs_error_n</span><span class="p">]))</span>
          <span class="n">nrm_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nrm_n</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">beta_nrm</span><span class="p">]))</span>
          <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">d_hist</span> <span class="o">+</span> <span class="s1">&#39;abs_err.txt&#39;</span><span class="p">,</span>    <span class="n">err_a</span><span class="p">)</span>
          <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">d_hist</span> <span class="o">+</span> <span class="s1">&#39;beta_norm.txt&#39;</span><span class="p">,</span>  <span class="n">nrm_a</span><span class="p">)</span>

      <span class="c1"># print info to screen :</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">MPI_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s0</span>    <span class="o">=</span> <span class="s1">&#39;&gt;&gt;&gt; &#39;</span>
        <span class="n">s1</span>    <span class="o">=</span> <span class="s1">&#39;U_ob assimilation iteration </span><span class="si">%i</span><span class="s1"> (max </span><span class="si">%i</span><span class="s1">) done: &#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">)</span>
        <span class="n">s2</span>    <span class="o">=</span> <span class="s1">&#39;r (abs) = </span><span class="si">%.2e</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">abs_error</span>
        <span class="n">s3</span>    <span class="o">=</span> <span class="s1">&#39;(tol </span><span class="si">%.2e</span><span class="s1">), &#39;</span>    <span class="o">%</span> <span class="n">atol</span>
        <span class="n">s4</span>    <span class="o">=</span> <span class="s1">&#39;r (rel) = </span><span class="si">%.2e</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">rel_error</span>
        <span class="n">s5</span>    <span class="o">=</span> <span class="s1">&#39;(tol </span><span class="si">%.2e</span><span class="s1">)&#39;</span>      <span class="o">%</span> <span class="n">rtol</span>
        <span class="n">s6</span>    <span class="o">=</span> <span class="s1">&#39; &lt;&lt;&lt;&#39;</span>
        <span class="n">text0</span> <span class="o">=</span> <span class="n">get_text</span><span class="p">(</span><span class="n">s0</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">text1</span> <span class="o">=</span> <span class="n">get_text</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">text2</span> <span class="o">=</span> <span class="n">get_text</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">text3</span> <span class="o">=</span> <span class="n">get_text</span><span class="p">(</span><span class="n">s3</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">text4</span> <span class="o">=</span> <span class="n">get_text</span><span class="p">(</span><span class="n">s4</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">text5</span> <span class="o">=</span> <span class="n">get_text</span><span class="p">(</span><span class="n">s5</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">text6</span> <span class="o">=</span> <span class="n">get_text</span><span class="p">(</span><span class="n">s6</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span> <span class="n">text0</span> <span class="o">+</span> <span class="n">text1</span> <span class="o">+</span> <span class="n">text2</span> <span class="o">+</span> <span class="n">text3</span> <span class="o">+</span> <span class="n">text4</span> <span class="o">+</span> <span class="n">text5</span> <span class="o">+</span> <span class="n">text6</span>

      <span class="c1"># save state to unique hdf5 file :</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">post_iter_save_vars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">s</span>    <span class="o">=</span> <span class="s1">&#39;::: saving variables in list arg post_iter_save_vars :::&#39;</span>
        <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
        <span class="n">out_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">+</span> <span class="s1">&#39;inverted.h5&#39;</span>
        <span class="n">foutput</span>  <span class="o">=</span> <span class="n">HDF5File</span><span class="p">(</span><span class="n">mpi_comm_world</span><span class="p">(),</span> <span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">post_iter_save_vars</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">save_hdf5</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">foutput</span><span class="p">)</span>
        <span class="n">foutput</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

      <span class="c1"># update error stuff and increment iteration counter :</span>
      <span class="n">abs_error</span>    <span class="o">=</span> <span class="n">abs_error_n</span>
      <span class="n">beta_prev</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">counter</span>     <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># calculate total time to compute</span>
    <span class="n">tf</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">s</span>  <span class="o">=</span> <span class="n">tf</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="n">m</span>  <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="mf">60.0</span>
    <span class="n">h</span>  <span class="o">=</span> <span class="n">m</span> <span class="o">/</span> <span class="mf">60.0</span>
    <span class="n">s</span>  <span class="o">=</span> <span class="n">s</span> <span class="o">%</span> <span class="mi">60</span>
    <span class="n">m</span>  <span class="o">=</span> <span class="n">m</span> <span class="o">%</span> <span class="mi">60</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;time to compute TMC optimized ||u - u_ob||: </span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">text</span> <span class="o">%</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># plot the convergence history :</span>
    <span class="n">s</span>    <span class="o">=</span> <span class="s2">&quot;::: convergence info saved to </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s2"> :::&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span> <span class="o">%</span> <span class="n">d_hist</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">MPI_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">d_hist</span> <span class="o">+</span> <span class="s1">&#39;time.txt&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tf</span> <span class="o">-</span> <span class="n">t0</span><span class="p">]))</span>

      <span class="n">err_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">d_hist</span> <span class="o">+</span> <span class="s1">&#39;abs_err.txt&#39;</span><span class="p">)</span>
      <span class="n">nrm_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">d_hist</span> <span class="o">+</span> <span class="s1">&#39;beta_norm.txt&#39;</span><span class="p">)</span>

      <span class="c1"># plot iteration error :</span>
      <span class="n">fig</span>   <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
      <span class="n">ax</span>    <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Vert \beta_{n-1} - \beta_n \Vert$&#39;</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;iteration&#39;</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">err_a</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">d_hist</span> <span class="o">+</span> <span class="s1">&#39;abs_err.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

      <span class="c1"># plot theta norm :</span>
      <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
      <span class="n">ax</span>  <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Vert \beta_n \Vert$&#39;</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;iteration&#39;</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nrm_a</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">d_hist</span> <span class="o">+</span> <span class="s1">&#39;beta_norm.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.L_curve"><a class="viewcode-back" href="../model.html#model.Model.L_curve">[docs]</a>  <span class="k">def</span> <span class="nf">L_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alphas</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">physics</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">adj_kwargs</span><span class="p">,</span>
              <span class="n">pre_callback</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">post_callback</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">itr_save_vars</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span>    <span class="o">=</span> <span class="s1">&#39;::: starting L-curve procedure :::&#39;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

    <span class="c1"># starting time :</span>
    <span class="n">t0</span>   <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1"># retain base install directory :</span>
    <span class="n">out_dir_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span>

    <span class="c1"># retain initial control parameter for consistency :</span>
    <span class="n">control_ini</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># iterate through each of the regularization parameters provided :</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">alpha</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">alphas</span><span class="p">):</span>
      <span class="n">s</span>    <span class="o">=</span> <span class="s1">&#39;::: performing L-curve iteration </span><span class="si">%i</span><span class="s1"> with alpha = </span><span class="si">%.3e</span><span class="s1"> :::&#39;</span>
      <span class="n">print_text</span><span class="p">(</span><span class="n">s</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">alpha</span><span class="p">)</span> <span class="p">,</span> <span class="n">atrb</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

      <span class="c1"># reset everything after the first iteration :</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span>    <span class="o">=</span> <span class="s1">&#39;::: initializing physics :::&#39;</span>
        <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
        <span class="n">physics</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">control_ini</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

      <span class="c1"># set the appropriate output directory :</span>
      <span class="n">out_dir_n</span> <span class="o">=</span> <span class="s1">&#39;alpha_</span><span class="si">%.1E</span><span class="s1">/&#39;</span> <span class="o">%</span> <span class="n">alpha</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">set_out_dir</span><span class="p">(</span><span class="n">out_dir_i</span> <span class="o">+</span> <span class="n">out_dir_n</span><span class="p">)</span>

      <span class="c1"># call the pre-adjoint callback function :</span>
      <span class="k">if</span> <span class="n">pre_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s</span>    <span class="o">=</span> <span class="s1">&#39;::: calling L_curve() pre-adjoint pre_callback() :::&#39;</span>
        <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
        <span class="n">pre_callback</span><span class="p">()</span>

      <span class="c1"># form new objective functional :</span>
      <span class="n">adj_kwargs</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">J</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="n">R</span>

      <span class="c1"># solve the adjoint system :</span>
      <span class="n">physics</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="o">**</span><span class="n">adj_kwargs</span><span class="p">)</span>

      <span class="c1"># call the post-adjoint callback function :</span>
      <span class="k">if</span> <span class="n">post_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s</span>    <span class="o">=</span> <span class="s1">&#39;::: calling L_curve() post-adjoint post_callback() :::&#39;</span>
        <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
        <span class="n">post_callback</span><span class="p">()</span>

      <span class="c1"># save state to unique hdf5 file :</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itr_save_vars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">s</span>    <span class="o">=</span> <span class="s1">&#39;::: saving variables in list arg itr_save_vars :::&#39;</span>
        <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
        <span class="n">out_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">+</span> <span class="s1">&#39;lcurve.h5&#39;</span>
        <span class="n">foutput</span>  <span class="o">=</span> <span class="n">HDF5File</span><span class="p">(</span><span class="n">mpi_comm_world</span><span class="p">(),</span> <span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">itr_save_vars</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">save_hdf5</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">foutput</span><span class="p">)</span>
        <span class="n">foutput</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">s</span>    <span class="o">=</span> <span class="s1">&#39;::: L-curve procedure complete :::&#39;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>

    <span class="c1"># calculate total time to compute</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="mf">60.0</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">m</span> <span class="o">/</span> <span class="mf">60.0</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">%</span> <span class="mi">60</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">%</span> <span class="mi">60</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;time to complete L-curve procedure: </span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.calculate_courant_number"><a class="viewcode-back" href="../model.html#model.Model.calculate_courant_number">[docs]</a>  <span class="k">def</span> <span class="nf">calculate_courant_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates and returns the Courant number</span>

<span class="sd">    .. math::</span>
<span class="sd">       c = \Delta t \frac{\Vert \underline{u} \Vert}{h}.</span>

<span class="sd">    with ice velocity :math:`\underline{u}`, cell diameter :math:`h`, and timestep :math:`\Delta t`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="p">(</span> <span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U3</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span> <span class="p">)</span></div>

<div class="viewcode-block" id="Model.thermo_solve"><a class="viewcode-back" href="../model.html#model.Model.thermo_solve">[docs]</a>  <span class="k">def</span> <span class="nf">thermo_solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thermo_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform thermo-mechanical coupling between momentum and energy.</span>

<span class="sd">    This needs be implemented by children of the :class:`~model.Model` class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raiseNotDefined</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.transient_iteration"><a class="viewcode-back" href="../model.html#model.Model.transient_iteration">[docs]</a>  <span class="k">def</span> <span class="nf">transient_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">momentum</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">time_step</span><span class="p">,</span> <span class="n">adaptive</span><span class="p">,</span> <span class="n">annotate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function defines one interation of the transient solution, and is</span>
<span class="sd">    called by the function :func:`~model.transient_solve`.</span>

<span class="sd">    This must be implemented by the child classes for</span>
<span class="sd">    :func:`~model.transient_solve` to work.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raiseNotDefined</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.transient_solve"><a class="viewcode-back" href="../model.html#model.Model.transient_solve">[docs]</a>  <span class="k">def</span> <span class="nf">transient_solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">momentum</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">time_step</span><span class="p">,</span>
                      <span class="n">tmc_kwargs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">adaptive</span>   <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                      <span class="n">annotate</span>   <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                      <span class="n">callback</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span>    <span class="o">=</span> <span class="s1">&#39;::: performing transient run :::&#39;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">cslvr.momentum</span> <span class="k">import</span> <span class="n">Momentum</span>
    <span class="kn">from</span> <span class="nn">cslvr.mass</span>     <span class="k">import</span> <span class="n">Mass</span>

    <span class="c1"># the minimum requirements for a transient solve are momentum and mass :</span>
    <span class="k">if</span> <span class="n">momentum</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span> <span class="o">!=</span> <span class="n">Momentum</span><span class="p">:</span>
      <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&gt;&gt;&gt; transient_solve REQUIRES A &#39;Momentum&#39; INSTANCE, NOT </span><span class="si">%s</span><span class="s2"> &lt;&lt;&lt;&quot;</span>
      <span class="n">print_text</span><span class="p">(</span><span class="n">s</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">momentum</span><span class="p">),</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mass</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span> <span class="o">!=</span> <span class="n">Mass</span><span class="p">:</span>
      <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&gt;&gt;&gt; transient_solve REQUIRES A &#39;Mass&#39; INSTANCE, NOT </span><span class="si">%s</span><span class="s2"> &lt;&lt;&lt;&quot;</span>
      <span class="n">print_text</span><span class="p">(</span><span class="n">s</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">mass</span><span class="p">),</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">init_time_step</span><span class="p">(</span><span class="n">time_step</span><span class="p">)</span>
    <span class="n">mass</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">init_time_step</span><span class="p">(</span><span class="n">time_step</span><span class="p">)</span>
    <span class="n">t0</span>             <span class="o">=</span> <span class="n">time</span><span class="p">()</span>    <span class="c1"># starting time (for total time to compute)</span>
    <span class="n">t</span>              <span class="o">=</span> <span class="n">t_start</span>   <span class="c1"># beginning time</span>
    <span class="n">dt</span>             <span class="o">=</span> <span class="n">time_step</span> <span class="c1"># current time step</span>
    <span class="n">dt_0</span>           <span class="o">=</span> <span class="n">time_step</span> <span class="c1"># initial time step for adaptive solve</span>

    <span class="c1"># history of the the total mass of the domain (iteration `k = 0`:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">step_time</span>    <span class="o">=</span> <span class="p">[]</span>                    <span class="c1"># list of time steps (for adapt)</span>
    <span class="c1">#m_tot_k           = assemble(mass.M_tot)  # initial mass</span>
    <span class="c1">#print_min_max(m_tot_k, &#39;initial m_tot_k&#39;)</span>
    <span class="c1">#self.mass_history = [m_tot_k]             # mass history</span>
    <span class="n">stars</span>             <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">80</span>            <span class="c1"># stars for printing</span>

    <span class="c1"># Loop over all times</span>
    <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">t_end</span><span class="p">:</span>

      <span class="c1"># start the timer :</span>
      <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

      <span class="c1"># this will be implemented in the child class (see template above) :</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">transient_iteration</span><span class="p">(</span><span class="n">momentum</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">adaptive</span><span class="p">,</span> <span class="n">annotate</span><span class="p">)</span>

      <span class="c1"># thermo-mechanical couple if desired :</span>
      <span class="k">if</span> <span class="n">tmc_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermo_solve</span><span class="p">(</span><span class="o">**</span><span class="n">tmc_kwargs</span><span class="p">)</span>

      <span class="c1">## calculate the total mass : FIXME: need to compute this some other way</span>
      <span class="c1">#m_tot = assemble(mass.M_tot)</span>
      <span class="c1">#print_min_max(m_tot_k, &#39;m_tot_k&#39;)</span>

      <span class="c1"># call a user-defined callback function!  useful!  solve age equation!</span>
      <span class="k">if</span> <span class="n">callback</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">print_text</span><span class="p">(</span><span class="s1">&#39;::: calling callback function :::&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">this</span><span class="p">)</span>
        <span class="n">callback</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="p">)</span>

      <span class="c1"># end the timer :</span>
      <span class="n">tok</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

      <span class="c1"># calculate Courant number :</span>
      <span class="k">if</span> <span class="n">adaptive</span><span class="p">:</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_courant_number</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>        <span class="n">c</span> <span class="o">=</span> <span class="mf">0.0</span>

      <span class="c1"># print statistics :</span>
      <span class="n">print_text</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt; iteration </span><span class="si">%i</span><span class="s2"> complete &lt;&lt;&lt;&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_time</span><span class="p">),</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sim time [yr]           &quot;</span> <span class="p">:</span> <span class="s2">&quot; </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="p">),</span>
               <span class="s2">&quot;dt [yr]                 &quot;</span> <span class="p">:</span> <span class="s2">&quot; </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dt</span><span class="p">,</span>
               <span class="s2">&quot;CPU time [s]            &quot;</span> <span class="p">:</span> <span class="s2">&quot; </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tok</span> <span class="o">-</span> <span class="n">tic</span><span class="p">),</span>
               <span class="s2">&quot;courant number [--]     &quot;</span> <span class="p">:</span> <span class="s2">&quot; </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">c</span><span class="p">}</span>
      <span class="c1">#         &quot;mass m_t - m_{t-1} [kg] &quot; : &quot; %g&quot; % (m_tot - m_tot_k)}</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39; : &#39;</span><span class="p">))</span>
      <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

      <span class="c1"># store information :</span>
      <span class="c1">#self.mass_history.append(m_tot)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">step_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>

      <span class="c1"># increment :</span>
      <span class="c1">#m_tot_k = m_tot</span>
      <span class="n">t</span>      <span class="o">+=</span> <span class="n">dt</span>

      <span class="c1"># adjust the time step to obey the CFL condition, if desired :</span>
      <span class="k">if</span> <span class="n">adaptive</span><span class="p">:</span>
        <span class="n">dt_n</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="k">if</span>   <span class="n">c</span> <span class="o">&gt;</span> <span class="mf">0.5</span>               <span class="p">:</span> <span class="n">dt_n</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="ow">and</span> <span class="n">dt</span> <span class="o">&lt;</span> <span class="n">dt_0</span> <span class="p">:</span> <span class="n">dt_n</span> <span class="o">=</span> <span class="n">dt</span><span class="o">*</span><span class="mf">2.0</span>
        <span class="k">if</span> <span class="n">dt_n</span> <span class="o">!=</span> <span class="n">dt</span><span class="p">:</span>
          <span class="n">dt</span> <span class="o">=</span> <span class="n">dt_n</span>
          <span class="n">print_text</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="n">print_text</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt; WARNING: time step altered to </span><span class="si">%g</span><span class="s2"> &lt;&lt;&lt;&quot;</span> <span class="o">%</span> <span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="n">print_text</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">init_time_step</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

    <span class="c1"># calculate total time to compute</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="mf">60.0</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">m</span> <span class="o">/</span> <span class="mf">60.0</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">%</span> <span class="mi">60</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">%</span> <span class="mi">60</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;total time to perform transient run: </span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div></div>



</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Evan M. Cummings.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>