

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>helper &mdash; CSLVR  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> CSLVR
          

          
          </a>

          
            
            
              <div class="version">
                2017
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Preliminaries</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get_started.html">Hello CSLVR</a></li>
</ul>
<p class="caption"><span class="caption-text">Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../input.html">Input</a></li>
<li class="toctree-l1"><a class="reference internal" href="../output.html">Output</a></li>
</ul>
<p class="caption"><span class="caption-text">Mesh generation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../meshing.html">Meshing</a></li>
</ul>
<p class="caption"><span class="caption-text">Base Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../model.html">The Model classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics.html">The Physics classes</a></li>
</ul>
<p class="caption"><span class="caption-text">Balance equations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../momentum.html">Momentum balance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mass.html">Mass balance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy.html">Energy balance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../velocity.html">Velocity balance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stress.html">Stress balance</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CSLVR</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>helper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for helper</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">dolfin</span>                  <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">dolfin_adjoint</span>          <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyproj</span>                  <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ufl</span>                     <span class="k">import</span> <span class="n">indexed</span>
<span class="kn">from</span> <span class="nn">termcolor</span>               <span class="k">import</span> <span class="n">colored</span><span class="p">,</span> <span class="n">cprint</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span>    <span class="k">import</span> <span class="n">Basemap</span>
<span class="kn">from</span> <span class="nn">matplotlib</span>              <span class="k">import</span> <span class="n">colors</span><span class="p">,</span> <span class="n">ticker</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span>       <span class="k">import</span> <span class="n">LogFormatter</span><span class="p">,</span> <span class="n">ScalarFormatter</span><span class="p">,</span> <span class="n">NullFormatter</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="k">import</span> <span class="n">make_axes_locatable</span><span class="p">,</span> <span class="n">inset_locator</span>
<span class="kn">from</span> <span class="nn">cslvr.inputoutput</span>       <span class="k">import</span> <span class="n">print_text</span><span class="p">,</span> <span class="n">DataInput</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span>     <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pylab</span>                 <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">numpy</span>                 <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">inspect</span><span class="o">,</span> <span class="nn">re</span>




<span class="k">def</span> <span class="nf">raiseNotDefined</span><span class="p">():</span>
  <span class="n">fileName</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">line</span>     <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
  <span class="n">method</span>   <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
  
  <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;*** Method not implemented: </span><span class="si">%s</span><span class="s2"> at line </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2">&quot;</span>
  <span class="nb">print</span> <span class="n">text</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>




<span class="k">class</span> <span class="nc">Boundary</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">markers</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">measure</span>     <span class="o">=</span> <span class="n">measure</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">markers</span>     <span class="o">=</span> <span class="n">markers</span>
  <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">meas</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">meas</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">meas</span>




<div class="viewcode-block" id="download_file"><a class="viewcode-back" href="../input.html#helper.download_file">[docs]</a><span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">direc</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">extract</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Download a file with url string ``url`` into directory ``direc/folder``.</span>
<span class="sd">  If ``extract == True``, extract the .zip or tar.gz file into the directory </span>
<span class="sd">  and delete the .zip or tar.gz file.</span>

<span class="sd">  :param url:     the URL of the file you want to download</span>
<span class="sd">  :param direc:   the directory relative to the script where you want to save</span>
<span class="sd">  :param folder:  a folder in directory ``direc`` you want to save into</span>
<span class="sd">  :param extract: if the file is compressed as zip or tar.gz, extract it</span>
<span class="sd">  :type url:      string</span>
<span class="sd">  :type direc:    string</span>
<span class="sd">  :type folder:   string</span>
<span class="sd">  :type extract:  bool</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="kn">import</span> <span class="nn">urllib2</span>
  <span class="kn">import</span> <span class="nn">sys</span>
  <span class="kn">import</span> <span class="nn">os</span>
  <span class="kn">import</span> <span class="nn">zipfile</span>
  <span class="kn">import</span> <span class="nn">tarfile</span>
  
  <span class="c1"># make the directory if needed :</span>
  <span class="n">direc</span> <span class="o">=</span> <span class="n">direc</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
  <span class="n">d</span>     <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">direc</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

  <span class="c1"># url file info :</span>
  <span class="n">fn</span>   <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">fn</span>   <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">u</span>    <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
  <span class="n">f</span>    <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">direc</span> <span class="o">+</span> <span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
  <span class="n">meta</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
  <span class="n">fs</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">getheaders</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
  
  <span class="n">s</span>    <span class="o">=</span> <span class="s2">&quot;Downloading: </span><span class="si">%s</span><span class="s2"> Bytes: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">fs</span><span class="p">)</span>
  <span class="nb">print</span> <span class="n">s</span>
  
  <span class="n">fs_dl</span>  <span class="o">=</span> <span class="mi">0</span>
  <span class="n">blk_sz</span> <span class="o">=</span> <span class="mi">8192</span>
  
  <span class="c1"># download the file and print status :</span>
  <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">blk_sz</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">buffer</span><span class="p">:</span>
      <span class="k">break</span>
  
    <span class="n">fs_dl</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">%10d</span><span class="s2">  [</span><span class="si">%3.2f%%</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fs_dl</span><span class="p">,</span> <span class="n">fs_dl</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">/</span> <span class="n">fs</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">status</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
  
  <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  
  <span class="c1"># extract the zip/tar.gz file if necessary :</span>
  <span class="k">if</span> <span class="n">extract</span><span class="p">:</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ty</span> <span class="o">==</span> <span class="s1">&#39;zip&#39;</span><span class="p">:</span>
      <span class="n">cf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">direc</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">cf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">direc</span> <span class="o">+</span> <span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;r:gz&#39;</span><span class="p">)</span>
    <span class="n">cf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">direc</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">direc</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span></div>




<span class="k">class</span> <span class="nc">IsotropicMeshRefiner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  In this class, the cells in the mesh are isotropically refined above a </span>
<span class="sd">  a certain proportion of average error.</span>

<span class="sd">  Args:</span>
<span class="sd">  </span>
<span class="sd">    :m_0:  Initial unrefined mesh</span>
<span class="sd">    :U_ex: Representation of the ice sheet as a dolfin expression</span>

<span class="sd">  Original author: Doug Brinkerhoff: https://dbrinkerhoff.org/</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_0</span><span class="p">,</span> <span class="n">U_ex</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">m_0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">U_ex</span> <span class="o">=</span> <span class="n">U_ex</span>

  <span class="k">def</span> <span class="nf">refine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">REFINE_RATIO</span><span class="p">,</span> <span class="n">hmin</span><span class="p">,</span> <span class="n">hmax</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines which cells that are above a certain error threshold based</span>
<span class="sd">    on the diameter of the cells</span>
<span class="sd">  </span>
<span class="sd">    Args:</span>
<span class="sd">    </span>
<span class="sd">      :REFINE_RATIO: Long value between 0 and 1, inclusive, to select </span>
<span class="sd">                     an error value in a reverse sorted list.  </span>
<span class="sd">                     (i.e. .5 selects the midpoint)</span>
<span class="sd">      :hmin:         Minimum diameter of the cells</span>
<span class="sd">      :hmax:         Maximum diameter of the cells</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;refining </span><span class="si">%.2f%%</span><span class="s2"> of max error&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">REFINE_RATIO</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span>

    <span class="n">V</span>    <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">Hxx</span>  <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Hxy</span>  <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Hyy</span>  <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">phi</span>  <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    
    <span class="n">U</span>    <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U_ex</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
    <span class="n">a_xx</span> <span class="o">=</span> <span class="n">Hxx</span> <span class="o">*</span> <span class="n">phi</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">L_xx</span> <span class="o">=</span> <span class="o">-</span> <span class="n">U</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">phi</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>

    <span class="n">a_xy</span> <span class="o">=</span> <span class="n">Hxy</span> <span class="o">*</span> <span class="n">phi</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">L_xy</span> <span class="o">=</span> <span class="o">-</span> <span class="n">U</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">phi</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>

    <span class="n">a_yy</span> <span class="o">=</span> <span class="n">Hyy</span> <span class="o">*</span> <span class="n">phi</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">L_yy</span> <span class="o">=</span> <span class="o">-</span> <span class="n">U</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">phi</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>

    <span class="n">Hxx</span>  <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Hxy</span>  <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Hyy</span>  <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
  
    <span class="n">solve</span><span class="p">(</span><span class="n">a_xx</span> <span class="o">==</span> <span class="n">L_xx</span><span class="p">,</span> <span class="n">Hxx</span><span class="p">)</span>
    <span class="n">solve</span><span class="p">(</span><span class="n">a_xy</span> <span class="o">==</span> <span class="n">L_xy</span><span class="p">,</span> <span class="n">Hxy</span><span class="p">)</span>
    <span class="n">solve</span><span class="p">(</span><span class="n">a_yy</span> <span class="o">==</span> <span class="n">L_yy</span><span class="p">,</span> <span class="n">Hyy</span><span class="p">)</span>
    <span class="n">e_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">e_list_calc</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1">#Iterate overthecells in the mesh</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
    
      <span class="n">x</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">midpoint</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">midpoint</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>

      <span class="n">a</span> <span class="o">=</span> <span class="n">Hxx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
      <span class="n">b</span> <span class="o">=</span> <span class="n">Hxy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
      <span class="n">d</span> <span class="o">=</span> <span class="n">Hyy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

      <span class="n">H_local</span> <span class="o">=</span> <span class="p">([[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">],</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">d</span><span class="p">]])</span>
      
      <span class="c1">#Calculate the Hessian of the velocity norm</span>
      <span class="n">Hnorm</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">H_local</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
      <span class="n">h</span>     <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">diameter</span><span class="p">()</span>
      
      <span class="c1"># Use the diameter of the cells to set the error :</span>
      <span class="k">if</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">hmin</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">elif</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="n">hmax</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="mf">1e20</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">h</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Hnorm</span>
        <span class="n">e_list_calc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
      <span class="n">e_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

    <span class="n">idx</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e_list_calc</span><span class="p">)</span> <span class="o">*</span> <span class="n">REFINE_RATIO</span><span class="p">)</span>
    <span class="n">e_mid</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">e_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
    <span class="nb">print</span> <span class="s2">&quot;error midpoint :&quot;</span><span class="p">,</span> <span class="n">e_mid</span>

    <span class="n">cell_markers</span> <span class="o">=</span> <span class="n">MeshFunction</span><span class="p">(</span><span class="s2">&quot;bool&quot;</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="p">()</span><span class="o">.</span><span class="n">dim</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
      <span class="n">ci</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">index</span><span class="p">()</span>
      <span class="n">cd</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">diameter</span><span class="p">()</span>
      <span class="n">cell_markers</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_list</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">e_mid</span> <span class="ow">and</span> <span class="n">cd</span> <span class="o">&gt;</span> <span class="n">hmin</span> <span class="ow">and</span> <span class="n">cd</span> <span class="o">&lt;</span> <span class="n">hmax</span>
  
    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">refine</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">cell_markers</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">U</span>    <span class="o">=</span> <span class="n">U</span>

  <span class="k">def</span> <span class="nf">extrude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">workspace_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">n_processors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function writes the refinements to the mesh to msh files and</span>
<span class="sd">    extrudes the mesh</span>

<span class="sd">    Args:</span>
<span class="sd">    </span>
<span class="sd">     :n_layers:       Number of layers in the mesh</span>
<span class="sd">     :workspace_path: Path to the location where the refined meshes</span>
<span class="sd">                      will be written</span>
<span class="sd">     :n_processors:   Number of processers utilized in the extrusion</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_layers</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">write_gmsh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">workspace_path</span> <span class="o">+</span> <span class="s2">&quot;/2dmesh.msh&quot;</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">workspace_path</span> <span class="o">+</span> <span class="s2">&quot;/2dmesh.geo&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Merge </span><span class="se">\&quot;</span><span class="s2">2dmesh.msh</span><span class="se">\&quot;</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Extrude {0,0,1} {Surface</span><span class="si">{0}</span><span class="s2">; Layers{&quot;</span> <span class="o">+</span> <span class="n">layers</span> <span class="o">+</span> <span class="s2">&quot;};}&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;Extruding mesh (This could take a while).&quot;</span>

    <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;mpirun -np </span><span class="si">{0:d}</span><span class="s2"> gmsh &quot;</span> <span class="o">+</span> <span class="n">workspace_path</span> <span class="o">+</span> <span class="s2">&quot;/2dmesh.geo -3 -o &quot;</span> \
             <span class="o">+</span> <span class="n">workspace_path</span> <span class="o">+</span> <span class="s2">&quot;/3dmesh.msh -format msh -v 0&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_processors</span><span class="p">))</span>

    <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;dolfin-convert &quot;</span> <span class="o">+</span> <span class="n">workspace_path</span> <span class="o">+</span> <span class="s2">&quot;/3dmesh.msh &quot;</span> \
             <span class="o">+</span> <span class="n">workspace_path</span> <span class="o">+</span> <span class="s2">&quot;/3dmesh.xml&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>




<span class="k">class</span> <span class="nc">AnisotropicMeshRefiner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  This class performs anistropic mesh refinements on the mesh in order to </span>
<span class="sd">  account for the directional nature of the velocity field.  In order to </span>
<span class="sd">  accomplish this, Gauss-Steidl iterations are used to approximately solve</span>
<span class="sd">  the elasticity problem with computed edge errors as &#39;spring constants&#39;.</span>

<span class="sd">  Args:</span>
<span class="sd">  </span>
<span class="sd">    :m_0:  Initial unrefined mesh</span>
<span class="sd">    :U_ex: Representation of the ice sheet as a Dolfin expression</span>
<span class="sd">  </span>
<span class="sd">  Original author: Doug Brinkerhoff: https://dbrinkerhoff.org/</span>
<span class="sd">  &quot;&quot;&quot;</span>
  
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_0</span><span class="p">,</span> <span class="n">U_ex</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">m_0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">U_ex</span> <span class="o">=</span> <span class="n">U_ex</span>

  <span class="k">def</span> <span class="nf">weighted_smoothing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_errors</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Smooths the points contained within the mesh</span>

<span class="sd">    Args:</span>
<span class="sd">    </span>
<span class="sd">      :edge_errors:  Dolfin edge function containing the calculated</span>
<span class="sd">                     edge errors of the mesh</span>
<span class="sd">      :omega:        Weighting factor used to refine the mesh</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mesh</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>

    <span class="n">adjacent_points</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1">#Create copies of the x coordinates</span>
    <span class="n">new_x</span>          <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">coord</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">new_y</span>          <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">coord</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">exterior_point</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vertices</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
      <span class="n">adjacent_points</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">index</span><span class="p">()]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">facets</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
      <span class="n">vert</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">entities</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">ext</span>  <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">exterior</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">adjacent_points</span><span class="p">[</span><span class="n">vert</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">vert</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">edge_errors</span><span class="p">[</span><span class="n">e</span><span class="p">]))</span>
        <span class="n">adjacent_points</span><span class="p">[</span><span class="n">vert</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">vert</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">edge_errors</span><span class="p">[</span><span class="n">e</span><span class="p">]))</span>
      <span class="n">exterior_point</span><span class="p">[</span><span class="n">vert</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ext</span>
      <span class="n">exterior_point</span><span class="p">[</span><span class="n">vert</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ext</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">adjacent_points</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="n">index</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
      <span class="n">x</span>       <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">y</span>       <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">x_sum</span>   <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">y_sum</span>   <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">wgt_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">kbar</span>    <span class="o">=</span> <span class="mf">0.0</span>

      <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">x_p</span>   <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_p</span>   <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">kbar</span> <span class="o">+=</span> <span class="mf">1.</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">*</span> <span class="n">error</span><span class="o">/</span><span class="n">pl</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">x_p</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">y_p</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> 
      <span class="n">kbar</span> <span class="o">=</span> <span class="mf">0.0</span> 

      <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">x_p</span>      <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_p</span>      <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">error</span>    <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">k_ij</span>     <span class="o">=</span> <span class="n">error</span><span class="o">/</span><span class="n">pl</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">x_p</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">y_p</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
        <span class="n">x_sum</span>   <span class="o">+=</span> <span class="p">(</span><span class="n">k_ij</span><span class="o">-</span><span class="n">kbar</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_p</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y_sum</span>   <span class="o">+=</span> <span class="p">(</span><span class="n">k_ij</span><span class="o">-</span><span class="n">kbar</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_p</span><span class="o">-</span><span class="n">y</span><span class="p">)</span>
        <span class="n">wgt_sum</span> <span class="o">+=</span> <span class="n">k_ij</span>
        
      <span class="k">if</span> <span class="ow">not</span> <span class="n">exterior_point</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
        <span class="n">new_x</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">omega</span> <span class="o">*</span> <span class="n">x_sum</span> <span class="o">/</span> <span class="n">wgt_sum</span>
        <span class="n">new_y</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">omega</span> <span class="o">*</span> <span class="n">y_sum</span> <span class="o">/</span> <span class="n">wgt_sum</span>

    <span class="k">return</span> <span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span> 

  <span class="k">def</span> <span class="nf">get_edge_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the error estimates of the expression projected into the mesh.</span>
<span class="sd">    </span>
<span class="sd">    :rtype: Dolfin edge function containing the edge errors of the mesh</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mesh</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>
    
    <span class="n">V</span>     <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">Hxx</span>   <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Hxy</span>   <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Hyy</span>   <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">phi</span>   <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    
    <span class="n">edge_errors</span> <span class="o">=</span> <span class="n">EdgeFunction</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>

    <span class="n">U</span>    <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U_ex</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
    <span class="n">a_xx</span> <span class="o">=</span> <span class="n">Hxx</span> <span class="o">*</span> <span class="n">phi</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">L_xx</span> <span class="o">=</span> <span class="o">-</span> <span class="n">U</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">phi</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>

    <span class="n">a_xy</span> <span class="o">=</span> <span class="n">Hxy</span> <span class="o">*</span> <span class="n">phi</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">L_xy</span> <span class="o">=</span> <span class="o">-</span> <span class="n">U</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">phi</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>

    <span class="n">a_yy</span> <span class="o">=</span> <span class="n">Hyy</span> <span class="o">*</span> <span class="n">phi</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">L_yy</span> <span class="o">=</span> <span class="o">-</span> <span class="n">U</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">phi</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>       

    <span class="n">Hxx</span>  <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Hxy</span>  <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Hyy</span>  <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
         
    <span class="n">Mxx</span>  <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Mxy</span>  <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Myy</span>  <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
  
    <span class="n">solve</span><span class="p">(</span><span class="n">a_xx</span> <span class="o">==</span> <span class="n">L_xx</span><span class="p">,</span> <span class="n">Hxx</span><span class="p">)</span>
    <span class="n">solve</span><span class="p">(</span><span class="n">a_xy</span> <span class="o">==</span> <span class="n">L_xy</span><span class="p">,</span> <span class="n">Hxy</span><span class="p">)</span>
    <span class="n">solve</span><span class="p">(</span><span class="n">a_yy</span> <span class="o">==</span> <span class="n">L_yy</span><span class="p">,</span> <span class="n">Hyy</span><span class="p">)</span>
    <span class="n">e_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vertices</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
      <span class="n">idx</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">index</span><span class="p">()</span>
      <span class="n">pt</span>  <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">point</span><span class="p">()</span>
      <span class="n">x</span>   <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
      <span class="n">y</span>   <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
          
      <span class="n">a</span>   <span class="o">=</span> <span class="n">Hxx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
      <span class="n">b</span>   <span class="o">=</span> <span class="n">Hxy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
      <span class="n">d</span>   <span class="o">=</span> <span class="n">Hyy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

      <span class="n">H_local</span> <span class="o">=</span> <span class="p">([[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">],</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">d</span><span class="p">]])</span>

      <span class="n">l</span><span class="p">,</span> <span class="n">ve</span>   <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">H_local</span><span class="p">)</span>
      <span class="n">M</span>       <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ve</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">l</span><span class="p">))),</span> <span class="n">ve</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>       

      <span class="n">Mxx</span><span class="o">.</span><span class="n">vector</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">Mxy</span><span class="o">.</span><span class="n">vector</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">Myy</span><span class="o">.</span><span class="n">vector</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">e_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
      <span class="n">I</span><span class="p">,</span> <span class="n">J</span>  <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">entities</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">x_I</span>   <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">I</span><span class="p">,:]</span>
      <span class="n">x_J</span>   <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">J</span><span class="p">,:]</span>
      <span class="n">M_I</span>   <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">Mxx</span><span class="o">.</span><span class="n">vector</span><span class="p">()[</span><span class="n">I</span><span class="p">],</span> <span class="n">Mxy</span><span class="o">.</span><span class="n">vector</span><span class="p">()[</span><span class="n">I</span><span class="p">]],</span>
                       <span class="p">[</span><span class="n">Mxy</span><span class="o">.</span><span class="n">vector</span><span class="p">()[</span><span class="n">I</span><span class="p">],</span> <span class="n">Myy</span><span class="o">.</span><span class="n">vector</span><span class="p">()[</span><span class="n">I</span><span class="p">]]])</span> 
      <span class="n">M_J</span>   <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">Mxx</span><span class="o">.</span><span class="n">vector</span><span class="p">()[</span><span class="n">J</span><span class="p">],</span> <span class="n">Mxy</span><span class="o">.</span><span class="n">vector</span><span class="p">()[</span><span class="n">J</span><span class="p">]],</span>
                       <span class="p">[</span><span class="n">Mxy</span><span class="o">.</span><span class="n">vector</span><span class="p">()[</span><span class="n">J</span><span class="p">],</span> <span class="n">Myy</span><span class="o">.</span><span class="n">vector</span><span class="p">()[</span><span class="n">J</span><span class="p">]]])</span>
      <span class="n">M</span>     <span class="o">=</span> <span class="p">(</span><span class="n">M_I</span> <span class="o">+</span> <span class="n">M_J</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
      <span class="n">dX</span>    <span class="o">=</span> <span class="n">x_I</span> <span class="o">-</span> <span class="n">x_J</span>
      <span class="n">error</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dX</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span> <span class="n">dX</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
      
      <span class="n">e_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
      <span class="n">edge_errors</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span>
    
    <span class="k">return</span> <span class="n">edge_errors</span>

  <span class="k">def</span> <span class="nf">refine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_errors</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">1.4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function iterates through the cells in the mesh, then refines</span>
<span class="sd">    the mesh based on the relative error and the cell&#39;s location in the</span>
<span class="sd">    mesh.</span>
<span class="sd">    </span>
<span class="sd">    :param edge_errors : Dolfin edge function containing edge errors of </span>
<span class="sd">                         of the current mesh.</span>
<span class="sd">    :param gamma       : Scaling factor for determining which edges need be </span>
<span class="sd">                         refined.  This is determined by the average error </span>
<span class="sd">                         of the edge_errors variable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span>
    
    <span class="n">mesh</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">avg_error</span>                 <span class="o">=</span> <span class="n">edge_errors</span><span class="o">.</span><span class="n">array</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">error_sorted_edge_indices</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">edge_errors</span><span class="o">.</span><span class="n">array</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">refine_edge</span>               <span class="o">=</span> <span class="n">FacetFunction</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
      <span class="n">refine_edge</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_errors</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">gamma</span><span class="o">*</span><span class="n">avg_error</span>

    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">coordinates</span><span class="p">())</span>      
    <span class="n">current_new_vertex</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
    <span class="n">cells_to_delete</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_cells</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">refine_edge</span><span class="o">.</span><span class="n">array</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()):</span>
      <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">facets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">refine_edge</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">index</span><span class="p">()</span><span class="o">==</span><span class="n">error_sorted_edge_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
          <span class="n">adjacent_cells</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">entities</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
          <span class="n">adjacent_vertices</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">entities</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">c</span> <span class="ow">in</span> <span class="n">cells_to_delete</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">adjacent_cells</span><span class="p">]):</span>
            <span class="n">new_x</span><span class="p">,</span><span class="n">new_y</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">midpoint</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span><span class="n">e</span><span class="o">.</span><span class="n">midpoint</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">coordinates</span><span class="p">,[</span><span class="n">new_x</span><span class="p">,</span><span class="n">new_y</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">adjacent_cells</span><span class="p">:</span>
              <span class="n">off_facet_vertex</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">cells</span><span class="p">()[</span><span class="n">c</span><span class="p">])</span>
              <span class="p">[</span><span class="n">off_facet_vertex</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">adjacent_vertices</span><span class="p">]</span>
              <span class="k">for</span> <span class="n">on_facet_vertex</span> <span class="ow">in</span> <span class="n">adjacent_vertices</span><span class="p">:</span>
                <span class="n">new_cell</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="n">current_new_vertex</span><span class="p">,</span><span class="n">off_facet_vertex</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">on_facet_vertex</span><span class="p">])</span>
                <span class="n">new_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_cell</span><span class="p">)</span>
              <span class="n">cells_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">current_new_vertex</span><span class="o">+=</span><span class="mi">1</span>
      <span class="n">error_sorted_edge_indices</span> <span class="o">=</span> <span class="n">error_sorted_edge_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">old_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">cells</span><span class="p">()</span>
    <span class="n">keep_cell</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">old_cells</span><span class="p">))</span>
    <span class="n">keep_cell</span><span class="p">[</span><span class="n">cells_to_delete</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">old_cells_parsed</span> <span class="o">=</span> <span class="n">old_cells</span><span class="p">[</span><span class="n">keep_cell</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">)]</span>
    <span class="n">all_cells</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">old_cells_parsed</span><span class="p">,</span><span class="n">new_cells</span><span class="p">))</span>
    <span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_cells</span><span class="p">)</span>

    <span class="n">e</span> <span class="o">=</span> <span class="n">MeshEditor</span><span class="p">()</span>
    <span class="n">refined_mesh</span> <span class="o">=</span> <span class="n">Mesh</span><span class="p">()</span>
    <span class="n">e</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">refined_mesh</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">dim</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="p">()</span><span class="o">.</span><span class="n">dim</span><span class="p">())</span>
    <span class="n">e</span><span class="o">.</span><span class="n">init_vertices</span><span class="p">(</span><span class="n">current_new_vertex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coordinates</span><span class="p">):</span>
      <span class="n">e</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  
    <span class="n">e</span><span class="o">.</span><span class="n">init_cells</span><span class="p">(</span><span class="n">n_cells</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_cells</span><span class="p">):</span>
      <span class="n">e</span><span class="o">.</span><span class="n">add_cell</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uintc&#39;</span><span class="p">))</span>

    <span class="n">e</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">refined_mesh</span><span class="o">.</span><span class="n">order</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">refined_mesh</span> 
 
  <span class="k">def</span> <span class="nf">extrude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">workspace_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">n_processors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function writes the refinements to the mesh to msh files and</span>
<span class="sd">    extrudes the mesh</span>

<span class="sd">    Args:</span>
<span class="sd">    </span>
<span class="sd">      :n_layers:       Number of layers in the mesh</span>
<span class="sd">      :workspace_path: Path to the location where the refined meshes</span>
<span class="sd">                       will be written</span>
<span class="sd">      :n_processors:   Number of processers utilized in the extrusion</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_layers</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">write_gmsh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">workspace_path</span> <span class="o">+</span> <span class="s2">&quot;/2dmesh.msh&quot;</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">workspace_path</span> <span class="o">+</span> <span class="s2">&quot;/2dmesh.geo&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Merge </span><span class="se">\&quot;</span><span class="s2">2dmesh.msh</span><span class="se">\&quot;</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Extrude {0,0,1} {Surface</span><span class="si">{0}</span><span class="s2">; Layers{&quot;</span> <span class="o">+</span> <span class="n">layers</span> <span class="o">+</span> <span class="s2">&quot;};}&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;Extruding mesh (This could take a while).&quot;</span>

    <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;mpirun -np </span><span class="si">{0:d}</span><span class="s2"> gmsh &quot;</span> <span class="o">+</span> <span class="n">workspace_path</span> <span class="o">+</span> <span class="s2">&quot;/2dmesh.geo -3 -o &quot;</span> \
             <span class="o">+</span> <span class="n">workspace_path</span> <span class="o">+</span> <span class="s2">&quot;/3dmesh.msh -format msh -v 0&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_processors</span><span class="p">))</span>

    <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;dolfin-convert &quot;</span> <span class="o">+</span> <span class="n">workspace_path</span> <span class="o">+</span> <span class="s2">&quot;/3dmesh.msh &quot;</span> \
             <span class="o">+</span> <span class="n">workspace_path</span> <span class="o">+</span> <span class="s2">&quot;/3dmesh.xml&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>




<span class="k">def</span> <span class="nf">write_gmsh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span><span class="n">path</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  This function iterates through the mesh and writes a file to the specified</span>
<span class="sd">  path</span>

<span class="sd">  Args:</span>
<span class="sd">  </span>
<span class="sd">    :mesh: Mesh that is to be written to a file</span>
<span class="sd">    :path: Path to write the mesh file to</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">output</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
  
  <span class="n">cell_type</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">type</span><span class="p">()</span><span class="o">.</span><span class="n">cell_type</span><span class="p">()</span>

  <span class="n">nodes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>
  <span class="n">n_nodes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()</span>

  <span class="n">nodes</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">nodes</span><span class="p">,</span><span class="n">pl</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_nodes</span><span class="p">,</span><span class="mi">3</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">coordinates</span><span class="p">())[</span><span class="mi">1</span><span class="p">]))))</span>

  <span class="n">cells</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">cells</span><span class="p">()</span>
  <span class="n">n_cells</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">num_cells</span><span class="p">()</span>

  <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;$MeshFormat</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> 
        <span class="s2">&quot;2.2 0 8</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
         <span class="s2">&quot;$EndMeshFormat</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
         <span class="s2">&quot;$Nodes </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
         <span class="s2">&quot;</span><span class="si">{0:d}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_nodes</span><span class="p">))</span>

  <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodes</span><span class="p">):</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:d}</span><span class="s2"> </span><span class="si">{1:g}</span><span class="s2"> </span><span class="si">{2:g}</span><span class="s2"> </span><span class="si">{3:g}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

  <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;$EndNodes</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;$Elements</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> 
          <span class="s2">&quot;</span><span class="si">{0:d}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_cells</span><span class="p">))</span>

  <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">cell</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cells</span><span class="p">):</span>
    <span class="c1">#if cell_type == 1:</span>
    <span class="c1">#  output.write(&quot;{0:d} 1 0 {1:d} {2:d}\n&quot;.format(ii+1,int(cell[0]+1),int(cell[1]+1)))</span>
    <span class="k">if</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:d}</span><span class="s2"> 2 0 </span><span class="si">{1:d}</span><span class="s2"> </span><span class="si">{2:d}</span><span class="s2"> </span><span class="si">{3:d}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
    <span class="c1">#elif cell_type == 3:</span>
    <span class="c1">#  output.write(&quot;{0:d} 4 0 {1:d} {2:d} {3:d} {4:d}\n&quot;.format(ii+1,int(cell[0]+1),int(cell[1]+1),int(cell[2]+1),int(cell[3]+1)))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="nb">print</span> <span class="s2">&quot;Unknown cell type&quot;</span>
  
  <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;$EndElements</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>




<span class="k">def</span> <span class="nf">generate_expression_from_gridded_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ky</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  This function creates a dolfin 2D expression from data input</span>

<span class="sd">  Args:</span>
<span class="sd">  </span>
<span class="sd">    :x:   List of x coordinates</span>
<span class="sd">    :y:   List of y coordinates</span>
<span class="sd">    :var: List of values associated with each x and y coordinate pair</span>

<span class="sd">  Returns:</span>

<span class="sd">    :rtype: A dolfin Expression object representing the data</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">RectBivariateSpline</span>
  <span class="n">interpolant</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">var</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">kx</span><span class="o">=</span><span class="n">kx</span><span class="p">,</span><span class="n">ky</span><span class="o">=</span><span class="n">ky</span><span class="p">)</span>
  <span class="k">class</span> <span class="nc">DolfinExpression</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">values</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
      <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolant</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

  <span class="k">return</span> <span class="n">DolfinExpression</span>




<div class="viewcode-block" id="plot_variable"><a class="viewcode-back" href="../output.html#helper.plot_variable">[docs]</a><span class="k">def</span> <span class="nf">plot_variable</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">direc</span><span class="p">,</span> 
                  <span class="n">figsize</span>             <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span>
                  <span class="n">cmap</span>                <span class="o">=</span> <span class="s1">&#39;gist_yarg&#39;</span><span class="p">,</span>
                  <span class="n">scale</span>               <span class="o">=</span> <span class="s1">&#39;lin&#39;</span><span class="p">,</span>
                  <span class="n">numLvls</span>             <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
                  <span class="n">levels</span>              <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">levels_2</span>            <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">umin</span>                <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">umax</span>                <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">vec_scale</span>           <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">tp</span>                  <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">tpAlpha</span>             <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                  <span class="n">show</span>                <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">hide_ax_tick_labels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">xlabel</span>              <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">,</span>
                  <span class="n">ylabel</span>              <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">,</span>
                  <span class="n">equal_axes</span>          <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">title</span>               <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                  <span class="n">hide_axis</span>           <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">colorbar_loc</span>        <span class="o">=</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span>
                  <span class="n">contour_type</span>        <span class="o">=</span> <span class="s1">&#39;filled&#39;</span><span class="p">,</span>
                  <span class="n">extend</span>              <span class="o">=</span> <span class="s1">&#39;neither&#39;</span><span class="p">,</span>
                  <span class="n">ext</span>                 <span class="o">=</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">,</span>
                  <span class="n">res</span>                 <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
                  <span class="n">cb</span>                  <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">cb_format</span>           <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.1e</span><span class="s1">&#39;</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">vec</span>  <span class="o">=</span> <span class="kc">False</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">ufl_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">indexed</span><span class="o">.</span><span class="n">Indexed</span><span class="p">:</span>
      <span class="n">out</span>    <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">out</span>    <span class="o">=</span> <span class="n">u</span>
    <span class="n">vec</span>      <span class="o">=</span> <span class="kc">True</span>
    <span class="n">v</span>        <span class="o">=</span> <span class="mi">0</span>
    <span class="n">mesh</span>     <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span><span class="o">.</span><span class="n">mesh</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
      <span class="n">kv</span>  <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">compute_vertex_values</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
      <span class="n">v</span>  <span class="o">+=</span> <span class="n">kv</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">)</span>
    <span class="n">v0</span>       <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compute_vertex_values</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">v1</span>       <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">compute_vertex_values</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">v2_mag</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">v0</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">)</span>
    <span class="n">v0</span>       <span class="o">=</span> <span class="n">v0</span> <span class="o">/</span> <span class="n">v2_mag</span>
    <span class="n">v1</span>       <span class="o">=</span> <span class="n">v1</span> <span class="o">/</span> <span class="n">v2_mag</span>
  <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">ufl_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">mesh</span>     <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span><span class="o">.</span><span class="n">mesh</span><span class="p">()</span>
    <span class="n">v</span>        <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">compute_vertex_values</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
  <span class="n">x</span>    <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()[:,</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">y</span>    <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()[:,</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">t</span>    <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">cells</span><span class="p">()</span>
  
  <span class="n">d</span>    <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">direc</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
 
  <span class="c1">#=============================================================================</span>
  <span class="c1"># plotting :</span>
  <span class="k">if</span> <span class="n">umin</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">vmin</span> <span class="o">=</span> <span class="n">umin</span>
  <span class="k">elif</span> <span class="n">levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">vmin</span> <span class="o">=</span> <span class="n">levels</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">vmin</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

  <span class="k">if</span> <span class="n">umax</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">umax</span>
  <span class="k">elif</span> <span class="n">levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">levels</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
  
  <span class="c1"># set the extended colormap :  </span>
  <span class="n">cmap</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
  <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
  
  <span class="c1"># countour levels :</span>
  <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">levels</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">vmin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">vmax</span><span class="p">),</span> <span class="n">numLvls</span><span class="p">)</span>
    <span class="c1">#v[v &lt; vmin] = vmin + 2e-16</span>
    <span class="c1">#v[v &gt; vmax] = vmax - 2e-16</span>
    <span class="n">formatter</span>   <span class="o">=</span> <span class="n">LogFormatter</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">labelOnlyBase</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">norm</span>        <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">()</span>
  
  <span class="c1"># countour levels :</span>
  <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;sym_log&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">levels</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">numLvls</span><span class="p">)</span>
    <span class="c1">#v[v &lt; vmin] = vmin + 2e-16</span>
    <span class="c1">#v[v &gt; vmax] = vmax - 2e-16</span>
    <span class="n">formatter</span>   <span class="o">=</span> <span class="n">LogFormatter</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">labelOnlyBase</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">norm</span>        <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">SymLogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                                    <span class="n">linscale</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
  
  <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;lin&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">levels</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">numLvls</span><span class="p">)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
  
  <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;bool&#39;</span><span class="p">:</span>
    <span class="n">v</span><span class="p">[</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">levels</span>  <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">norm</span>    <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>

  <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
  <span class="n">ax</span>  <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">hide_ax_tick_labels</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
  <span class="k">if</span> <span class="n">hide_axis</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">equal_axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    
  <span class="k">if</span> <span class="n">contour_type</span> <span class="o">==</span> <span class="s1">&#39;filled&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">!=</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
      <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                         <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="n">extend</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                         <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">contour_type</span> <span class="o">==</span> <span class="s1">&#39;lines&#39;</span><span class="p">:</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tricontour</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                       <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span> 
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cs</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">get_linestyle</span><span class="p">()</span> <span class="o">!=</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]:</span>
        <span class="n">line</span><span class="o">.</span><span class="n">set_linestyle</span><span class="p">([(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span>
        <span class="n">line</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">levels_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">cs2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tricontour</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels_2</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                          <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;0.30&#39;</span><span class="p">)</span> 
      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cs2</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">get_linestyle</span><span class="p">()</span> <span class="o">!=</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]:</span>
          <span class="n">line</span><span class="o">.</span><span class="n">set_linestyle</span><span class="p">([(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span>
          <span class="n">line</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;#c1000e&#39;</span><span class="p">)</span>
          <span class="n">line</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span><span class="p">)</span>


  <span class="k">if</span> <span class="n">vec</span><span class="p">:</span>
    <span class="n">q</span>  <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;middle&#39;</span><span class="p">,</span>
                                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                 <span class="n">scale</span><span class="o">=</span><span class="n">vec_scale</span><span class="p">,</span>
                                 <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span>
                                 <span class="n">headwidth</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> 
                                 <span class="n">headlength</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> 
                                 <span class="n">headaxislength</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span>
  
  <span class="c1"># plot triangles :</span>
  <span class="k">if</span> <span class="n">tp</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">triplot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">tpAlpha</span><span class="p">)</span>
  
  <span class="c1"># this enforces equal axes no matter what (yeah, a hack) : </span>
  <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

  <span class="c1"># include colorbar :</span>
  <span class="k">if</span> <span class="n">cb</span> <span class="ow">and</span> <span class="n">scale</span> <span class="o">!=</span> <span class="s1">&#39;bool&#39;</span> <span class="ow">and</span> <span class="n">contour_type</span> <span class="o">!=</span> <span class="s1">&#39;lines&#39;</span><span class="p">:</span>
    <span class="n">cax</span>  <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="s2">&quot;3%&quot;</span><span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> 
                        <span class="n">ticks</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">cb_format</span><span class="p">)</span> 
  
  <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.95</span><span class="p">])</span>
  
  <span class="c1">#pl.mpl.rcParams[&#39;axes.titlesize&#39;] = &#39;small&#39;</span>
  <span class="c1">#tit = plt.title(title)</span>

  <span class="c1"># title :</span>
  <span class="n">tit</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
  <span class="c1">#tit.set_fontsize(40)</span>

  <span class="n">d</span>     <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">direc</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">direc</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>




<div class="viewcode-block" id="plotIce"><a class="viewcode-back" href="../output.html#helper.plotIce">[docs]</a><span class="k">def</span> <span class="nf">plotIce</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">direc</span><span class="p">,</span> 
            <span class="n">u2</span>               <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">u2_levels</span>        <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">u2_color</span>         <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span>
            <span class="n">u2_linewidth</span>     <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="n">title</span>            <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">cmap</span>             <span class="o">=</span> <span class="s1">&#39;gist_yarg&#39;</span><span class="p">,</span>
            <span class="n">scale</span>            <span class="o">=</span> <span class="s1">&#39;lin&#39;</span><span class="p">,</span>
            <span class="n">umin</span>             <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">umax</span>             <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">numLvls</span>          <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
            <span class="n">drawGridLabels</span>   <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">levels</span>           <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">levels_2</span>         <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">tp</span>               <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">tpAlpha</span>          <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="n">contour_type</span>     <span class="o">=</span> <span class="s1">&#39;filled&#39;</span><span class="p">,</span>
            <span class="n">params</span>           <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">extend</span>           <span class="o">=</span> <span class="s1">&#39;neither&#39;</span><span class="p">,</span>
            <span class="n">show</span>             <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">ext</span>              <span class="o">=</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">,</span>
            <span class="n">res</span>              <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
            <span class="n">cb</span>               <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">cb_format</span>        <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.1e</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">zoom_box</span>         <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">zoom_box_kwargs</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">plot_pts</span>         <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">plot_texts</span>       <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">plot_continent</span>   <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">cont_plot_params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">drawcoastlines</span>   <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">box_params</span>       <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Args:</span>

<span class="sd">    :di:      DataInput object with desired projection</span>
<span class="sd">    :u:       solution to plot; can be either a function on a 2D mesh, or a</span>
<span class="sd">              string key to matrix variable in ``di``.data.</span>
<span class="sd">    :name:    title of the plot, latex accepted</span>
<span class="sd">    :direc:   directory string location to save image.</span>
<span class="sd">    :cmap:    colormap to use - see images directory for sample and name</span>
<span class="sd">    :scale:   scale to plot, either &#39;log&#39;, &#39;lin&#39;, or &#39;bool&#39;</span>
<span class="sd">    :numLvls: number of levels for field values</span>
<span class="sd">    :levels:  manual levels, if desired.</span>
<span class="sd">    :tp:      boolean determins plotting of triangle overlay</span>
<span class="sd">    :tpAlpha: alpha level of triangles 0.0 (transparent) - 1.0 (opaque)</span>
<span class="sd">    :extends: for the colorbar, extend upper range and may be [&quot;neither&quot;,</span>
<span class="sd">              &quot;both&quot;, &quot;min&quot;, &quot;max&quot;]. default is &quot;neither&quot;.</span>

<span class="sd">    for plotting the zoom-box, make ``zoom_box`` = True and supply dict</span>
<span class="sd">    *zoom_box_kwargs* with parameters</span>
<span class="sd">    </span>
<span class="sd">    :zoom:             ammount to zoom </span>
<span class="sd">    :loc:              location of box</span>
<span class="sd">    :loc1:             loc of first line</span>
<span class="sd">    :loc2:             loc of second line</span>
<span class="sd">    :x1:               first x-coord</span>
<span class="sd">    :y1:               first y-coord</span>
<span class="sd">    :x2:               second x-coord</span>
<span class="sd">    :y2:               second y-coord</span>
<span class="sd">    :scale_font_color: scale font color</span>
<span class="sd">    :scale_length:     scale length in km</span>
<span class="sd">    :scale_loc:        1=top, 2=bottom</span>
<span class="sd">    :plot_grid:        plot the triangles</span>
<span class="sd">    :axes_color:       color of axes</span>
<span class="sd">    :plot_points:      dict of points to plot</span>
<span class="sd">  </span>
<span class="sd">  Returns:</span>
<span class="sd"> </span>
<span class="sd">    A sigle *direc/name.ext* in the source directory.</span>
<span class="sd">  </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">#FIXME: re-factor this method to take generic kwargs for each method called,</span>
  <span class="c1">#       and generally improve readability.</span>
  <span class="c1"># get the original projection coordinates and data :</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: plotting </span><span class="si">%s</span><span class="s2">&#39;s </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> field data directly :::&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;242&#39;</span><span class="p">)</span>
    <span class="n">vx</span><span class="p">,</span><span class="n">vy</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">di</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
    <span class="n">v</span>       <span class="o">=</span> <span class="n">di</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>

  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">Function</span><span class="p">)</span> \
    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;::: plotting FEniCS Function </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> :::&quot;</span> <span class="o">%</span> <span class="n">name</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;242&#39;</span><span class="p">)</span>
    <span class="n">mesh</span>  <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span><span class="o">.</span><span class="n">mesh</span><span class="p">()</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>
    <span class="n">fi</span>    <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">cells</span><span class="p">()</span>
    <span class="n">v</span>     <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">compute_vertex_values</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">vx</span>    <span class="o">=</span> <span class="n">coord</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">vy</span>    <span class="o">=</span> <span class="n">coord</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

  <span class="c1"># get the projection info :  </span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;pyproj_Proj&#39;</span> <span class="ow">in</span> <span class="n">di</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> \
     <span class="ow">and</span> <span class="s1">&#39;continent&#39;</span> <span class="ow">in</span> <span class="n">di</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">lon</span><span class="p">,</span><span class="n">lat</span> <span class="o">=</span> <span class="n">di</span><span class="p">[</span><span class="s1">&#39;pyproj_Proj&#39;</span><span class="p">](</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cont</span>    <span class="o">=</span> <span class="n">di</span><span class="p">[</span><span class="s1">&#39;continent&#39;</span><span class="p">]</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">DataInput</span><span class="p">):</span>
    <span class="n">lon</span><span class="p">,</span><span class="n">lat</span> <span class="o">=</span> <span class="n">di</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cont</span>    <span class="o">=</span> <span class="n">di</span><span class="o">.</span><span class="n">cont</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&gt;&gt;&gt; plotIce REQUIRES A &#39;DataFactory&#39; DICTIONARY FOR &quot;</span> <span class="o">+</span> \
        <span class="s2">&quot;PROJECTION STORED AS KEY &#39;pyproj_Proj&#39; AND THE CONTINENT TYPE &quot;</span> <span class="o">+</span> \
        <span class="s2">&quot;STORED AS KEY &#39;continent&#39; &lt;&lt;&lt;&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  
  <span class="c1"># Antarctica :</span>
  <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">cont</span> <span class="ow">is</span> <span class="s1">&#39;antarctica&#39;</span><span class="p">:</span>
      <span class="n">w</span>   <span class="o">=</span> <span class="mf">5513335.22665</span>
      <span class="n">h</span>   <span class="o">=</span> <span class="mf">4602848.6605</span>
      <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
      <span class="n">ax</span>  <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

      <span class="n">lon_0</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">lat_0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">90</span>
      
      <span class="c1"># new projection :</span>
      <span class="n">m</span> <span class="o">=</span> <span class="n">Basemap</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> 
                  <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;stere&#39;</span><span class="p">,</span> <span class="n">lat_ts</span><span class="o">=-</span><span class="mi">71</span><span class="p">,</span> 
                  <span class="n">lon_0</span><span class="o">=</span><span class="n">lon_0</span><span class="p">,</span> <span class="n">lat_0</span><span class="o">=</span><span class="n">lat_0</span><span class="p">)</span>

      <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.015</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span>
    
      <span class="c1"># draw lat/lon grid lines every 5 degrees.</span>
      <span class="c1"># labels = [left,right,top,bottom]</span>
      <span class="k">if</span> <span class="n">drawGridLabels</span><span class="p">:</span>
        <span class="n">mer_lab</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span> 
        <span class="n">par_lab</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">mer_lab</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
        <span class="n">par_lab</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>

      <span class="n">m</span><span class="o">.</span><span class="n">drawmeridians</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">),</span>
                      <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
                      <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                      <span class="n">labels</span> <span class="o">=</span> <span class="n">mer_lab</span><span class="p">,</span>
                      <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">drawparallels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span> 
                      <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> 
                      <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                      <span class="n">labels</span> <span class="o">=</span> <span class="n">par_lab</span><span class="p">,</span>
                      <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">drawmapscale</span><span class="p">(</span><span class="o">-</span><span class="mi">130</span><span class="p">,</span> <span class="o">-</span><span class="mi">68</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> 
                     <span class="n">yoffset</span>  <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> 
                     <span class="n">barstyle</span> <span class="o">=</span> <span class="s1">&#39;fancy&#39;</span><span class="p">)</span>
 
    <span class="c1"># Greenland : </span>
    <span class="k">elif</span> <span class="n">cont</span> <span class="ow">is</span> <span class="s1">&#39;greenland&#39;</span><span class="p">:</span>
      <span class="n">w</span>   <span class="o">=</span> <span class="mf">1532453.49654</span>
      <span class="n">h</span>   <span class="o">=</span> <span class="mf">2644074.78236</span>
      <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
      <span class="n">ax</span>  <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    
      <span class="n">lon_0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">41.5</span>
      <span class="n">lat_0</span> <span class="o">=</span> <span class="mi">71</span>
      
      <span class="c1"># new projection :</span>
      <span class="n">m</span> <span class="o">=</span> <span class="n">Basemap</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> 
                  <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;stere&#39;</span><span class="p">,</span> <span class="n">lat_ts</span><span class="o">=</span><span class="mi">71</span><span class="p">,</span> 
                  <span class="n">lon_0</span><span class="o">=</span><span class="n">lon_0</span><span class="p">,</span> <span class="n">lat_0</span><span class="o">=</span><span class="n">lat_0</span><span class="p">)</span>

      <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.010</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span>
      
      <span class="k">if</span> <span class="n">drawGridLabels</span><span class="p">:</span>
        <span class="n">mer_lab</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
        <span class="n">par_lab</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">mer_lab</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
        <span class="n">par_lab</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
      
      <span class="c1"># draw lat/lon grid lines every 5 degrees.</span>
      <span class="c1"># labels = [left,right,top,bottom]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">drawmeridians</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
                      <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
                      <span class="n">labels</span> <span class="o">=</span> <span class="n">mer_lab</span><span class="p">,</span>
                      <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">drawparallels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span> 
                      <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> 
                      <span class="n">labels</span> <span class="o">=</span> <span class="n">par_lab</span><span class="p">,</span>
                      <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">drawmapscale</span><span class="p">(</span><span class="o">-</span><span class="mi">34</span><span class="p">,</span> <span class="mf">60.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.5</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> 
                     <span class="n">yoffset</span>  <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> 
                     <span class="n">barstyle</span> <span class="o">=</span> <span class="s1">&#39;fancy&#39;</span><span class="p">)</span>
    
  <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">llcrnrlat</span>      <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;llcrnrlat&#39;</span><span class="p">]</span>
    <span class="n">urcrnrlat</span>      <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;urcrnrlat&#39;</span><span class="p">]</span>
    <span class="n">llcrnrlon</span>      <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;llcrnrlon&#39;</span><span class="p">]</span>
    <span class="n">urcrnrlon</span>      <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;urcrnrlon&#39;</span><span class="p">]</span>
    <span class="n">scale_color</span>    <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;scale_color&#39;</span><span class="p">]</span>
    <span class="n">scale_length</span>   <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;scale_length&#39;</span><span class="p">]</span>
    <span class="n">scale_loc</span>      <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;scale_loc&#39;</span><span class="p">]</span>
    <span class="n">figsize</span>        <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;figsize&#39;</span><span class="p">]</span>
    <span class="n">lat_interval</span>   <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;lat_interval&#39;</span><span class="p">]</span>
    <span class="n">lon_interval</span>   <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;lon_interval&#39;</span><span class="p">]</span>
    <span class="n">plot_grid</span>      <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;plot_grid&#39;</span><span class="p">]</span>
    <span class="n">plot_scale</span>     <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;plot_scale&#39;</span><span class="p">]</span>
    <span class="n">axes_color</span>     <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;axes_color&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">cont</span> <span class="ow">is</span> <span class="s1">&#39;greenland&#39;</span><span class="p">:</span>
      <span class="n">lon_0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">41.5</span>
      <span class="n">lat_0</span> <span class="o">=</span>  <span class="mi">71</span>
    <span class="k">elif</span> <span class="n">cont</span> <span class="ow">is</span> <span class="s1">&#39;antarctica&#39;</span><span class="p">:</span>
      <span class="n">lon_0</span> <span class="o">=</span>  <span class="mi">0</span>
      <span class="n">lat_0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">90</span>

    <span class="n">fig</span>   <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">ax</span>    <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    
    <span class="c1"># new projection :</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Basemap</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">llcrnrlat</span><span class="o">=</span><span class="n">llcrnrlat</span><span class="p">,</span> <span class="n">urcrnrlat</span><span class="o">=</span><span class="n">urcrnrlat</span><span class="p">,</span>
                <span class="n">llcrnrlon</span><span class="o">=</span><span class="n">llcrnrlon</span><span class="p">,</span> <span class="n">urcrnrlon</span><span class="o">=</span><span class="n">urcrnrlon</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> 
                <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;stere&#39;</span><span class="p">,</span> <span class="n">lon_0</span><span class="o">=</span><span class="n">lon_0</span><span class="p">,</span> <span class="n">lat_0</span><span class="o">=</span><span class="n">lat_0</span><span class="p">)</span>

    <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.015</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span>
    
    <span class="c1"># draw lat/lon grid lines every degree.</span>
    <span class="c1"># labels = [left,right,top,bottom]</span>
    <span class="k">if</span> <span class="n">plot_grid</span><span class="p">:</span>
      <span class="n">m</span><span class="o">.</span><span class="n">drawmeridians</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="n">lon_interval</span><span class="p">),</span>
                      <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
                      <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                      <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                      <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">drawparallels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">lat_interval</span><span class="p">),</span> 
                      <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> 
                      <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                      <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                      <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">scale_loc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">y_fact</span> <span class="o">=</span> <span class="mf">1.8</span>
      <span class="n">x_fact</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">elif</span> <span class="n">scale_loc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">y_fact</span> <span class="o">=</span> <span class="mf">0.2</span>
      <span class="n">x_fact</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">elif</span> <span class="n">scale_loc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
      <span class="n">y_fact</span> <span class="o">=</span> <span class="mf">1.8</span>
      <span class="n">x_fact</span> <span class="o">=</span> <span class="mf">0.25</span>

    <span class="k">if</span> <span class="n">plot_scale</span> <span class="p">:</span>
      <span class="n">dx</span>         <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
      <span class="n">dy</span>         <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
      <span class="n">xmid</span>       <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">xmin</span> <span class="o">+</span> <span class="n">x_fact</span><span class="o">*</span><span class="n">dx</span>
      <span class="n">ymid</span>       <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ymin</span> <span class="o">+</span> <span class="n">y_fact</span><span class="o">*</span><span class="n">dy</span>
      <span class="n">slon</span><span class="p">,</span> <span class="n">slat</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">xmid</span><span class="p">,</span> <span class="n">ymid</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">drawmapscale</span><span class="p">(</span><span class="n">slon</span><span class="p">,</span> <span class="n">slat</span><span class="p">,</span> <span class="n">slon</span><span class="p">,</span> <span class="n">slat</span><span class="p">,</span> <span class="n">scale_length</span><span class="p">,</span> 
                     <span class="n">barstyle</span> <span class="o">=</span> <span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">fontcolor</span><span class="o">=</span><span class="n">scale_color</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="s1">&#39;right&#39;</span><span class="p">]:</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">axes_color</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
      
  <span class="k">else</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&gt;&gt;&gt; plotIce REQUIRES A &#39;dict&#39; OF SPECIFIC PARAMETERS FOR &#39;custom&#39; &lt;&lt;&lt;&quot;</span>
    <span class="n">print_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


  <span class="c1"># convert to new projection coordinates from lon,lat :</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">drawcoastlines</span><span class="p">:</span> 
    <span class="n">m</span><span class="o">.</span><span class="n">drawcoastlines</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
  <span class="c1">#m.shadedrelief()</span>
  <span class="c1">#m.bluemarble()</span>
  <span class="c1">#m.etopo()</span>
  
  <span class="k">if</span> <span class="n">plot_continent</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">cont</span> <span class="ow">is</span> <span class="s1">&#39;greenland&#39;</span><span class="p">:</span>
      <span class="n">llcrnrlat</span>  <span class="o">=</span> <span class="mi">57</span>
      <span class="n">urcrnrlat</span>  <span class="o">=</span> <span class="mf">80.1</span>
      <span class="n">llcrnrlon</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">57</span>
      <span class="n">urcrnrlon</span>  <span class="o">=</span> <span class="mi">15</span>
          
      <span class="n">axcont</span> <span class="o">=</span> <span class="n">inset_locator</span><span class="o">.</span><span class="n">inset_axes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">cont_plot_params</span><span class="p">)</span>
      <span class="n">axcont</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
      <span class="n">axcont</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    
      <span class="c1"># continent projection :</span>
      <span class="n">mc</span> <span class="o">=</span> <span class="n">Basemap</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axcont</span><span class="p">,</span> <span class="n">llcrnrlat</span><span class="o">=</span><span class="n">llcrnrlat</span><span class="p">,</span> <span class="n">urcrnrlat</span><span class="o">=</span><span class="n">urcrnrlat</span><span class="p">,</span>
                   <span class="n">llcrnrlon</span><span class="o">=</span><span class="n">llcrnrlon</span><span class="p">,</span> <span class="n">urcrnrlon</span><span class="o">=</span><span class="n">urcrnrlon</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> 
                   <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;stere&#39;</span><span class="p">,</span> <span class="n">lon_0</span><span class="o">=</span><span class="n">lon_0</span><span class="p">,</span> <span class="n">lat_0</span><span class="o">=</span><span class="n">lat_0</span><span class="p">)</span>
    
      <span class="n">mc</span><span class="o">.</span><span class="n">drawcoastlines</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
  
      <span class="n">x_c</span><span class="p">,</span> <span class="n">y_c</span>  <span class="o">=</span> <span class="n">mc</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>

      <span class="n">v_cont</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
      <span class="n">v_cont</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1.0</span>
      
      <span class="n">axcont</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">x_c</span><span class="p">,</span> <span class="n">y_c</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">v_cont</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Reds&#39;</span><span class="p">))</span>


  <span class="c1">#=============================================================================</span>
  <span class="c1"># plotting :</span>
  <span class="k">if</span> <span class="n">umin</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">vmin</span> <span class="o">=</span> <span class="n">umin</span>
  <span class="k">elif</span> <span class="n">levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">vmin</span> <span class="o">=</span> <span class="n">levels</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">umax</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">umax</span>
  <span class="k">elif</span> <span class="n">levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">levels</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
  
  <span class="c1"># set the extended colormap :  </span>
  <span class="n">cmap</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
  <span class="c1">#cmap.set_under(under)</span>
  <span class="c1">#cmap.set_over(over)</span>
  
  <span class="c1"># countour levels :</span>
  <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">levels</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">vmin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">vmax</span><span class="p">),</span> <span class="n">numLvls</span><span class="p">)</span>
    <span class="n">v</span><span class="p">[</span><span class="n">v</span> <span class="o">&lt;</span> <span class="n">vmin</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmin</span> <span class="o">+</span> <span class="mf">2e-16</span>
    <span class="n">v</span><span class="p">[</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">vmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmax</span> <span class="o">-</span> <span class="mf">2e-16</span>
    <span class="n">formatter</span>   <span class="o">=</span> <span class="n">LogFormatter</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">labelOnlyBase</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">norm</span>        <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">()</span>
  
  <span class="c1"># countour levels :</span>
  <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;sym_log&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">levels</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">numLvls</span><span class="p">)</span>
    <span class="n">v</span><span class="p">[</span><span class="n">v</span> <span class="o">&lt;</span> <span class="n">vmin</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmin</span> <span class="o">+</span> <span class="mf">2e-16</span>
    <span class="n">v</span><span class="p">[</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">vmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmax</span> <span class="o">-</span> <span class="mf">2e-16</span>
    <span class="n">formatter</span>   <span class="o">=</span> <span class="n">LogFormatter</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">labelOnlyBase</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">norm</span>        <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">SymLogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                                    <span class="n">linscale</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
  
  <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;lin&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">levels</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">numLvls</span><span class="p">)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
  
  <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;bool&#39;</span><span class="p">:</span>
    <span class="n">v</span><span class="p">[</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">levels</span>  <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">norm</span>    <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
  
  <span class="c1"># please do zoom in! </span>
  <span class="k">if</span> <span class="n">zoom_box</span><span class="p">:</span> 
    <span class="n">zoom</span>              <span class="o">=</span> <span class="n">zoom_box_kwargs</span><span class="p">[</span><span class="s1">&#39;zoom&#39;</span><span class="p">]</span>
    <span class="n">loc</span>               <span class="o">=</span> <span class="n">zoom_box_kwargs</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">]</span>
    <span class="n">loc1</span>              <span class="o">=</span> <span class="n">zoom_box_kwargs</span><span class="p">[</span><span class="s1">&#39;loc1&#39;</span><span class="p">]</span>
    <span class="n">loc2</span>              <span class="o">=</span> <span class="n">zoom_box_kwargs</span><span class="p">[</span><span class="s1">&#39;loc2&#39;</span><span class="p">]</span>
    <span class="n">llcrnrlat</span>         <span class="o">=</span> <span class="n">zoom_box_kwargs</span><span class="p">[</span><span class="s1">&#39;llcrnrlat&#39;</span><span class="p">]</span>
    <span class="n">urcrnrlat</span>         <span class="o">=</span> <span class="n">zoom_box_kwargs</span><span class="p">[</span><span class="s1">&#39;urcrnrlat&#39;</span><span class="p">]</span>
    <span class="n">llcrnrlon</span>         <span class="o">=</span> <span class="n">zoom_box_kwargs</span><span class="p">[</span><span class="s1">&#39;llcrnrlon&#39;</span><span class="p">]</span>
    <span class="n">urcrnrlon</span>         <span class="o">=</span> <span class="n">zoom_box_kwargs</span><span class="p">[</span><span class="s1">&#39;urcrnrlon&#39;</span><span class="p">]</span>
    <span class="n">plot_zoom_scale</span>   <span class="o">=</span> <span class="n">zoom_box_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_zoom_scale&#39;</span><span class="p">]</span>
    <span class="n">scale_font_color</span>  <span class="o">=</span> <span class="n">zoom_box_kwargs</span><span class="p">[</span><span class="s1">&#39;scale_font_color&#39;</span><span class="p">]</span>
    <span class="n">scale_length</span>      <span class="o">=</span> <span class="n">zoom_box_kwargs</span><span class="p">[</span><span class="s1">&#39;scale_length&#39;</span><span class="p">]</span>
    <span class="n">scale_loc</span>         <span class="o">=</span> <span class="n">zoom_box_kwargs</span><span class="p">[</span><span class="s1">&#39;scale_loc&#39;</span><span class="p">]</span>
    <span class="n">plot_grid</span>         <span class="o">=</span> <span class="n">zoom_box_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_grid&#39;</span><span class="p">]</span>
    <span class="n">axes_color</span>        <span class="o">=</span> <span class="n">zoom_box_kwargs</span><span class="p">[</span><span class="s1">&#39;axes_color&#39;</span><span class="p">]</span>
    <span class="n">zb_plot_pts</span>       <span class="o">=</span> <span class="n">zoom_box_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_points&#39;</span><span class="p">]</span>
    
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">llcrnrlon</span><span class="p">,</span> <span class="n">llcrnrlat</span><span class="p">)</span>
    <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">urcrnrlon</span><span class="p">,</span> <span class="n">urcrnrlat</span><span class="p">)</span>

    <span class="n">axins</span> <span class="o">=</span> <span class="n">inset_locator</span><span class="o">.</span><span class="n">zoomed_inset_axes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">zoom</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">)</span>
    <span class="n">inset_locator</span><span class="o">.</span><span class="n">mark_inset</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">axins</span><span class="p">,</span> <span class="n">loc1</span><span class="o">=</span><span class="n">loc1</span><span class="p">,</span> <span class="n">loc2</span><span class="o">=</span><span class="n">loc2</span><span class="p">,</span>
                             <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">axes_color</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="s1">&#39;right&#39;</span><span class="p">]:</span>
      <span class="n">axins</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">axes_color</span><span class="p">)</span>
      <span class="c1">#axins.spines[axis].set_linewidth(2)</span>

    <span class="k">if</span> <span class="n">scale_loc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">fact</span> <span class="o">=</span> <span class="mf">1.8</span>
    <span class="k">elif</span> <span class="n">scale_loc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">fact</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="n">dx</span>         <span class="o">=</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> 
    <span class="n">dy</span>         <span class="o">=</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> 
    <span class="n">xmid</span>       <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">dx</span>
    <span class="n">ymid</span>       <span class="o">=</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">fact</span><span class="o">*</span><span class="n">dy</span>
    <span class="n">slon</span><span class="p">,</span> <span class="n">slat</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">xmid</span><span class="p">,</span> <span class="n">ymid</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># new projection :</span>
    <span class="n">mn</span> <span class="o">=</span> <span class="n">Basemap</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axins</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> 
                 <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;stere&#39;</span><span class="p">,</span> <span class="n">lat_ts</span><span class="o">=</span><span class="n">lat_0</span><span class="p">,</span> 
                 <span class="n">lon_0</span><span class="o">=</span><span class="n">lon_0</span><span class="p">,</span> <span class="n">lat_0</span><span class="o">=</span><span class="n">lat_0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_zoom_scale</span><span class="p">:</span>
      <span class="n">mn</span><span class="o">.</span><span class="n">drawmapscale</span><span class="p">(</span><span class="n">slon</span><span class="p">,</span> <span class="n">slat</span><span class="p">,</span> <span class="n">slon</span><span class="p">,</span> <span class="n">slat</span><span class="p">,</span> <span class="n">scale_length</span><span class="p">,</span> 
                      <span class="n">yoffset</span>  <span class="o">=</span> <span class="mf">0.025</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dy</span><span class="p">,</span>
                      <span class="n">barstyle</span> <span class="o">=</span> <span class="s1">&#39;fancy&#39;</span><span class="p">,</span> <span class="n">fontcolor</span><span class="o">=</span><span class="n">scale_font_color</span><span class="p">)</span>
 
    <span class="k">if</span> <span class="n">drawcoastlines</span><span class="p">:</span> 
      <span class="n">mn</span><span class="o">.</span><span class="n">drawcoastlines</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
    
    <span class="n">axins</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="n">axins</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>

    <span class="n">axins</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">axins</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>


  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1">#cs = ax.pcolor(x, y, v, cmap=get_cmap(cmap), norm=norm)</span>
    <span class="k">if</span> <span class="n">contour_type</span> <span class="o">==</span> <span class="s1">&#39;filled&#39;</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">scale</span> <span class="o">!=</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> 
                         <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="n">extend</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> 
                         <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">zoom_box</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="o">!=</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
          <span class="n">axins</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> 
                         <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="n">extend</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">axins</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> 
                         <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">contour_type</span> <span class="o">==</span> <span class="s1">&#39;lines&#39;</span><span class="p">:</span>
      <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                      <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,)</span> 
      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cs</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">get_linestyle</span><span class="p">()</span> <span class="o">!=</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]:</span>
          <span class="n">line</span><span class="o">.</span><span class="n">set_linestyle</span><span class="p">([(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span>
          <span class="n">line</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
          <span class="n">line</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">levels_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cs2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels_2</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cs2</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">get_linestyle</span><span class="p">()</span> <span class="o">!=</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]:</span>
            <span class="n">line</span><span class="o">.</span><span class="n">set_linestyle</span><span class="p">([(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span>
            <span class="n">line</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;#c1000e&#39;</span><span class="p">)</span>
            <span class="n">line</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">zoom_box</span><span class="p">:</span>
        <span class="n">axins</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span> 
  
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">Function</span><span class="p">)</span> \
    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>
    <span class="c1">#cs = ax.tripcolor(x, y, fi, v, shading=&#39;gouraud&#39;, </span>
    <span class="c1">#                  cmap=get_cmap(cmap), norm=norm)</span>
    <span class="k">if</span> <span class="n">contour_type</span> <span class="o">==</span> <span class="s1">&#39;filled&#39;</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">scale</span> <span class="o">!=</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> 
                           <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="n">extend</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                           <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">zoom_box</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="o">!=</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
          <span class="n">axins</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="n">extend</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">axins</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">contour_type</span> <span class="o">==</span> <span class="s1">&#39;lines&#39;</span><span class="p">:</span>
      <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tricontour</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                         <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span> 
      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cs</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">get_linestyle</span><span class="p">()</span> <span class="o">!=</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]:</span>
          <span class="n">line</span><span class="o">.</span><span class="n">set_linestyle</span><span class="p">([(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span>
          <span class="n">line</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
          <span class="n">line</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">levels_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cs2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tricontour</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels_2</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                            <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;0.30&#39;</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cs2</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">get_linestyle</span><span class="p">()</span> <span class="o">!=</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]:</span>
            <span class="n">line</span><span class="o">.</span><span class="n">set_linestyle</span><span class="p">([(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span>
            <span class="n">line</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;#c1000e&#39;</span><span class="p">)</span>
            <span class="n">line</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">zoom_box</span><span class="p">:</span>
        <span class="n">axins</span><span class="o">.</span><span class="n">tricontour</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                         <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">axins</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.2f</span><span class="s1">&#39;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">u2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u2</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
      <span class="n">v2</span>   <span class="o">=</span> <span class="n">di</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">u2</span><span class="p">]</span>
      <span class="n">csu2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">u2_levels</span><span class="p">,</span> 
                        <span class="n">linewidths</span><span class="o">=</span><span class="n">u2_linewidth</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">u2_color</span><span class="p">)</span> 
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u2</span><span class="p">,</span> <span class="n">Function</span><span class="p">)</span> \
      <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u2</span><span class="p">,</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>
      <span class="n">v2</span> <span class="o">=</span> <span class="n">u2</span><span class="o">.</span><span class="n">compute_vertex_values</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
      <span class="n">csu2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tricontour</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="n">u2_linewidth</span><span class="p">,</span>
                           <span class="n">levels</span><span class="o">=</span><span class="n">u2_levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">u2_color</span><span class="p">)</span> 
    <span class="c1">#for line in csu2.collections:</span>
    <span class="c1">#  if line.get_linestyle() != [(None, None)]:</span>
    <span class="c1">#    line.set_linestyle([(None, None)])</span>

  <span class="k">if</span> <span class="n">plot_pts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">lat_a</span> <span class="o">=</span> <span class="n">plot_pts</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span>
    <span class="n">lon_a</span> <span class="o">=</span> <span class="n">plot_pts</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span>
    <span class="n">sty_a</span> <span class="o">=</span> <span class="n">plot_pts</span><span class="p">[</span><span class="s1">&#39;style&#39;</span><span class="p">]</span>
    <span class="n">clr_a</span> <span class="o">=</span> <span class="n">plot_pts</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">lat_i</span><span class="p">,</span> <span class="n">lon_i</span><span class="p">,</span> <span class="n">sty_i</span><span class="p">,</span> <span class="n">clr_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lat_a</span><span class="p">,</span> <span class="n">lon_a</span><span class="p">,</span> <span class="n">sty_a</span><span class="p">,</span> <span class="n">clr_a</span><span class="p">):</span>
      <span class="n">x_i</span><span class="p">,</span> <span class="n">y_i</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">lon_i</span><span class="p">,</span> <span class="n">lat_i</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_i</span><span class="p">,</span> <span class="n">y_i</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">clr_i</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">sty_i</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">plot_texts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">lat_a</span> <span class="o">=</span> <span class="n">plot_texts</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span>
    <span class="n">lon_a</span> <span class="o">=</span> <span class="n">plot_texts</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span>
    <span class="n">txt_a</span> <span class="o">=</span> <span class="n">plot_texts</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
    <span class="n">clr_a</span> <span class="o">=</span> <span class="n">plot_texts</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">lat_i</span><span class="p">,</span> <span class="n">lon_i</span><span class="p">,</span> <span class="n">txt_i</span><span class="p">,</span> <span class="n">clr_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lat_a</span><span class="p">,</span> <span class="n">lon_a</span><span class="p">,</span> <span class="n">txt_a</span><span class="p">,</span> <span class="n">clr_a</span><span class="p">):</span>
      <span class="n">x_i</span><span class="p">,</span> <span class="n">y_i</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">lon_i</span><span class="p">,</span> <span class="n">lat_i</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x_i</span><span class="p">,</span> <span class="n">y_i</span><span class="p">,</span> <span class="n">txt_i</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">clr_i</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">box_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">x1</span><span class="p">,</span><span class="n">y1</span>   <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">box_params</span><span class="p">[</span><span class="s1">&#39;llcrnrlon&#39;</span><span class="p">],</span> <span class="n">box_params</span><span class="p">[</span><span class="s1">&#39;llcrnrlat&#39;</span><span class="p">])</span>
    <span class="n">x2</span><span class="p">,</span><span class="n">y2</span>   <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">box_params</span><span class="p">[</span><span class="s1">&#39;urcrnrlon&#39;</span><span class="p">],</span> <span class="n">box_params</span><span class="p">[</span><span class="s1">&#39;urcrnrlat&#39;</span><span class="p">])</span>
    <span class="n">box_x_s</span> <span class="o">=</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">x1</span><span class="p">]</span>
    <span class="n">box_y_s</span> <span class="o">=</span> <span class="p">[</span><span class="n">y1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">y1</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">box_x_s</span><span class="p">,</span> <span class="n">box_y_s</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">box_params</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">])</span>

  <span class="k">if</span> <span class="n">zoom_box</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">zb_plot_pts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">lat_a</span> <span class="o">=</span> <span class="n">zb_plot_pts</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span>
      <span class="n">lon_a</span> <span class="o">=</span> <span class="n">zb_plot_pts</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span>
      <span class="n">sty_a</span> <span class="o">=</span> <span class="n">zb_plot_pts</span><span class="p">[</span><span class="s1">&#39;style&#39;</span><span class="p">]</span>
      <span class="n">clr_a</span> <span class="o">=</span> <span class="n">zb_plot_pts</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">lat_i</span><span class="p">,</span> <span class="n">lon_i</span><span class="p">,</span> <span class="n">sty_i</span><span class="p">,</span> <span class="n">clr_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lat_a</span><span class="p">,</span> <span class="n">lon_a</span><span class="p">,</span> <span class="n">sty_a</span><span class="p">,</span> <span class="n">clr_a</span><span class="p">):</span>
        <span class="n">x_i</span><span class="p">,</span> <span class="n">y_i</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">lon_i</span><span class="p">,</span> <span class="n">lat_i</span><span class="p">)</span>
        <span class="n">axins</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_i</span><span class="p">,</span> <span class="n">y_i</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">clr_i</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">sty_i</span><span class="p">)</span>
  
  <span class="c1"># plot triangles :</span>
  <span class="k">if</span> <span class="n">tp</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">triplot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">tpAlpha</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">zoom_box</span> <span class="ow">and</span> <span class="n">plot_grid</span><span class="p">:</span>
    <span class="n">tpaxins</span> <span class="o">=</span> <span class="n">axins</span><span class="o">.</span><span class="n">triplot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">tpAlpha</span><span class="p">)</span>

  <span class="c1"># include colorbar :</span>
  <span class="k">if</span> <span class="n">cb</span> <span class="ow">and</span> <span class="n">scale</span> <span class="o">!=</span> <span class="s1">&#39;bool&#39;</span><span class="p">:</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="c1">#plt.gca())</span>
    <span class="n">cax</span>  <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="s2">&quot;3%&quot;</span><span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="c1">#format=formatter, </span>
                        <span class="n">ticks</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">cb_format</span><span class="p">)</span> 
    <span class="c1">#cbar = plt.colorbar(cs, cax=cax, format=formatter, </span>
    <span class="c1">#                    ticks=np.around(levels,decimals=1)) </span>
  
  <span class="c1"># title :</span>
  <span class="n">tit</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
  <span class="c1">#tit.set_fontsize(40)</span>
  
  <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">03</span><span class="p">,</span><span class="o">.</span><span class="mi">03</span><span class="p">,</span><span class="mf">0.97</span><span class="p">,</span><span class="mf">0.97</span><span class="p">])</span>
  <span class="n">d</span>     <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">direc</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">direc</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">m</span></div>



<span class="k">def</span> <span class="nf">plot_l_curve</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">control</span><span class="p">):</span>
  <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  This function will generate a plot of the data collected by executing the </span>
<span class="sd">  :func:`~model.Model.L_curve` function.</span>
<span class="sd">  </span>
<span class="sd">  :param out_dir: Directory of data; must be the same as that used to initialize</span>
<span class="sd">                  the :class:`~model.Model` instance.</span>
<span class="sd">  :param control: The name of the control variable.</span>
<span class="sd">  :type out_dir:  string</span>
<span class="sd">  :type control:  string</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># save the resulting functional values and alphas to CSF : </span>
  <span class="k">if</span> <span class="n">MPI</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">mpi_comm_world</span><span class="p">())</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>

    <span class="c1"># iterate through the directiories we just created and grab the data :</span>
    <span class="n">alphas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">J_logs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">J_l2s</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">J_rats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">J_abss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">R_tvs</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">R_tiks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">R_sqs</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">R_abss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ns</span>     <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">out_dir</span><span class="p">))[</span><span class="mi">1</span><span class="p">]:</span>
      <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(alpha_)(\d\W\dE\W\d+)&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">do</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;/objective_ftnls_history/&#39;</span>
        <span class="n">alphas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">J_logs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">do</span>  <span class="o">+</span> <span class="s1">&#39;J_log.txt&#39;</span><span class="p">))</span>
        <span class="n">J_l2s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">do</span>  <span class="o">+</span> <span class="s1">&#39;J_l2.txt&#39;</span><span class="p">))</span>
        <span class="n">J_rats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">do</span>  <span class="o">+</span> <span class="s1">&#39;J_rat.txt&#39;</span><span class="p">))</span>
        <span class="n">J_abss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">do</span>  <span class="o">+</span> <span class="s1">&#39;J_abs.txt&#39;</span><span class="p">))</span>
        <span class="n">R_tvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">do</span>  <span class="o">+</span> <span class="s1">&#39;R_tv_</span><span class="si">%s</span><span class="s1">.txt&#39;</span>  <span class="o">%</span> <span class="n">control</span><span class="p">))</span>
        <span class="n">R_tiks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">do</span>  <span class="o">+</span> <span class="s1">&#39;R_tik_</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="n">control</span><span class="p">))</span>
        <span class="n">R_sqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">do</span>  <span class="o">+</span> <span class="s1">&#39;R_sq_</span><span class="si">%s</span><span class="s1">.txt&#39;</span>  <span class="o">%</span> <span class="n">control</span><span class="p">))</span>
        <span class="n">R_abss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">do</span>  <span class="o">+</span> <span class="s1">&#39;R_abs_</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="n">control</span><span class="p">))</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J_logs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">alphas</span><span class="p">)</span> 
    <span class="n">J_logs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">J_logs</span><span class="p">)</span>
    <span class="n">J_l2s</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">J_l2s</span><span class="p">)</span>
    <span class="n">J_rats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">J_rats</span><span class="p">)</span>
    <span class="n">J_abss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">J_abss</span><span class="p">)</span>
    <span class="n">R_tvs</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_tvs</span><span class="p">)</span>
    <span class="n">R_tiks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_tiks</span><span class="p">)</span>
    <span class="n">R_sqs</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_sqs</span><span class="p">)</span>
    <span class="n">R_abss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_abss</span><span class="p">)</span>
    <span class="n">ns</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>

    <span class="c1"># sort everything :</span>
    <span class="n">idx</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">alphas</span><span class="p">)</span>
    <span class="n">alphas</span> <span class="o">=</span> <span class="n">alphas</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">J_logs</span> <span class="o">=</span> <span class="n">J_logs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> 
    <span class="n">J_l2s</span>  <span class="o">=</span> <span class="n">J_l2s</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">J_rats</span> <span class="o">=</span> <span class="n">J_rats</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">J_abss</span> <span class="o">=</span> <span class="n">J_abss</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">R_tvs</span>  <span class="o">=</span> <span class="n">R_tvs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">R_tiks</span> <span class="o">=</span> <span class="n">R_tiks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">R_sqs</span>  <span class="o">=</span> <span class="n">R_sqs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">R_abss</span> <span class="o">=</span> <span class="n">R_abss</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">ns</span>     <span class="o">=</span> <span class="n">ns</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
   
    <span class="c1"># plot the functionals : </span>
    <span class="c1">#=========================================================================</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mf">2.5</span><span class="p">))</span>
    <span class="n">ax</span>  <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

    <span class="c1"># we want to plot the different alpha values a different shade :</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span> <span class="n">cmap</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="p">]</span>
  
    <span class="c1"># the subscripts of file names :</span>
    <span class="n">subs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">,</span>  <span class="s1">&#39;rat&#39;</span><span class="p">,</span> <span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="s1">&#39;tv&#39;</span><span class="p">,</span>  <span class="s1">&#39;tik&#39;</span><span class="p">,</span> <span class="s1">&#39;sq&#39;</span><span class="p">,</span>  <span class="s1">&#39;abs&#39;</span><span class="p">]</span>
  
    <span class="c1"># the functional type</span>
    <span class="n">ftnl_t</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">]</span>

    <span class="c1"># collect the functionals :</span>
    <span class="n">ftnl_a</span> <span class="o">=</span> <span class="p">[</span><span class="n">J_logs</span><span class="p">,</span> <span class="n">J_l2s</span><span class="p">,</span>  <span class="n">J_rats</span><span class="p">,</span> <span class="n">J_abss</span><span class="p">,</span> <span class="n">R_tvs</span><span class="p">,</span>  <span class="n">R_tiks</span><span class="p">,</span> <span class="n">R_sqs</span><span class="p">,</span>  <span class="n">R_abss</span><span class="p">]</span>
    
    <span class="n">k</span>    <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># counter so we can plot side-by-side</span>
    <span class="n">ints</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># to modify the x-axis labels</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alphas</span><span class="p">)):</span>
      
      <span class="c1"># create the x-interval to plot :</span>
      <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="n">ns</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
      <span class="n">ints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xi</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

      <span class="c1"># if this is the first iteration, we put a legend on it :</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ft</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ftnl_a</span><span class="p">,</span> <span class="n">ftnl_t</span><span class="p">,</span> <span class="n">subs</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
          <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">ft</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>  <span class="s1">&#39;-&#39;</span><span class="p">,</span>  <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>  <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                  <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\mathscr{</span><span class="si">%s</span><span class="s1">}_{\mathrm{</span><span class="si">%s</span><span class="s1">}}$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">sub</span><span class="p">))</span>

      <span class="c1"># otherwise, we don&#39;t need cluttered legends :</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ft</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ftnl_a</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
          <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">ft</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>  <span class="s1">&#39;-&#39;</span><span class="p">,</span>  <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>  <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,)</span>

      <span class="n">k</span> <span class="o">+=</span> <span class="n">ns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">ints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ints</span><span class="p">)</span>
    
    <span class="n">label</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">alphas</span><span class="p">:</span>
      <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\gamma = </span><span class="si">%g</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

    <span class="c1"># reset the x-label to be meaningfull :</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ints</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=-</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;relative iteration&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">ints</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    
    <span class="c1"># plot the functional legend across the top in a row : </span>
    <span class="c1">#leg = ax.legend(loc=&#39;upper center&#39;, ncol=4)</span>
    <span class="c1">#leg = ax.legend(loc=&#39;center right&#39;)</span>
    <span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.2</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center right&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">leg</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">leg</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_dir</span> <span class="o">+</span> <span class="s1">&#39;convergence.pdf&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="c1"># plot L-curve :</span>
    <span class="c1">#=========================================================================</span>
    
    <span class="n">colors</span>    <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">alphas</span><span class="p">))]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax_a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">J_lbl</span>     <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\mathscr</span><span class="si">{J}</span><span class="s1">_{\mathrm{</span><span class="si">%s</span><span class="s1">}}$&#39;</span>
    <span class="n">R_lbl</span>     <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\mathscr</span><span class="si">{R}</span><span class="s1">_{\mathrm{</span><span class="si">%s</span><span class="s1">}}$&#39;</span>

    <span class="c1"># get the last element of each array (needed, as it might be jagged) :</span>
    <span class="n">J</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ftnl_a</span><span class="p">:</span>
      <span class="n">J_i</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">J_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">J</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">J_i</span><span class="p">)</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>

    <span class="c1"># for each cost functional i :</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
      <span class="n">J_i</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="c1"># and for each regularization functional j :</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">R_j</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="n">j</span><span class="p">]</span>
        <span class="n">ax_a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">J_i</span><span class="p">,</span> <span class="n">R_j</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="c1"># and for each regularization parameter k :</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alphas</span><span class="p">)):</span>
          <span class="n">ax_a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">J_i</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">R_j</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                         <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\gamma = </span><span class="si">%g</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="n">alphas</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="c1">#ax_a[i,j].grid()</span>
        <span class="n">ax_a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax_a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        
        <span class="c1"># format the labels for less clutter :</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
          <span class="n">ax_a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">J_lbl</span> <span class="o">%</span> <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
        <span class="k">else</span><span class="p">:</span>
          <span class="n">ax_a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">NullFormatter</span><span class="p">())</span>
          <span class="n">ax_a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_formatter</span><span class="p">(</span><span class="n">NullFormatter</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">ax_a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">R_lbl</span> <span class="o">%</span> <span class="n">subs</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="n">j</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">ax_a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">NullFormatter</span><span class="p">())</span>
          <span class="n">ax_a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_formatter</span><span class="p">(</span><span class="n">NullFormatter</span><span class="p">())</span>

        <span class="c1"># set the legend for only one plot :</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">leg</span> <span class="o">=</span> <span class="n">ax_a</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
          <span class="n">leg</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_dir</span> <span class="o">+</span> <span class="s1">&#39;l_curve.pdf&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ftnl_a</span>



<span class="c1"># VERTICAL BASIS REPLACES A NORMAL FUNCTION, SUCH THAT VERTICAL DERIVATIVES</span>
<span class="c1"># CAN BE EVALUATED IN MUCH THE SAME WAY AS HORIZONTAL DERIVATIVES.  IT NEEDS</span>
<span class="c1"># TO BE SUPPLIED A LIST OF FUNCTIONS OF SIGMA THAT MULTIPLY EACH COEFFICIENT.</span>
<span class="k">class</span> <span class="nc">VerticalBasis</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">  Original author: Doug Brinkerhoff: https://dbrinkerhoff.org/</span>
<span class="sd">  &quot;&quot;&quot;</span> 
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">dcoef</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">u</span>     <span class="o">=</span> <span class="n">u</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">coef</span>  <span class="o">=</span> <span class="n">coef</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dcoef</span> <span class="o">=</span> <span class="n">dcoef</span>

  <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">u</span><span class="o">*</span><span class="n">c</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef</span><span class="p">)])</span>

  <span class="k">def</span> <span class="nf">ds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">u</span><span class="o">*</span><span class="n">c</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcoef</span><span class="p">)])</span>

  <span class="k">def</span> <span class="nf">dx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">u</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">c</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef</span><span class="p">)])</span>




<span class="c1"># SIMILAR TO ABOVE, BUT FOR CALCULATION OF FINITE DIFFERENCE QUANTITIES.</span>
<span class="k">class</span> <span class="nc">VerticalFDBasis</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">  Original author: Doug Brinkerhoff: https://dbrinkerhoff.org/</span>
<span class="sd">  &quot;&quot;&quot;</span> 
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">,</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">u</span>      <span class="o">=</span> <span class="n">u</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">deltax</span> <span class="o">=</span> <span class="n">deltax</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">coef</span>   <span class="o">=</span> <span class="n">coef</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="n">sigmas</span>

  <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
    <span class="n">fl</span>   <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="p">[</span><span class="n">fl</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">fl</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">dist</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltax</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">fl</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dist</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltax</span>

  <span class="k">def</span> <span class="nf">ds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltax</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">d2s</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltax</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">dx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>        




<span class="c1"># PERFORMS GAUSSIAN QUADRATURE FOR ARBITRARY FUNCTION OF SIGMA, </span>
<span class="c1"># QUAD POINTS, AND WEIGHTS</span>
<span class="k">class</span> <span class="nc">VerticalIntegrator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
      <span class="n">points</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span>       <span class="mf">0.4688</span><span class="p">,</span> <span class="mf">0.8302</span><span class="p">,</span> <span class="mf">1.0</span>   <span class="p">])</span>
      <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.4876</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">0.4317</span><span class="p">,</span> <span class="mf">0.2768</span><span class="p">,</span> <span class="mf">0.0476</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
      <span class="n">points</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span>     <span class="mf">0.89976</span><span class="p">,</span>   <span class="mf">0.677186</span><span class="p">,</span> <span class="mf">0.36312</span><span class="p">,</span>   <span class="mf">0.0</span>        <span class="p">])</span>
      <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.02778</span><span class="p">,</span> <span class="mf">0.1654595</span><span class="p">,</span> <span class="mf">0.274539</span><span class="p">,</span> <span class="mf">0.3464285</span><span class="p">,</span> <span class="mf">0.371519</span><span class="o">/</span><span class="mf">2.</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
      <span class="n">points</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span>         <span class="mf">0.934001</span><span class="p">,</span> <span class="mf">0.784483</span><span class="p">,</span> 
                          <span class="mf">0.565235</span><span class="p">,</span>  <span class="mf">0.295758</span><span class="p">,</span> <span class="mi">0</span>          <span class="p">])</span>
      <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0181818</span><span class="p">,</span> <span class="mf">0.10961</span><span class="p">,</span>  <span class="mf">0.18717</span><span class="p">,</span>  
                          <span class="mf">0.248048</span><span class="p">,</span>  <span class="mf">0.28688</span><span class="p">,</span>  <span class="mf">0.300218</span><span class="o">/</span><span class="mf">2.</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">points</span>  <span class="o">=</span> <span class="n">points</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>
  <span class="k">def</span> <span class="nf">integral_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">w</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">intz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">integral_term</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> 
                <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)])</span>





</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Evan M. Cummings.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>